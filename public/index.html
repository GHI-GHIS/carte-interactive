<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des √âtablissements Vicat</title>
    
    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    
    <!-- Mapbox Plugins -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js"></script>
    
    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    
    <!-- Vicat Map Styles -->
    <link rel="stylesheet" href="css/vicat-map.css">
</head>
<body>
    <div id="loading-overlay">Chargement de la carte...</div>
    
    <div id="map-container">
        <div id="sidebar">
            <!-- Mode Normal Interface -->
            <div id="normal-mode-interface" class="mode-interface">
                <div class="filter-section">
                    <h2>Rechercher une ville ou UP</h2>
                    <div class="search-and-reset-container">
                        <div id="normal-geocoder-container" class="search-container">
                            <button id="normal-geolocate" class="geolocate-btn" title="Utiliser ma position">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                                </svg>
                            </button>
                        </div>
                        <button id="reset-map-inline" class="reset-map-inline">R√©initialiser</button>
                    </div>
                </div>
            </div>
            
            <!-- Mode Route Interface -->
            <div id="route-mode-interface" class="mode-interface" style="display:none;">
                <div class="filter-section">
                    <h2>Calculer un itin√©raire</h2>
                    <button id="reset-map-route" class="reset-map-inline" style="margin-top: 0px; width: 100%;">R√©initialiser la carte</button>
                    
                    <!-- Interface d'itin√©raire avec Points A et B -->
                    <div id="route-interface-container">
                        <!-- Point A (origine) -->
                        <div class="route-point-section" id="point-a-section" style="position: relative;">
                            <button id="add-destination-btn" class="add-point-btn" title="Ajouter une destination" style="position: absolute; top: 8px; right: 8px; z-index: 1; width: 24px; height: 24px; font-size: 14px; padding: 0;">+</button>
                            <div class="route-input-group">
                                <label>Point A (origine):</label>
                                <div id="selected-point-a" style="display:none; padding: 8px 40px 8px 8px; background: #e3f2fd; border-radius: 4px; margin-bottom: 8px; font-size: 14px; color: #1976d2; position: relative;">
                                    <strong>[Point A] </strong><span id="point-a-name"></span>
                                    <button id="clear-point-a" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; background: rgba(211, 47, 47, 0.1); color: #d32f2f; border: 1px solid rgba(211, 47, 47, 0.3); width: 20px; height: 20px; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" title="D√©s√©lectionner">√ó</button>
                                </div>
                                <div class="point-input-container">
                                    <div id="geocoder-container">
                                        <button id="geolocate" class="geolocate-btn" title="Utiliser ma position">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Point B (destination) -->
                        <div id="point-b-section" class="route-point-section" style="display:none; margin-top:10px;">
                            <div class="route-input-group">
                                <label>Point B (destination):</label>
                                <div id="selected-point-b" style="display:none; padding: 8px 40px 8px 8px; background: #fff3cd; border-radius: 4px; margin-bottom: 8px; font-size: 14px; color: #856404; position: relative;">
                                    <strong>[Point B] </strong><span id="point-b-name"></span>
                                    <button id="clear-point-b" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; background: rgba(211, 47, 47, 0.1); color: #d32f2f; border: 1px solid rgba(211, 47, 47, 0.3); width: 20px; height: 20px; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" title="D√©s√©lectionner">√ó</button>
                                </div>
                                <div class="point-input-container">
                                    <div id="geocoder-container-b"></div>
                                </div>
                            </div>
                            <div class="route-actions">
                                <button id="clear-route-btn" class="route-action-btn secondary">Effacer</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Common Elements -->
            <div class="filter-section" id="reset-section" style="display:none;">
                <button id="reset-map">R√©initialiser la carte</button>
            </div>
            <div id="results-count"></div>
            <div id="establishments-view"></div>
            
            <!-- Panneau d√©taill√© des instructions de navigation -->
            <div id="route-details-panel" style="display:none; flex-grow:1; overflow-y:auto; margin-top:5px;">
                <!-- Options de routage -->
                <div id="route-options-container" style="display:none; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#f8f9fa;">
                    <!-- Switcher V√©hicule -->
                    <div style="display:flex; align-items:center; margin-bottom:8px;">
                        <span style="font-size:11px; font-weight:600; color:#333; margin-right:10px; min-width:50px;">V√©hicule:</span>
                        <div id="vehicle-switcher" style="display:flex; background:#e9ecef; border-radius:20px; padding:2px; cursor:pointer; border:1px solid #ced4da; transition:all 0.3s;">
                            <div id="vehicle-car" class="switcher-option active" style="padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600; background:#002060; color:white; transition:all 0.3s;">üöó Voiture</div>
                            <div id="vehicle-truck" class="switcher-option" style="padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600; color:#666; transition:all 0.3s;">üöõ Camion</div>
                        </div>
                    </div>
                    <!-- Switcher √âviter p√©ages -->
                    <div style="display:flex; align-items:center;">
                        <span style="font-size:11px; font-weight:600; color:#333; margin-right:10px; min-width:50px;">P√©ages:</span>
                        <div id="tolls-switcher" style="display:flex; background:#e9ecef; border-radius:20px; padding:2px; cursor:pointer; border:1px solid #ced4da; transition:all 0.3s;">
                            <div id="tolls-yes" class="switcher-option active" style="padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600; background:#002060; color:white; transition:all 0.3s;">Autoriser</div>
                            <div id="tolls-no" class="switcher-option" style="padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600; color:#666; transition:all 0.3s;">√âviter</div>
                        </div>
                    </div>
                </div>
                
                <!-- R√©sum√© de l'itin√©raire -->
                <div id="route-summary" style="display:none; padding:15px; background:linear-gradient(135deg, #002060 0%, #003380 100%); color:white; border-radius:8px; margin-bottom:10px;"></div>
                
                <!-- Instructions d√©taill√©es -->
                <div id="route-instructions" style="display:none; padding:10px; background:#f8f9fa; border-radius:8px;"></div>
            </div>
        </div>
        
        <div id="map">
            <!-- Mode Switcher sur la carte -->
            <div class="mode-switcher-container">
                <div class="mode-switcher">
                    <button id="mode-normal" class="mode-btn active" data-mode="normal">
                        <span class="mode-icon">üìç</span>
                        <span class="mode-label">Carte</span>
                    </button>
                    <button id="mode-route" class="mode-btn" data-mode="route">
                        <span class="mode-icon">üöó</span>
                        <span class="mode-label">Itin√©raire</span>
                    </button>
                </div>
            </div>
            
            <!-- L√©gende de la carte -->
            <div class="map-legend" id="map-legend" style="display:block;">
                <h4>Filtres</h4>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-marker beton"></div>
                        <span>B√©ton</span>
                        <span class="distance-badge" id="beton-count">0</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker granulats"></div>
                        <span>Granulats</span>
                        <span class="distance-badge" id="granulats-count">0</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker ciment"></div>
                        <span>Ciment</span>
                        <span class="distance-badge" id="ciment-count">0</span>
                    </div>
                    <div class="legend-item" id="ciment-prompt-legend" style="display:none;">
                        <div class="legend-marker ciment-prompt"></div>
                        <span>Ciment Prompt</span>
                        <span class="distance-badge" id="ciment-prompt-count">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contr√¥les de zoom -->
    <div class="custom-zoom-controls">
        <button class="zoom-btn" id="zoom-in-btn" title="Zoomer" aria-label="Zoomer">+</button>
        <button class="zoom-btn" id="zoom-out-btn" title="D√©zoomer" aria-label="D√©zoomer">-</button>
    </div>
    
    <!-- Bouton mobile -->
    <button class="mobile-toggle-btn" id="mobile-toggle" aria-label="Basculer vue">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path id="mobile-toggle-icon" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
        </svg>
    </button>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button">√ó</span>
            <div id="modal-info"></div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/establishments-data.js"></script>
    <script src="js/vicat-map.js"></script>
</body>
</html>
