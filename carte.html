<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte des √âtablissements</title>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.css' />
  <link href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js'></script>
  
<style>
body,html{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;overflow:hidden}
/* Style pour les UP dans l'autocompl\u00e9tion */
.mapboxgl-ctrl-geocoder--suggestion.is-up{background:linear-gradient(to right,#f0f7ff 0%,#ffffff 100%)!important;border-left:3px solid #002060!important}
.mapboxgl-ctrl-geocoder--suggestion.is-up .mapboxgl-ctrl-geocoder--suggestion-title{color:#002060!important;font-weight:600}#map-container{display:flex;height:85vh;width:100vw;overflow:hidden;position:relative;transition:height .3s ease-in-out}#sidebar{width:30%;min-width:415px;max-width:450px;background-color:#fff;padding:20px;box-sizing:border-box;display:flex;flex-direction:column;height:100%;transition:width .5s ease-in-out,opacity .5s ease-in-out,transform .5s ease-in-out,min-width .5s ease-in-out;overflow-x:hidden;z-index:20}#map{width:70%;height:100%;transition:width .5s ease-in-out,opacity .5s ease-in-out;opacity:1;z-index:10}.filter-section{margin-bottom:20px}.filter-section h2{margin-bottom:10px;font-size:18px;color:#333}#geocoder-container{display:flex;align-items:center;gap:5px}.geolocate-btn{background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23333" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>') center/18px no-repeat;width:34px;height:34px;border:1px solid #ccc;border-radius:4px;cursor:pointer;background-color:#fff;flex-shrink:0}.mapboxgl-ctrl-geocoder{margin-left:0!important;min-width:0;flex-grow:1}.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon{display:none!important}#results-count{font-size:14px;color:#555;margin-top:15px;font-weight:bold}#establishments-view{flex-grow:1;overflow-y:auto;margin-top:5px}/* Nouvelle version compacte et moderne des cards */
.establishment-card{background:#fff;margin:6px 8px;padding:10px 12px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);cursor:pointer;transition:all .2s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;position:relative;border-left:3px solid #e0e0e0;border:1px solid #f0f0f0}
.establishment-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.12),0 2px 4px rgba(0,0,0,.08);border-left:3px solid #002060;transform:translateY(-2px);background:#fafbfc}
.establishment-card:active{transform:translateY(0px);box-shadow:0 1px 3px rgba(0,0,0,.08)}

/* Header de la card avec nom et badges */
.card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px}
.establishment-card h3{font-size:14px;font-weight:600;color:#002060;margin:0;line-height:1.3;flex:1}

/* Badges compacts */
.card-badges{display:flex;gap:4px;margin-left:8px;flex-shrink:0}
.distance-badge,.time-badge{padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600;white-space:nowrap}
.distance-badge{background:#e3f2fd;color:#1565c0}
.time-badge{background:#e8f5e9;color:#2e7d32}

/* Adresse */
.card-address{font-size:12px;color:#666;margin-bottom:8px;line-height:1.3}

/* Actions compactes avec ic√¥nes */
.card-actions-compact{display:flex;gap:4px;border-top:1px solid #f0f0f0;padding-top:8px;margin-top:8px}
.card-action-icon{flex:1;display:flex;align-items:center;justify-content:center;padding:6px;border-radius:4px;background:#f8f9fa;transition:all .15s;cursor:pointer;border:none;min-height:32px}
.card-action-icon:hover{background:#002060;color:white}
.card-action-icon svg{width:16px;height:16px;fill:currentColor}
.card-action-icon.phone:hover{background:#28a745}
.card-action-icon.route:hover{background:#17a2b8}
.card-action-icon.info:hover{background:#ff9900}
.card-action-icon.view3d:hover{background:#6f42c1}
.card-action-icon.view3d.active{background:#28a745;color:white}

/* Couleurs par type d'activit√© */
.establishment-card[data-activity="beton"]{border-left-color:#ff9900}
.establishment-card[data-activity="granulat"]{border-left-color:#4682B4}
.establishment-card[data-activity="ciment"]{border-left-color:#228B22}
.establishment-card[data-activity="ciment-prompt"]{border-left-color:#8B4513}
.establishment-card[data-activity="autre"]{border-left-color:#6c757d}

/* √âtat actif/focus pour accessibilit√© */
.establishment-card:focus-visible{outline:2px solid #002060;outline-offset:2px}
.card-action-icon:focus-visible{outline:2px solid #002060;outline-offset:-2px}#reset-map{width:100%;padding:10px;background-color:#555;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:16px;transition:background-color .3s}#reset-map:hover{background-color:#333}#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);z-index:9999;display:flex;justify-content:center;align-items:center;font-size:20px;color:#333;transition:opacity .5s}.mapboxgl-popup-content{width:max-content;font-family:Arial,sans-serif;padding:15px!important;max-width:280px!important}.mapboxgl-popup-content h3{color:#002060;margin:0 0 10px 0;font-size:16px}.mapboxgl-popup-content p{margin:0 0 5px 0;line-height:1.4;font-size:14px}.mapboxgl-popup-content p strong{color:#333;font-weight:bold}.mapboxgl-popup-content .popup-actions{display:flex;gap:10px;margin-top:10px;padding-top:10px;border-top:1px solid #eee}.mapboxgl-popup-content .popup-view-btn{flex:1;padding:5px 10px;background-color:#17a2b8;color:#fff;border:none;border-radius:4px;cursor:pointer;text-align:center;font-size:12px;transition:background-color .2s}.mapboxgl-popup-content .popup-view-btn:hover{background-color:#138496}#map>div.mapboxgl-control-container>div.mapboxgl-ctrl-bottom-right,#map>div.mapboxgl-control-container>div.mapboxgl-ctrl-bottom-left{display:none}/* Modal moderne */
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6);backdrop-filter:blur(4px);animation:fadeIn 0.3s ease}

.modal-content{background:#fff;margin:5% auto;padding:0;border:none;width:90%;max-width:500px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:slideUp 0.3s ease;overflow:hidden}

/* Header de la modal */
.modal-header{background:linear-gradient(135deg,#002060 0%,#003380 100%);color:white;padding:20px 24px;position:relative}

.modal-header h3{margin:0;font-size:20px;font-weight:600;padding-right:30px}

.close-button{position:absolute;right:20px;top:50%;transform:translateY(-50%);color:white;font-size:24px;font-weight:300;cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s;background:rgba(255,255,255,0.1)}

.close-button:hover{background:rgba(255,255,255,0.2);transform:translateY(-50%) rotate(90deg)}

/* Body de la modal */
.modal-body{padding:24px}

.modal-info-row{display:flex;padding:12px 0;border-bottom:1px solid #f0f0f0}

.modal-info-row:last-child{border-bottom:none}

.modal-info-label{font-weight:600;color:#666;min-width:100px;font-size:14px}

.modal-info-value{flex:1;color:#333;font-size:14px;line-height:1.4}

.modal-info-value a{color:#002060;text-decoration:none;transition:color 0.2s}

.modal-info-value a:hover{color:#17a2b8;text-decoration:underline}

/* Badge pour l'activit√© */
.activity-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;background:#e3f2fd;color:#1565c0}

/* Footer de la modal avec actions */
.modal-footer{padding:16px 24px;background:#f8f9fa;border-top:1px solid #e0e0e0;display:flex;gap:12px}

.modal-action-btn{flex:1;padding:10px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px}

.modal-action-btn.primary{background:#002060;color:white}

.modal-action-btn.primary:hover{background:#003380;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,32,96,0.3)}

.modal-action-btn.secondary{background:#e0e0e0;color:#333}

.modal-action-btn.secondary:hover{background:#d0d0d0}

/* Animations */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
@keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes slideDown{from{transform:translateY(0);opacity:1}to{transform:translateY(50px);opacity:0}}

/* Responsive */
@media (max-width:600px){
    .modal-content{width:95%;margin:10% auto}
    .modal-info-row{flex-direction:column;gap:4px}
    .modal-info-label{min-width:unset}
}.view-switcher{position:fixed;top:83px;right:28px;z-index:1005;padding:10px 15px;background-color:#002060;color:#fff;border:0;border-radius:5px;cursor:pointer;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,.2);display:none;transition:background-color .3s}.view-switcher:hover{background-color:#003380}#map-container.layout-dual #sidebar{width:30%;min-width:415px;opacity:1;transform:translateX(0)}#map-container.layout-dual #map{width:calc(100% - max(30%,415px));opacity:1}#map-container.layout-sidebar-full{height:100vh}#map-container.layout-sidebar-full #sidebar{width:94%;min-width:94%;opacity:1;transform:translateX(0)}#map-container.layout-sidebar-full #map{width:0;opacity:0;pointer-events:none}#map-container.layout-map-full{height:100vh}#map-container.layout-map-full #sidebar{width:0;min-width:0;opacity:0;transform:translateX(-100%);pointer-events:none}#map-container.layout-map-full #map{width:100%;opacity:1}@media (max-width:1383px){#map-container.layout-dual #sidebar{width:415px}#map-container.layout-dual #map{width:calc(100% - 415px)}}@media (max-width:600px){#map-container.layout-sidebar-full #sidebar{width:100%;min-width:88%}}.card-actions{display:flex;gap:10px;margin-top:10px;padding-bottom:5px}.action-btn{flex:1;padding:8px 5px;border-radius:4px;color:#fff!important;text-align:center;text-decoration:none;font-size:14px;transition:transform .2s,background-color .2s}.action-btn:hover{transform:scale(1.05);text-decoration:none}.action-btn.call{background-color:#28a745}.action-btn.call:hover{background-color:#218838}.action-btn.mail{background-color:#007bff}.action-btn.mail:hover{background-color:#0069d9}.action-btn.route{background-color:#17a2b8}.action-btn.route:hover{background-color:#138496}.action-btn:disabled{background-color:#6c757d!important;cursor:not-allowed;transform:none}.action-btn:disabled:hover{transform:none}
/* Mode Switcher Styles */
/* Mode Switcher sur la carte */
.mode-switcher-container {
    position: absolute;
    top: 20px;
    left: 10px;
    z-index: 100;
    background: #fff;
    border-radius: 22px;
    padding: 3px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.mode-switcher {
    display: flex;
    background: transparent;
    border-radius: 20px;
    padding: 0;
}

.mode-btn {
    padding: 8px 16px;
    background: transparent;
    border: none;
    border-radius: 18px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    white-space: nowrap;
    min-width: 90px;
}

.mode-btn:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #333;
}

.mode-btn.active {
    background: #002060;
    color: white;
    box-shadow: 0 1px 3px rgba(0,32,96,0.3);
    font-weight: 600;
}

.mode-btn.active:hover {
    background: #003380;
}

.mode-btn .mode-icon {
    font-size: 14px;
}

.mode-btn .mode-label {
    font-size: 12px;
    letter-spacing: 0.3px;
}

/* Mode Interface Containers */
.mode-interface {
    transition: opacity 0.3s ease, transform 0.3s ease;
}

#normal-mode-interface .search-container {
    display: flex;
    align-items: center;
    gap: 5px;
}

#normal-geocoder-container {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* L√©gende de la carte */
.map-legend{position:absolute;bottom:30px;left:10px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:900;font-size:13px}.map-legend h4{margin:0 0 8px 0;font-size:14px;color:#333;font-weight:bold}.legend-item{display:flex;align-items:center;margin:6px 0;cursor:pointer;padding:4px;border-radius:4px;transition:background-color .2s}.legend-item:hover{background-color:#f0f8ff}.legend-item.inactive{opacity:.4}.legend-item.inactive:hover{opacity:.6}.legend-marker{width:30px;height:30px;margin-right:8px;background-size:contain;background-repeat:no-repeat;background-position:center}.legend-marker.beton{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-beton.png')}.legend-marker.granulats{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-granulats.png')}.legend-marker.ciment{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-ciment.png')}.legend-marker.ciment-prompt{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-12/ciment-prompt-naturel.png')}

/* Contr√¥le de rayon sur la carte */
.map-radius-control{position:absolute;bottom:120px;left:10px;background:#fff;padding:12px 15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:100;font-size:13px;display:none}.map-radius-control h4{margin:0 0 8px 0;font-size:14px;color:#333;font-weight:bold}.radius-control-map{display:flex;align-items:center;gap:10px}.radius-control-map label{font-size:13px;color:#333;white-space:nowrap}.radius-control-map input[type="range"]{flex:1;min-width:120px}.radius-control-map span{font-weight:bold;color:#002060;min-width:50px;font-size:13px}

/* Interface d'itin√©raire am√©lior√©e */
#route-interface-container{margin-top:15px}.route-point-section{border:1px solid #ddd;padding:15px;border-radius:6px;background:#f9f9f9;transition:all .3s ease-in-out}.route-input-group{margin-bottom:12px;display:flex;flex-direction:column;gap:5px}.route-input-group label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}.point-input-container{display:flex;align-items:center;gap:5px}.point-input-container #geocoder-container{flex:1;display:flex;align-items:center;gap:5px;min-width:0}.point-input-container #geocoder-container-b{flex:1;display:flex;align-items:center;gap:5px;min-width:0}.point-input-container input{flex:1;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:14px}.search-btn,.add-point-btn{background:#002060;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color .2s}.search-btn:hover,.add-point-btn:hover{background:#003380}.add-point-btn{width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;flex-shrink:0}.route-actions{display:flex;gap:10px;margin-top:15px}.route-action-btn{padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color .2s}.route-action-btn.primary{background:#28a745;color:white}.route-action-btn.primary:hover{background:#218838}.route-action-btn.secondary{background:#6c757d;color:white}.route-action-btn.secondary:hover{background:#545b62}#point-b-section{animation:slideDown .3s ease-in-out}@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}#clear-point-a:hover,#clear-point-b:hover{background:rgba(211,47,47,0.2)!important;border-color:rgba(211,47,47,0.5)!important;transform:translateY(-50%) scale(1.1)!important}


/* Animation d'apparition du panneau de routage */
#route-details-panel{animation:slideUpRoute .4s ease-out}@keyframes slideUpRoute{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* Styles pour les options de routage avec molette */
#route-options-container{transition:opacity 0.3s ease, transform 0.3s ease}
#toggle-route-options:hover{background:rgba(255,255,255,0.3)!important;transform:scale(1.1)!important}

/* Animation pour l'overlay d'infos d'itin√©raire */
@keyframes slideInFromRight{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}

/* √âtats d'affichage pour masquer/afficher les cartes */
.hide-establishments{display:none !important}.show-establishments{display:block !important}

/* Am√©lioration des options de routage */
.route-option-group label input[type="radio"]{accent-color:#002060}

/* Mode itin√©raire pleine largeur */
.route-mode-active #sidebar {
    width: 40% !important;
    min-width: 500px !important;
    max-width: 600px !important;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-right: 3px solid #002060;
}

.route-mode-active #map {
    width: 60% !important;
    border-left: 1px solid #dee2e6;
}

/* Am√©liorations visuelles du panneau d√©taill√© */
#route-details-panel.route-active {
    background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 12px;
    margin: 10px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 32, 96, 0.1);
}

/* Am√©lioration du r√©sum√© de l'itin√©raire */
#route-summary {
    background: linear-gradient(135deg, #002060 0%, #003380 100%) !important;
    box-shadow: 0 6px 20px rgba(0, 32, 96, 0.3);
    border-radius: 12px !important;
    position: relative;
    overflow: hidden;
}

#route-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
}

/* Styles pour les segments de route color√©s selon la vitesse */
.route-segment-fast { stroke: #28a745; stroke-width: 6; }
.route-segment-medium { stroke: #ffc107; stroke-width: 6; }
.route-segment-slow { stroke: #dc3545; stroke-width: 6; }
.route-segment-default { stroke: #007bff; stroke-width: 5; }

/* Animation de pulsation pour la route active */
.route-line-active {
    animation: routePulse 2s ease-in-out infinite alternate;
}

@keyframes routePulse {
    0% { stroke-width: 5; opacity: 0.8; }
    100% { stroke-width: 7; opacity: 1; }
}


/* Boutons am√©lior√©s */
.route-action-btn {
    position: relative;
    overflow: hidden;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
}

.route-action-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.route-action-btn:hover::before {
    width: 300px;
    height: 300px;
}

.route-action-btn.primary {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.route-action-btn.primary:hover {
    background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
}

/* Responsive am√©lior√© pour mobile */
@media (max-width: 768px) {
    .route-mode-active #sidebar {
        width: 100% !important;
        min-width: 100% !important;
    }
    
    .route-mode-active #map {
        width: 0 !important;
        opacity: 0;
    }
    
    .route-instruction-item {
        margin-bottom: 6px;
        padding: 10px 12px;
    }
}

/* Clustering */
.cluster-marker{background:#555;border:3px solid #fff;border-radius:50%;color:#fff;font-weight:bold;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:transform .2s}.cluster-marker:hover{transform:scale(1.1)}.cluster-small{width:35px;height:35px;background:#555}.cluster-medium{width:45px;height:45px;background:#333}.cluster-large{width:55px;height:55px;background:#222}


/* Indicateurs de distance */
.distance-badge{display:inline-block;background:#002060;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:bold;margin-left:8px}.time-badge{display:inline-block;background:#28a745;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:bold;margin-left:5px}

/* Contr√¥les de zoom personnalis√©s */
.custom-zoom-controls{position:fixed;bottom:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:2px}.zoom-btn{width:40px;height:40px;background:#fff;border:1px solid #ccc;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:#333;box-shadow:0 2px 4px rgba(0,0,0,.1);transition:all .2s}.zoom-btn:hover{background:#f8f8f8;box-shadow:0 3px 6px rgba(0,0,0,.15)}.zoom-btn:active{transform:scale(0.95);box-shadow:0 1px 2px rgba(0,0,0,.1)}

/* Accessibilit√© */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}*:focus-visible{outline:2px solid #002060;outline-offset:2px}button:focus-visible,a:focus-visible{outline:2px solid #002060;outline-offset:2px}

/* Mobile responsive am√©lior√© */
@media (max-width:768px){.map-legend{bottom:60px;left:5px;padding:8px;font-size:12px}.legend-item{margin:4px 0}.legend-marker{width:24px;height:24px;margin-right:6px}.mobile-toggle-btn{position:fixed;bottom:20px;right:20px;z-index:1007;background:#002060;color:#fff;border:none;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 10px rgba(0,0,0,.3);cursor:pointer;transition:all .3s}.mobile-toggle-btn:hover{transform:scale(1.1);background:#003380}.mobile-toggle-btn svg{width:24px;height:24px}}
</style>

</head>
<body>
  <div id="loading-overlay">Chargement de la carte...</div>

  <button id="view-switcher" class="view-switcher">Afficher Carte</button>


  <div id="map-container">
    <div id="sidebar">
      
      <!-- Contenu du sidebar sans le mode switcher -->

      <!-- Mode Normal Interface -->
      <div id="normal-mode-interface" class="mode-interface">
        <div class="filter-section">
          <h2>Rechercher une ville ou UP</h2>
          <div id="normal-geocoder-container" class="search-container">
            <button id="normal-geolocate" class="geolocate-btn" title="Utiliser ma position"></button>
          </div>
        </div>
      </div>

      <!-- Mode Route Interface -->
      <div id="route-mode-interface" class="mode-interface" style="display:none;">
        <div class="filter-section">
          <h2>Calculer un itin√©raire</h2>
          
          <!-- Interface d'itin√©raire avec Points A et B -->
        <div id="route-interface-container">
          <!-- Point A (origine) -->
          <div class="route-point-section" id="point-a-section" style="position: relative;">
            <button id="add-destination-btn" class="add-point-btn" title="Ajouter une destination" style="position: absolute; top: 8px; right: 8px; z-index: 10; width: 24px; height: 24px; font-size: 14px; padding: 0;">+</button>
            <div class="route-input-group">
              <label>Point A (origine):</label>
              <div id="selected-point-a" style="display:none; padding: 8px 40px 8px 8px; background: #e3f2fd; border-radius: 4px; margin-bottom: 8px; font-size: 14px; color: #1976d2; position: relative;">
                <strong>[Point A] </strong><span id="point-a-name"></span>
                <button id="clear-point-a" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; background: rgba(211, 47, 47, 0.1); color: #d32f2f; border: 1px solid rgba(211, 47, 47, 0.3); width: 20px; height: 20px; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" title="D√©s√©lectionner">√ó</button>
              </div>
              <div class="point-input-container">
                <div id="geocoder-container">
                  <button id="geolocate" class="geolocate-btn" title="Utiliser ma position"></button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Point B (destination) - masqu√© initialement -->
          <div id="point-b-section" class="route-point-section" style="display:none; margin-top:10px;">
            <div class="route-input-group">
              <label>Point B (destination):</label>
              <div id="selected-point-b" style="display:none; padding: 8px 40px 8px 8px; background: #fff3cd; border-radius: 4px; margin-bottom: 8px; font-size: 14px; color: #856404; position: relative;">
                <strong>[Point B] </strong><span id="point-b-name"></span>
                <button id="clear-point-b" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; background: rgba(211, 47, 47, 0.1); color: #d32f2f; border: 1px solid rgba(211, 47, 47, 0.3); width: 20px; height: 20px; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" title="D√©s√©lectionner">√ó</button>
              </div>
              <div class="point-input-container">
                <div id="geocoder-container-b"></div>
              </div>
            </div>

            <div class="route-actions">
              <button id="clear-route-btn" class="route-action-btn secondary">Effacer</button>
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- Common Elements for Both Modes -->
      <div class="filter-section">
        <button id="reset-map">R√©initialiser la carte</button>
      </div>
      
      <div id="results-count"></div>
      <div id="establishments-view"></div>
      
      <!-- Panneau d√©taill√© des instructions de navigation -->
      <div id="route-details-panel" style="display:none; flex-grow:1; overflow-y:auto; margin-top:5px;">
        <!-- Options de routage avec SWITCHERS -->
        <div id="route-options-container" style="display:none; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#f8f9fa;">
          <!-- Switcher V√©hicule -->
          <div style="display:flex; align-items:center; margin-bottom:8px;">
            <span style="font-size:11px; font-weight:600; color:#333; margin-right:10px; min-width:50px;">V√©hicule:</span>
            <div id="vehicle-switcher" style="
              display:flex; background:#e9ecef; border-radius:20px; padding:2px; cursor:pointer;
              border:1px solid #ced4da; transition:all 0.3s;
            ">
              <div id="vehicle-car" class="switcher-option active" style="
                padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600;
                background:#007bff; color:white; transition:all 0.3s; text-align:center;
              ">[CAR] Voiture</div>
              <div id="vehicle-truck" class="switcher-option" style="
                padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600;
                background:transparent; color:#6c757d; transition:all 0.3s; text-align:center;
              ">üöõ Camion</div>
            </div>
          </div>
          
          <!-- Switcher P√©ages -->
          <div style="display:flex; align-items:center;">
            <span style="font-size:11px; font-weight:600; color:#333; margin-right:10px; min-width:50px;">P√©ages:</span>
            <div id="toll-switcher" style="
              display:flex; background:#e9ecef; border-radius:20px; padding:2px; cursor:pointer;
              border:1px solid #ced4da; transition:all 0.3s;
            ">
              <div id="toll-allow" class="switcher-option active" style="
                padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600;
                background:#28a745; color:white; transition:all 0.3s; text-align:center;
              ">‚úÖ Avec</div>
              <div id="toll-avoid" class="switcher-option" style="
                padding:4px 12px; border-radius:18px; font-size:10px; font-weight:600;
                background:transparent; color:#6c757d; transition:all 0.3s; text-align:center;
              ">‚ùå Sans</div>
            </div>
          </div>
        </div>
        
        <!-- R√©sum√© de l'itin√©raire -->
        <div id="route-summary" style="background:#002060; color:white; padding:15px; border-radius:8px; margin-bottom:15px; position:relative;">
          <h3 style="margin:0 0 10px 0; font-size:16px; display:flex; justify-content:space-between; align-items:center;">
            üó∫Ô∏è R√©sum√© de l'itin√©raire
            <button id="toggle-route-options" style="
              background:rgba(255,255,255,0.2); 
              border:1px solid rgba(255,255,255,0.3); 
              color:white; 
              width:24px; 
              height:24px; 
              border-radius:50%; 
              cursor:pointer; 
              font-size:14px; 
              display:flex; 
              align-items:center; 
              justify-content:center;
              transition:all 0.2s;
              flex-shrink:0;
            " title="Options de routage">‚öôÔ∏è</button>
          </h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <span id="route-distance" style="font-weight:bold;">--</span>
            <span id="route-duration" style="font-weight:bold;">--</span>
          </div>
          <div id="route-vehicle-info" style="font-size:12px; opacity:0.8;">Type: Voiture ‚Ä¢ P√©ages: Autoris√©s</div>
        </div>
        
        
        <!-- Bouton retour -->
        <div style="margin-top:20px; padding:15px 0; border-top:1px solid #eee;">
          <button id="back-to-search-btn" class="route-action-btn secondary" style="width:100%;">
            ‚Üê Retour √† la recherche
          </button>
        </div>
      </div>
    </div>
    <div id="map">
      <!-- Mode Switcher sur la carte -->
      <div class="mode-switcher-container">
        <div class="mode-switcher">
          <button id="mode-normal" class="mode-btn active" data-mode="normal">
            <span class="mode-icon">üìç</span>
            <span class="mode-label">Carte</span>
          </button>
          <button id="mode-route" class="mode-btn" data-mode="route">
            <span class="mode-icon">üöó</span>
            <span class="mode-label">Itin√©raire</span>
          </button>
        </div>
      </div>
      
      <!-- L√©gende de la carte (overlay sur la carte) -->
      <div class="map-legend" id="map-legend" style="display:block;">
        <h4>Filtres</h4>
        <div class="legend-item">
          <div class="legend-marker beton"></div>
          <span>B√©ton</span>
          <span class="distance-badge" id="beton-count">0</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker granulats"></div>
          <span>Granulats</span>
          <span class="distance-badge" id="granulats-count">0</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker ciment"></div>
          <span>Ciment</span>
          <span class="distance-badge" id="ciment-count">0</span>
        </div>
        <div class="legend-item" id="ciment-prompt-legend" style="display:none;">
          <div class="legend-marker ciment-prompt"></div>
          <span>Ciment Prompt</span>
          <span class="distance-badge" id="ciment-prompt-count">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Contr√¥les de zoom personnalis√©s -->
  <div class="custom-zoom-controls">
    <button class="zoom-btn" id="zoom-in-btn" title="Zoomer" aria-label="Zoomer">+</button>
    <button class="zoom-btn" id="zoom-out-btn" title="D√©zoomer" aria-label="D√©zoomer">‚àí</button>
  </div>

  <!-- Bouton mobile pour basculer carte/liste -->
  <button class="mobile-toggle-btn" id="mobile-toggle" aria-label="Basculer vue" style="display:none;">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path id="mobile-toggle-icon" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
    </svg>
  </button>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-button">√ó</span>
      <div id="modal-info"></div>
    </div>
  </div>

<script>
    // Configuration
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ2hpc2xhaW5sZXZyYXQiLCJhIjoiY2x0ZTRlYTFpMGM4ZTJrcGI1OWFsNXRjcSJ9.63vk7d4NVv3i75ozPADUbw';

    // Variables globales
    let map;
    let currentView3DCoordinates = null; // Pour tracker l'UP actuellement en vue 3D
    let zoomingToCoordinates = null; // Pour tracker vers quelle UP on est en train de zoomer
    let geocoder;
    let directions;
    let currentSearchCenter = null;
    let currentSearchRadius = 80;
    let currentLayoutMode = 'dual';
    let primaryFilteredFeatures = [];
    let userLocationMarker = null; // Marker pour la g√©olocalisation
    let currentMapboxMarkers = [];
    let activePopups = [];
    let debounceTimer;
    let currentRouteSource = null;
    const VIEW_MODE_THRESHOLD = 700;
    
    // Nouvelles variables pour les am√©liorations
    let sortByDistance = true;
    
    // Filtrage par l√©gende interactive - Initialement aucun filtre actif (tout est affich√©)
    let activeFilters = new Set();
    
    // Variables pour l'itin√©raire
    let destinationCoords = null;
    let routeMode = false;
    let currentFocusedInput = 'A'; // Track which input (A or B) has focus
    let geocoderB = null; // Geocoder pour le Point B
    let realRouteData = null; // Stocker les donn√©es r√©elles de routage (distance et temps)
    let isRouteMode = false; // Tracker si on est en mode itin√©raire pour contr√¥ler l'affichage du rayon
    
    // Variables pour stocker les features des points s√©lectionn√©s
    let currentPointAFeature = null; // Feature compl√®te du Point A
    let currentPointBFeature = null; // Feature compl√®te du Point B
    
    // Fonction pour mapper les activit√©s vers les types de l√©gende
    function getActivityType(activity) {
        const activityLower = activity?.toLowerCase() || '';
        if (activityLower.includes('b√©ton') || activityLower.includes('beton')) return 'beton';
        if (activityLower.includes('granulat')) return 'granulats';
        // Tester "ciment prompt" en PREMIER pour √©viter le conflit avec "ciment"
        if (activityLower.includes('ciment prompt') || activityLower.includes('prompt')) return 'ciment-prompt';
        if (activityLower.includes('ciment')) return 'ciment';
        return 'ciment'; // Par d√©faut
    }
    
    // Fonction pour convertir les caract√®res accentu√©s en Unicode dans les donn√©es
    function convertToUnicodeEscapes(obj) {
        if (typeof obj === 'string') {
            // Remplacer tous les caract√®res accentu√©s par leurs codes Unicode
            return obj
                .replace(/√©/g, '\u00E9')
                .replace(/√â/g, '\u00C9')
                .replace(/√®/g, '\u00E8')
                .replace(/√à/g, '\u00C8')
                .replace(/√†/g, '\u00E0')
                .replace(/√Ä/g, '\u00C0')
                .replace(/√π/g, '\u00F9')
                .replace(/√ô/g, '\u00D9')
                .replace(/√¥/g, '\u00F4')
                .replace(/√î/g, '\u00D4')
                .replace(/√ß/g, '\u00E7')
                .replace(/√á/g, '\u00C7')
                .replace(/√¢/g, '\u00E2')
                .replace(/√Ç/g, '\u00C2')
                .replace(/√™/g, '\u00EA')
                .replace(/√ä/g, '\u00CA')
                .replace(/√Æ/g, '\u00EE')
                .replace(/√é/g, '\u00CE')
                .replace(/√ª/g, '\u00FB')
                .replace(/√õ/g, '\u00DB')
                .replace(/√Ø/g, '\u00EF')
                .replace(/√è/g, '\u00CF')
                .replace(/√´/g, '\u00EB')
                .replace(/√ã/g, '\u00CB')
                .replace(/√º/g, '\u00FC')
                .replace(/√ú/g, '\u00DC')
                .replace(/≈ì/g, '\u0153')
                .replace(/≈í/g, '\u0152')
                .replace(/√¶/g, '\u00E6')
                .replace(/√Ü/g, '\u00C6');
        } else if (Array.isArray(obj)) {
            return obj.map(item => convertToUnicodeEscapes(item));
        } else if (obj !== null && typeof obj === 'object') {
            const result = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    result[key] = convertToUnicodeEscapes(obj[key]);
                }
            }
            return result;
        }
        return obj;
    }

    // Donn√©es des √©tablissements (seront converties automatiquement)
    const establishmentsDataRaw = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Luxeuil", "Adresse": "4 Rue des Pr√©s", "Ville": "Saint-Sauveur", "Code postal": "70300", "Phone": "03 84 40 36 82", "Email": "beton.luxeuil@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.8278029, 47.7370072] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Amb√©rieu-en-Bugey", "Adresse": "980 route des carri√®res", "Ville": "Ambronay", "Code postal": "01500", "Phone": "04 74 36 99 14", "Email": "beton.amberieuenbugey@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.3469648361206055, 46.021080017089844] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - H√©rim√©nil", "Adresse": "La Cour D√©guillette", "Ville": "R√©hainviller", "Code postal": "54300", "Phone": "03 29 86 76 15", "Email": "beton.herimenil@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.477688312530518, 48.57072448730469] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Meximieux", "Adresse": "Route St Maurice de Gourdans", "Ville": "P√©rouges", "Code postal": "01800", "Phone": "04 74 46 08 41", "Email": "beton.meximieux@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.191800117492676, 45.89667510986328] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Beaune", "Adresse": "Rue du Docteur Barolet", "Ville": "Vignoles", "Code postal": "21200", "Phone": "03 85 38 01 10", "Email": "beton.beaune@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.8679518699646, 47.02422332763672] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Bourg-l√®s-Valence", "Adresse": "Lieu-dit l'Armailler", "Ville": "Chateauneuf-sur-Is√®re", "Code postal": "26300", "Phone": "04 75 83 47 53", "Email": "beton.bourglesvalence@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.889292, 44.978434] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Malataverne", "Adresse": "ZAC des Plaines", "Ville": "Malataverne", "Code postal": "26780", "Phone": "04 75 90 81 16", "Email": "beton.malataverne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.759271, 44.465050] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Crest", "Adresse": "Quartier Chaumiane", "Ville": "Divajeu", "Code postal": "26400", "Phone": "04 75 76 80 60", "Email": "beton.crest@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.984421125824487, 44.73059383446513] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Marcellin", "Adresse": "ZI la Gloriette", "Ville": "Chatte", "Code postal": "38100", "Phone": "04 76 64 05 07", "Email": "beton.stmarcellin@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.2994366, 45.1398532] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - L'Arbresle", "Adresse": "Le Moin√©, route de Lauzanne", "Ville": "Nuelles", "Code postal": "69210", "Phone": "04 74 01 18 45", "Email": "beton.larbresle@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.634372297885533, 45.84405368765808] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Ch√¢lon sur Sa√¥ne", "Adresse": "19 rue F√©rr√©e", "Ville": "Crissey", "Code postal": "71530", "Phone": "03 85 46 15 44", "Email": "beton.chalonsursaone@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.862700409755355, 46.81515376893618] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Nancy", "Adresse": "ZI des clais ch√™nes", "Ville": "Chavigny", "Code postal": "54230", "Phone": "03 83 44 02 44", "Email": "beton.nancy@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1396337262534875, 48.647642870040876] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Romain en Gal", "Adresse": "Zone portuaire CNR", "Ville": "Saint-Germain-au-Mont-d'Or", "Code postal": "69560", "Phone": "04 72 30 14 07", "Email": "beton.stromainengal@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.834036131213699, 45.54622652007517] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Quentin Fallavier", "Adresse": "Rue de la Pierre-Milli√®re", "Ville": "Saint-Quentin-Fallavier", "Code postal": "38200", "Phone": "04 74 94 21 36", "Email": "beton.stquentinfallavier@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.121313128076019, 45.644587261118026] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Tarare", "Adresse": "Lieu-dit Le Mortier", "Ville": "Poncharra sur Turdine", "Code postal": "69490", "Phone": "04 74 05 02 05", "Email": "beton.tarare@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.4737393291702725, 45.88480938955108] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Borderouge", "Adresse": "10 impasse Paul Harris", "Ville": "Toulouse", "Code postal": "31200", "Phone": "05 34 25 08 66", "Email": "beton.borderouge@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.4487552718081338, 43.64923484442168] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Germain des Foss√©s", "Adresse": "Chemin du pont des √Æles", "Ville": "Vichy", "Code postal": "03260", "Phone": "04 70 59 67 35", "Email": "beton.stgermaindesfosses@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.4223448491246224, 46.20666434745773] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Gu√©ret", "Adresse": "Le Masgerot", "Ville": "Saint Sulpice le Gu√©r√©tois", "Code postal": "23000", "Phone": "05 55 52 77 71", "Email": "beton.gueret@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.8380017025266484, 46.189182811122386] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Bourg en Bresse", "Adresse": "9 Rue des Cr√™ts", "Ville": "Bourg en Bresse", "Code postal": "01000", "Phone": "04 74 23 46 48", "Email": "beton.bourgenbresse@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.224688204489039, 46.21993457215142] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Ch√¢tillon sur Chalaronne", "Adresse": "Lieu-dit Champ de l'All√©e, ZI Nord", "Ville": "Ch√¢tillon-sur-Chalaronne", "Code postal": "01400", "Phone": "04 74 55 50 12", "Email": "beton.chatillonsurchalaronne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.945347744057035, 46.12426485423063] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Vichy Sud", "Adresse": "Route d'Haute Rive", "Ville": "Abrest", "Code postal": "03200", "Phone": "04 70 32 19 00", "Email": "beton.abrest@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.4341453655199574, 46.10402332383727] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Jassans-Riottier", "Adresse": "Rue du 3 septembre 44", "Ville": "Jassans Riottier", "Code postal": "01480", "Phone": "04 74 09 96 91", "Email": "beton.jassans-riottier@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.754265871994541, 45.98884270369173] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Montlu√ßon", "Adresse": "Pont de Vaux", "Ville": "Estivareilles", "Code postal": "03190", "Phone": "04 70 06 01 05", "Email": "beton.estivareilles@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.6005321401916706, 46.429078273218025] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Crozet", "Adresse": "Z.I. 212 Rue de la Vie Chatelme", "Ville": "Crozet", "Code postal": "01170", "Phone": "04 50 42 15 01", "Email": "beton.crozet@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.022756230104438, 46.266538545287474] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - La Roquette", "Adresse": "1081 Chemin de la Levade", "Ville": "La Roquette sur Siagne", "Code postal": "06550", "Phone": "06 12 91 97 85", "Email": "beton.roquette@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.943274058448792, 43.576986763042726] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Jarjayes", "Adresse": "Lieu-dit la Madeleine - Les M√¢nes", "Ville": "Jarjayes", "Code postal": "05130", "Phone": "04 92 50 44 95", "Email": "beton.jarjayes@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.093213821355874, 44.48282523501814] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Gap", "Adresse": "29 Route de Saint Jean", "Ville": "Gap", "Code postal": "05000", "Phone": "04 92 51 01 36", "Email": "beton.gap@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.047677702003625, 44.53935442486306] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Nice Var", "Adresse": "79 Boulevard Jean LUCIANO", "Ville": "Nice", "Code postal": "06200", "Phone": "06 16 12 19 09", "Email": "beton.nicevar@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [7.195868396709341, 43.68654779334091] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Dompierre", "Adresse": "Rue de l' √©cluse", "Ville": "Dompierre-sur-Besbre", "Code postal": "03290", "Phone": "04 70 34 50 90", "Email": "beton.dompierre@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.7017209699746023, 46.542232459053196] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Crots", "Adresse": "Z.A. les Moulins", "Ville": "Crots", "Code postal": "05200", "Phone": "04 92 43 13 37", "Email": "beton.crots@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.445663424536943, 44.53561162210869] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Ribiers", "Adresse": "Quartier le Virail", "Ville": "Ribiers", "Code postal": "05300", "Phone": "04 92 62 25 17", "Email": "beton.ribiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.901160373181472, 44.2084945381101] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Menton", "Adresse": "Z.I. Haut Carei - 971 Avenue de St Roman", "Ville": "Menton", "Code postal": "06500", "Phone": "06 11 30 84 57", "Email": "beton.menton@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [7.487003299999999, 43.8071439] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Valbonne", "Adresse": "100 chemin des Clausonnes", "Ville": "Valbonne", "Code postal": "06560", "Phone": "06 11 30 84 66", "Email": "beton.menton@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [7.051935192027538, 43.60717987750158] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Bourg de P√©age", "Adresse": "116 All√©e du Vivarais", "Ville": "Bourg de P√©age", "Code postal": "26300", "Phone": "04 75 02 84 10", "Email": "beton.bourgdepeage@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.0340255992184755, 45.02032338571791] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Bourges", "Adresse": "Z.I. Rue Voltaire", "Ville": "Saint Germain du Puy", "Code postal": "18390", "Phone": "02 48 70 38 75", "Email": "beton.bourges@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.442654273224061, 47.102261728646994] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Moulins", "Adresse": "Rue des Cheminots", "Ville": "Yzeure", "Code postal": "03400", "Phone": "04 70 32 77 78", "Email": "beton.moulins@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.348134347868352, 46.552932861617144] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Portes-l√®s-Valence", "Adresse": "8 rue Jean Jaur√®s", "Ville": "Portes-l√®s-Valence", "Code postal": "26800", "Phone": "04 75 57 16 00", "Email": "beton.porteslesvalence@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.876573245526226, 44.88588867466865] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Colomiers", "Adresse": "11 Chemin de Chasse", "Ville": "Colomiers", "Code postal": "31770", "Phone": "05 62 74 85 81", "Email": "beton.colomiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.3116828374391245, 43.60566093264553] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Amand Montrond", "Adresse": "Rue Sarrault - Lieu dit les Epousardes", "Ville": "Saint Amand Montrond", "Code postal": "18200", "Phone": "02 48 56 42 12", "Email": "beton.stamand@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.4922138596501946, 46.74294570114782] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Brive-la-Gaillarde", "Adresse": "ZI Cana Ouest - Rue Jules Bouchet", "Ville": "Brive-la-Gaillarde", "Code postal": "19100", "Phone": "05 55 88 25 25", "Email": "beton.brive@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.482992352790208, 45.159192408466375] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Loriol", "Adresse": "Route de Crest RN 7", "Ville": "Loriol-sur-Dr√¥me", "Code postal": "26270", "Phone": "04 75 61 62 20", "Email": "beton.loriol@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.842658539278163, 44.7643023820668] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Carbonne", "Adresse": "31 Route de Lan√ßon", "Ville": "Carbonne", "Code postal": "31390", "Phone": "05 61 98 40 81", "Email": "beton.carbonne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.218098912227801, 43.325254064604735] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Martin d'H√®res", "Adresse": "16 Rue Barnave", "Ville": "Saint Martin d'H√®res", "Code postal": "38400", "Phone": "04 76 42 38 34", "Email": "beton.stmartindheres@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.761762727644929, 45.189108923281076] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Voreppe", "Adresse": "Chemin de Jongkind", "Ville": "Voreppe", "Code postal": "38340", "Phone": "04 76 42 38 34", "Email": "beton.voreppe@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.623704696970177, 45.29081178001097] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Bourgoin-Jallieu", "Adresse": "Rue du Premier Film", "Ville": "Bourgoin-Jallieu", "Code postal": "38300", "Phone": "04 74 09 82 12", "Email": "beton.bourgoin@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.250518310635885, 45.5977665134811] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Villard Bonnot", "Adresse": "Rue des Eaux Claires - Quai des N√©gociants", "Ville": "Villard Bonnot", "Code postal": "38190", "Phone": "04 74 09 82 12", "Email": "beton.villardbonnot@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.884391781628484, 45.24009960770652] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Romagnieu", "Adresse": "Le Vorget", "Ville": "Romagnieu", "Code postal": "38480", "Phone": "04 76 37 09 55", "Email": "beton.romagnieu@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.647105325817201, 45.57598473757716] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Varces", "Adresse": "22 impasse du Pr√© de l'Orme", "Ville": "Varces Alli√®res et Risset", "Code postal": "38760", "Phone": "04 76 98 02 25", "Email": "beton.varces@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.684963641136855, 45.109261654253785] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Monistrol", "Adresse": "Z.I. le Chavanon", "Ville": "Monistrol sur Loire", "Code postal": "43120", "Phone": "04 71 66 02 47", "Email": "beton.monistrol@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.184144539299922, 45.278947761729555] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Roques", "Adresse": "9 chemin de Bonnafous", "Ville": "Roques", "Code postal": "31120", "Phone": "05 34 46 57 57", "Email": "beton.roques@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.3438995734627237, 43.49380561160298] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Roanne", "Adresse": "Impasse de la Marne", "Ville": "Roanne", "Code postal": "42300", "Phone": "04 77 68 40 22", "Email": "beton.roanne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.085835152828749, 46.060888473162755] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Fenouillet", "Adresse": "Route de Paris", "Ville": "Fenouillet", "Code postal": "31150", "Phone": "05 61 70 22 02", "Email": "beton.fenouillet@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.4046435545727955, 43.685889047534545] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Rives", "Adresse": "Z.I. le Levatel", "Ville": "Rives", "Code postal": "38140", "Phone": "04 76 91 04 56", "Email": "beton.rives@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.492731625808071, 45.36185645382537] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Villard de Lans", "Adresse": "Z.I. des Geymonds", "Ville": "Villard de Lans", "Code postal": "38250", "Phone": "04 76 42 38 34", "Email": "beton.villarddelans@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.560425912301044, 45.087240043618245] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Villiers", "Adresse": "373 Rte de Saint-Hilaire Lieu-dit", "Ville": "Villers", "Code postal": "42460", "Phone": "04 77 60 67 52", "Email": "beton.villers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.214865268170912, 46.12271438883505] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Yssingeaux", "Adresse": "ZA de Lav√©e", "Ville": "Yssingeaux", "Code postal": "43202", "Phone": "04 71 65 53 09", "Email": "beton.yssingeaux@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.107974827643314, 45.151815430013556] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Chaumont", "Adresse": "Faubourg des 4 Moulins", "Ville": "Chaumont", "Code postal": "52000", "Phone": "03 25 03 20 53", "Email": "beton.chaumont@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.145920454764028, 48.13284453916601] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Verdun", "Adresse": "Boulevard de la Citadelle", "Ville": "Verdun", "Code postal": "55100", "Phone": "03 29 84 75 02", "Email": "beton.verdun@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.376926754809797, 49.14469611884587] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Le Monteil", "Adresse": "Le Monteil", "Ville": "Brives Charensac", "Code postal": "43700", "Phone": "04 71 09 30 74", "Email": "beton.lemonteil@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.9043044457226506, 45.077934998086626] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Nogent en Bassigny", "Adresse": "Z.I. Rue Lavoisier", "Ville": "Nogent en Bassigny", "Code postal": "52800", "Phone": "03 25 32 08 85", "Email": "beton.nogentenbassigny@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.351522067218357, 48.03746854660595] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Nevers", "Adresse": "Zone Industrielle de Varennes Vauzelles", "Ville": "Varennes Vauzelles", "Code postal": "58640", "Phone": "03 86 93 95 62", "Email": "beton.nevers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.1701864856904454, 46.985517129456355] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Villeurbanne", "Adresse": "23 rue Eug√®ne Pottier", "Ville": "Villeurbanne", "Code postal": "69100", "Phone": "04 78 80 90 30", "Email": "beton.villeurbanne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.896799199999999, 45.7869313] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Longeville l√®s Saints Avold", "Adresse": "Z.I. Route Faulquemont", "Ville": "Longeville-l√®s-Saint-Avold", "Code postal": "57740", "Phone": "03 85 34 90 44", "Email": "beton.longeville@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.652884053366776, 49.10642949807357] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Thiers", "Adresse": "Z.I. Felet", "Ville": "Thiers", "Code postal": "63300", "Phone": "04 73 80 12 10", "Email": "beton.thiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.499988353114896, 45.85501609131025] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Meyzieu", "Adresse": "Rue de la R√©publique", "Ville": "Meyzieu", "Code postal": "69330", "Phone": "04 72 02 72 62", "Email": "beton.meyzieu@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.0121505151001005, 45.76523805095096] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Nicolas de Port", "Adresse": "ZAC de la Croisette", "Ville": "Saint Nicolas de Port", "Code postal": "54210", "Phone": "03 83 46 70 66", "Email": "beton.stnicolasdeport@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.2828399918562265, 48.620996870898104] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Mo√ªtiers", "Adresse": "69 Rue des √ârables", "Ville": "Mo√ªtiers", "Code postal": "73600", "Phone": "04 79 24 28 23", "Email": "beton.moutiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.531556, 45.485149] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Chamb√©ry", "Adresse": "170 Rue des Epinettes", "Ville": "La Motte Servolex", "Code postal": "73290", "Phone": "04 79 62 08 37", "Email": "beton.chambery@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.8845151, 45.6096785] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Haute Tarentaise", "Adresse": "Lieu dit des Gli√®res", "Ville": "Villaroger", "Code postal": "73640", "Phone": "04 79 07 69 56", "Email": "beton.hautetarentaise@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.791576831947458, 45.6236240935254] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Ville la Grand", "Adresse": "12 Rue du Bois de la Rose", "Ville": "Ville la Grand", "Code postal": "74100", "Phone": "04 50 87 05 00", "Email": "beton.annemasse@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.276416, 46.205611] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Flumet", "Adresse": "Le Jorat RN 112", "Ville": "Flumet", "Code postal": "73590", "Phone": "04 79 31 11 95", "Email": "beton.flumet@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.516386, 45.819302] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Montm√©lian", "Adresse": "207 route de la carri√®re", "Ville": "La Chavanne", "Code postal": "73800", "Phone": "04 79 84 22 86", "Email": "beton.montmelian@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.069366, 45.498925] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Vourles", "Adresse": "Z.A. du Pont √† Lunettes", "Ville": "Vourles", "Code postal": "69390", "Phone": "04 72 31 10 76", "Email": "beton.vourles@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.7636803, 45.65307989999999] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Pusey", "Adresse": "ZAC de l'Oasis", "Ville": "Pusey", "Code postal": "70000", "Phone": "03 84 75 31 32", "Email": "beton.pusey@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1439981, 47.6459564] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Roye", "Adresse": "D438", "Ville": "Roye", "Code postal": "70200", "Phone": "03 84 30 21 12", "Email": "beton.roye@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.528977, 47.668858] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Villette", "Adresse": "Route du Four", "Ville": "Aime la Plagne", "Code postal": "73210", "Phone": "04 79 09 78 63", "Email": "beton.villette@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.6045, 45.540889] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Digoin", "Adresse": "Rue de la plaine - Z.I. des Muriers", "Ville": "Digoin", "Code postal": "71160", "Phone": "03 85 53 05 75", "Email": "beton.digoin@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.0054723, 46.4813048] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Jean de Maurienne", "Adresse": "Rue Sainte Claire Deville", "Ville": "Saint Jean de Maurienne", "Code postal": "73300", "Phone": "04 79 64 18 73", "Email": "beton.stjeandemaurienne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.361306099999999, 45.275895] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - √âtrembi√®res", "Adresse": "423 Chemin de la Balme", "Ville": "Etrembi√®res", "Code postal": "74100", "Phone": "04 50 94 31 91", "Email": "beton.etrembieres@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1883939802646655, 46.159116] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Bonneville", "Adresse": "1090 Route de Cluses", "Ville": "Bonneville", "Code postal": "74130", "Phone": "04 50 62 06 20", "Email": "beton.bonneville@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.422949399999999, 46.0713433] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Villaz", "Adresse": "433 route des Grands Bois", "Ville": "Villaz", "Code postal": "74370", "Phone": "04 50 01 52 59", "Email": "beton.villaz@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.16632, 45.951745] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Lagny sur Marne", "Adresse": "Rue Freycinet", "Ville": "Lagny sur Marne", "Code postal": "77400", "Phone": "01 64 30 57 89", "Email": "beton.lagnysurmarne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.6789808, 48.87611279999999] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Bonneuil sur Marne", "Adresse": "43 Route de l'Ile Saint Julien", "Ville": "Bonneuil sur Marne", "Code postal": "94380", "Phone": "01 56 71 15 50", "Email": "beton.bonneuilsurmarne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.4854589, 48.7801859] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Gennevilliers", "Adresse": "5 route de la seine, darse n¬∞4", "Ville": "Gennevilliers", "Code postal": "92230", "Phone": "01 47 99 15 47", "Email": "beton.gennevilliers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.2929442705001293, 48.94441354576006] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - √âloise", "Adresse": "RN 108", "Ville": "Ch√™ne-en-Semine", "Code postal": "74270", "Phone": "04 50 66 29 56", "Email": "beton.eloise@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.869, 46.057525] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - La Garde", "Adresse": "720 avenue Nicolas Fabri de Peiresc", "Ville": "La Garde", "Code postal": "83130", "Phone": "06 24 34 37 52", "Email": "beton.lagarde@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.0298907, 43.1408508] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Fr√©jus", "Adresse": "Boulevard de l'Industrie", "Ville": "Puget sur Argens", "Code postal": "83480", "Phone": "06 20 77 36 32", "Email": "beton.frejus@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.700629399227864, 43.446831190812375] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Julien en Genevois", "Adresse": "Z.A. le Juge Gu√©rin", "Ville": "Beaumont", "Code postal": "74160", "Phone": "04 50 04 48 55", "Email": "beton.stjulienengenevois@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.103803999999999, 46.102661] } },
        { "type": "Feature", "properties": { "UP": "Annecy B√©ton - Carri√®re", "Adresse": "11 Rue des Terrasses", "Ville": "Cran-Gevrier", "Code postal": "74960", "Phone": "04 50 57 25 26", "Email": "beton.crangevrier@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1065358, 45.913385] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - La Seyne sur Mer", "Adresse": "Avenue Robert BRUN", "Ville": "La Seyne sur Mer", "Code postal": "83500", "Phone": "06 24 34 37 55", "Email": "beton.laseynesurmer@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.8727718, 43.1181297] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Chamonix", "Adresse": "Chemin des Sabli√®res", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 48 02", "Email": "beton.chamonix@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.814565188407869, 45.89945793091371] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Rumilly", "Adresse": "37 Avenue de l'Arcalod Z.I. des P√©rouses", "Ville": "Rumilly", "Code postal": "74150", "Phone": "04 50 88 27 90", "Email": "beton.rumilly@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.955185294151307, 45.83912625378036] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Annecy", "Adresse": "Route de la Foire", "Ville": "Chavanod", "Code postal": "74650", "Phone": "04 50 69 12 34", "Email": "beton.annecy@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.044829, 45.877832] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Moissy-Cramayel", "Adresse": "ZAC d'Arvigny - 386 Rue Denis Papin", "Ville": "Moissy Cramayel", "Code postal": "77550", "Phone": "01 64 13 37 10", "Email": "beton.moissycramayel@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.581058, 48.614441] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Limoges Sud", "Adresse": "Z.I. du Ponteix Secteur Laugerie", "Ville": "Limoges", "Code postal": "87000", "Phone": "05 55 30 32 88", "Email": "beton.limogessud@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.292353, 45.806333] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Les Pavillons sous Bois", "Adresse": "All√©e Dublin - Z.I. de la Poudrette", "Ville": "Les Pavillons sous Bois", "Code postal": "93320", "Phone": "01 48 02 19 58", "Email": "beton.pavillonssousbois@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.502094722222222, 48.9170364] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Oyonnax", "Adresse": "29 rue Andr√© Cr√©tin", "Ville": "Oyonnax", "Code postal": "01100", "Phone": "04 74 09 87 17", "Email": "beton.oyonnax@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.650583999999999, 46.2689342] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - La Mure", "Adresse": "ZI des Marais", "Ville": "La Mure", "Code postal": "38350", "Phone": "04 76 42 38 34", "Email": "null", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.787172926705937, 44.93176023168832] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Priest", "Adresse": "24 RUE DU LYONNAIS", "Ville": "Saint-Priest", "Code postal": "69800", "Phone": "04 78 20 07 96", "Email": "null", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.9184968, 45.6986373] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Peh", "Adresse": "Rue de S√®te", "Ville": "Saint-Fons", "Code postal": "69190", "Phone": "04 78 80 90 30", "Email": "betonpeh@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.842052, 45.7106] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Champ sur Drac", "Adresse": "11 Rte de Saint-Georges de Commiers", "Ville": "Champ-sur-Drac", "Code postal": "38560", "Phone": "04 76 42 38 34", "Email": "beton.champsurdrac@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.729025195385644, 45.08663089548912] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Ceccon B√©ton Vovray", "Adresse": "2 Rue de la Bouverie", "Ville": "Annecy", "Code postal": "74000", "Phone": "04 50 69 01 20", "Email": "annecybetonvovray@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1169644565549115, 45.88512868501105] } },
        { "type": "Feature", "properties": { "UP": "B√©ton VICAT - Saint Marcel", "Adresse": "ZA La Contamine", "Ville": "St Marcel", "Code postal": "73600", "Phone": "04 50 25 58 65", "Email": "beton.stmarcel@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.553074999999997, 45.49276709509232] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Saint-Denis-l√®s-Bourg", "Adresse": "365 Chemin de la Gravi√®re", "Ville": "Saint-Denis-l√®s-Bourg", "Code postal": "01000", "Phone": "04 74 24 35 14", "Email": "fr-carriere.stdenis@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.173634, 46.205793] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Lurcy-L√©vis", "Adresse": "Le pont de l'Etau", "Ville": "Lurcy-L√©vis", "Code postal": "03320", "Phone": "06 15 47 84 35", "Email": "fr-carriere.lurcy-levis@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [2.949107, 46.743098] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Nice", "Adresse": "79 boulevard Jean Luciano", "Ville": "Nice", "Code postal": "06200", "Phone": "04 93 83 26 54", "Email": "fr-carriere.nicevar@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [7.194128, 43.686908] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Valbonne", "Adresse": "Route de La Valmasque RD 35", "Ville": "Valbonne", "Code postal": "06560", "Phone": "06 08 36 33 52", "Email": "fr-carriere.valbonne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [7.051639711639382, 43.60417554125909] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Saint-Bauzile", "Adresse": "La Treille", "Ville": "Saint-Bauzile", "Code postal": "07210", "Phone": "04 75 85 93 08", "Email": "fr-carriere.loriol@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.683653, 44.677919] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Courceroy", "Adresse": "Lieu Dit Les Dizaines", "Ville": "Courceroy", "Code postal": "10400", "Phone": "03 25 39 67 15", "Email": "carriere.courceroy@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.404569, 48.47719] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - La Courbaisse", "Adresse": "226 route de Tin√©e", "Ville": "Tournefort", "Code postal": "06420", "Phone": "04 93 02 94 39", "Email": "fr-carriere.courbaisse@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [7.185999976686503, 43.92249799477806] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Pierrelatte", "Adresse": "Quartier Jouvette et P√©routine", "Ville": "Pierrelatte", "Code postal": "26700", "Phone": "04 75 54 45 50", "Email": "fr-carriere.pierrelatte@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.6564483, 44.3575977] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - L'Armailler", "Adresse": "1300 Route d'Aiguille", "Ville": "Bourg-l√®s-Valence", "Code postal": "26500", "Phone": "04 75 83 03 28", "Email": "fr-carriere.armailler@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.88937946347653, 44.97841197826239] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Carbonne", "Adresse": "31 Route de Lan√ßon", "Ville": "Carbonne", "Code postal": "31390", "Phone": "05 61 98 40 80", "Email": "fr-carriere.carbonne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [1.2184, 43.323682] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Brignoud", "Adresse": "Isle de Gromont", "Ville": "Brignoud", "Code postal": "38190", "Phone": "04 76 08 67 88", "Email": "fr-carriere.brignoud@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.894887, 45.261333] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Ni√©vroz", "Adresse": "Route", "Ville": "Ni√©vroz", "Code postal": "01120", "Phone": "04 78 06 04 24", "Email": "carriere.nievroz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.068621, 45.814088] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Loriol-sur-Dr√¥me", "Adresse": "chemin de printegarde", "Ville": "Loriol-sur-Dr√¥me", "Code postal": "26270", "Phone": "04 75 85 93 08", "Email": "fr-carriere.loriol@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.778626, 44.769578] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Fenouillet", "Adresse": "Route de Paris", "Ville": "Fenouillet", "Code postal": "31150", "Phone": "05 61 70 57 82", "Email": "fr-carriere.fenouillet@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [1.404086, 43.68554] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Faverges", "Adresse": "Plaine de Faverges", "Ville": "Creys-M√©pieu", "Code postal": "38510", "Phone": "04 74 88 50 51", "Email": "fr-carriere.faverges@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.454341, 45.768019] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Barraux", "Adresse": "90 Route Nationale 90", "Ville": "Barraux", "Code postal": "38530", "Phone": "04 76 97 31 13", "Email": "fr-carriere.barraux@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.00329972, 45.4416538] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Chapareillan", "Adresse": "RN90", "Ville": "Chapareillan", "Code postal": "38530", "Phone": "04 37 06 24 90", "Email": "fr-carriere.chaparei@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.0009215337295245, 45.4549798814878] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Pontcharra", "Adresse": "193 rue Dragueline", "Ville": "Pontcharra", "Code postal": "38530", "Phone": "04 76 97 61 64", "Email": "fr-carriere.pontcharra@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.005888, 45.435979] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Bas-en-Basset", "Adresse": "Pont rouge - RD42", "Ville": "Bas-en-Basset", "Code postal": "43210", "Phone": "04 71 66 72 07", "Email": "fr-carriere.basset@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.102603, 45.328128] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - H√©rim√©nil", "Adresse": "Grande Rue", "Ville": "H√©rim√©nil", "Code postal": "54300", "Phone": "03 83 74 07 24", "Email": "fr-carriere.herimenil@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.485800569450371, 48.571572043690686] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Moncel-l√®s-Lun√©ville", "Adresse": "RN 59 - L'Embanie", "Ville": "Moncel-l√®s-Lun√©ville", "Code postal": "54300", "Phone": "03 83 74 07 24", "Email": "fr-carriere.moncel@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.543964, 48.562376] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Bathel√©mont", "Adresse": "Carri√®re Bathel√©mont", "Ville": "Bathel√©mont", "Code postal": "54370", "Phone": "03 83 74 07 24", "Email": "fr-carriere.herimenil@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.5417372, 48.69667] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Proulieu", "Adresse": "Hameau Les Montgrillettes", "Ville": "Lagnieu", "Code postal": "01150", "Phone": "04 74 61 53 37", "Email": "carriere.proulieu@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.290947, 45.863029] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Maizi√®res", "Adresse": "Rue du fort", "Ville": "Maizi√®res", "Code postal": "54550", "Phone": "03 83 52 79 77", "Email": "fr-carriere.maiziere@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.05975, 48.594569] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Bl√©nod-l√®s-Pont-√†-Mousson", "Adresse": "Sur le Chemin d'avioux", "Ville": "Bl√©nod-l√®s-Pont-√†-Mousson", "Code postal": "54700", "Phone": "03 83 44 07 33", "Email": "fr-carriere.blenod@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.0629904, 48.885797] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Saint-Cl√©ment", "Adresse": "Rue de la Prairie", "Ville": "Saint-Cl√©ment", "Code postal": "54950", "Phone": "03 83 74 07 24", "Email": "fr-carriere.stclement@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.590949, 48.5279] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Richemont", "Adresse": "Route de la Centrale", "Ville": "Richemont", "Code postal": "57270", "Phone": "03 83 44 07 33", "Email": "carriere.richemont@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.176313, 49.274766] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Les Martres-d'Arti√®re", "Adresse": "Route de Vichy", "Ville": "Les Martres-d'Arti√®re", "Code postal": "63430", "Phone": "04 73 83 70 45", "Email": "fr-carriere.lesmartres@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.264608, 45.816033] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Villeurbanne", "Adresse": "27 rue Eug√®ne Pottier", "Ville": "Villeurbanne", "Code postal": "69100", "Phone": "04 78 80 33 48", "Email": "fr-carriere.villeurbanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.8973787, 45.7875502] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Belleville-en-Beaujolais", "Adresse": "Rue de la Baryte", "Ville": "Belleville-en-Beaujolais", "Code postal": "69220", "Phone": "04 74 66 50 00", "Email": "fr-carriere.belleville@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.75554, 46.100291] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Saint-Germain-au-Mont-d'Or", "Adresse": "Avenue Louis Armand Les Aveyni√®res", "Ville": "Saint-Germain-au-Mont-d'Or", "Code postal": "69650", "Phone": "04 78 91 23 46", "Email": "fr-carriere.st-germain@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.804926, 45.891851] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - La Reveriaz", "Adresse": "569 boulevard Henry Bordeaux", "Ville": "Chamb√©ry", "Code postal": "73000", "Phone": "04 79 84 48 42", "Email": "fr-carriere.reveriaz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.903123, 45.567691] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Jassans-Riottier", "Adresse": "Rue du 3 Septembre 1944", "Ville": "Jassans-Riottier", "Code postal": "01480", "Phone": "04 74 09 87 03", "Email": "fr-carriere.jassans@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.752965, 45.984453] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Gilly-sur-Is√®re", "Adresse": "110 route des Peupliers", "Ville": "Gilly-sur-Is√®re", "Code postal": "73200", "Phone": "04 79 32 43 52", "Email": "fr-carriere.gilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.359545499999999, 45.6499102] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Villarcher", "Adresse": "55 rue des Epinettes", "Ville": "La Motte-Servolex", "Code postal": "73290", "Phone": "04 79 62 29 29", "Email": "fr-carriere.villarcher@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.885571, 45.609363] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - La Chavanne", "Adresse": "207 route de la carri√®re", "Ville": "La Chavanne", "Code postal": "73800", "Phone": "04 79 84 32 68", "Email": "fr-carriere.lachavanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.06935, 45.49892] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Les Houches alluvionaires", "Adresse": "Route blanche sortie 28", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 56 58", "Email": "fr-carriere.clairtemps@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.81342895920136, 45.89849026697671] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - P√©rouges La Valbonne", "Adresse": "Route de Saint-Maurice-de-Gourdans", "Ville": "P√©rouges", "Code postal": "01800", "Phone": "04 74 46 08 30", "Email": "FRshared.carrierebrun@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.179248, 45.858629] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Pont-du-Ch√¢teau", "Adresse": "Lieu-dit La Croze", "Ville": "Pont-du-Ch√¢teau", "Code postal": "63430", "Phone": "04 73 83 70 45", "Email": "fr-carriere.lesmartres@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.262366, 45.810025] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Bellecombe-en-Bauges", "Adresse": "205 chemin de la carri√®re", "Ville": "Bellecombe-en-Bauges", "Code postal": "73340", "Phone": "04 79 62 98 38", "Email": "fr-carriere.bellecombe@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.1093143, 45.734207] } },
        { "type": "Feature", "properties": { "UP": "Annecy B√©ton - Carri√®res Cran-Gevrier", "Adresse": "14 Chemin des Gr√®ves", "Ville": "Cran-Gevrier", "Code postal": "74960", "Phone": "04 50 01 52 54", "Email": "fr-carriere.crangevrier@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.103650119049089, 45.91123723927206] } },
        { "type": "Feature", "properties": { "UP": "Annecy B√©ton - Carri√®res Planaz", "Adresse": "voie communale n¬∞1 de la D992 √† Planaz", "Ville": "Desingy", "Code postal": "74270", "Phone": "04 50 57 25 60", "Email": "fr-carriere.planaz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.867644, 46.012098] } },
        { "type": "Feature", "properties": { "UP": "Annecy B√©ton - Carri√®res Rumilly", "Adresse": "37 avenue de l'Arcalod", "Ville": "Rumilly", "Code postal": "74150", "Phone": "04 50 01 00 04", "Email": "fr-carriere.rumilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.9556509, 45.8393059] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Ceyz√©riat", "Adresse": "1832 Les Soudani√®res", "Ville": "Ceyz√©riat", "Code postal": "01250", "Phone": "04 74 30 00 91", "Email": "fr-carriere.ceyzeriat@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.3255456, 46.19231571] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Colomiers", "Adresse": "11 Chemin de la Chasse", "Ville": "Colomiers", "Code postal": "31770", "Phone": "07 64 28 54 57", "Email": "fr-carriere.colomiers@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [1.3110313, 43.6022061] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - P√©rouges L'Allagnier", "Adresse": "Route de L'Allagnier", "Ville": "P√©rouges", "Code postal": "01800", "Phone": "04 74 46 08 30", "Email": "carriere.perouges@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.185188, 45.854962] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Port Edouard Herriot", "Adresse": "2 Rue de S√®te", "Ville": "Saint-Fons", "Code postal": "69190", "Phone": "04 72 02 10 92", "Email": "carriere.peh@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.842052, 45.7106] } },
        { "type": "Feature", "properties": { "UP": "C 2 B Chalon-sur-Sa√¥ne", "Adresse": "Zone portuaire sud", "Ville": "Epervans", "Code postal": "71380", "Phone": "03 85 42 49 49", "Email": "fr-carriere.epervans@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.875538641698847, 46.75908966595778] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Saint-Jean-le-Vieux", "Adresse": "Route Bourg Hauterive", "Ville": "Saint-Jean-le-Vieux", "Code postal": "01640", "Phone": "04 74 36 98 53", "Email": "fr-carriere.stjeanlevieux@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.353286, 46.024772] } },
        { "type": "Feature", "properties": { "UP": "C 2 B Pierre-de-Bresse", "Adresse": "Route de Lays", "Ville": "Pierre-de-Bresse", "Code postal": "71270", "Phone": "03 85 76 23 34", "Email": "c2b.pdb@orange.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.251036490737899, 46.9008810573724] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Ennery", "Adresse": "BP 21", "Ville": "Ennery", "Code postal": "57365", "Phone": "03 87 73 85 96", "Email": "fr-carriere.maredemancourt@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.193816190629566, 49.24034413939231] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Ay-sur-Moselle", "Adresse": "Angle D1/RD8 Bis", "Ville": "Ay-sur-Moselle", "Code postal": "57300", "Phone": "03 87 73 85 96", "Email": "fr-carriere.velersjacques@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.198672860916141, 49.25547680103846] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Besson", "Adresse": "Bois des Landes", "Ville": "Besson", "Code postal": "03210", "Phone": "04 70 43 60 75", "Email": "fr-carriere.souvigny@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.218094057861318, 46.45692183068944] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - La Seyne-sur-Mer", "Adresse": "1527 Avenue Robert Brun", "Ville": "La Seyne-Sur-Mer", "Code postal": "83500", "Phone": "07 61 60 25 38", "Email": "fr-carriere.laseynesurmer@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.859684279067983, 43.117141553319655] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - P√©rouges Les Communaux", "Adresse": "Rue des communaux", "Ville": "P√©rouges", "Code postal": "01800", "Phone": "04 74 46 08 30", "Email": "carriere.perouges@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.180478, 45.852145] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Souvigny", "Adresse": "Lieu-dit La Fauch√®re", "Ville": "Souvigny", "Code postal": "03210", "Phone": "04 70 43 60 75", "Email": "fr-carriere.souvigny@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.202206, 46.517385] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Les Houches roches massives", "Adresse": "Route blanche sortie 28", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 56 58", "Email": "fr-carriere.clairtemps@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.81342895920136, 45.89849026697671] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Montailleur", "Adresse": "LES COMMUNAUX", "Ville": "Montailleur", "Code postal": "73460", "Phone": "04 79 32 43 52", "Email": "fr-carriere.gilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.28196902, 45.60796989] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Laissaud Pr√© Couardin (K3+)", "Adresse": "PRE COUARDIN", "Ville": "Laissaud", "Code postal": "73800", "Phone": "04 79 84 32 68", "Email": "fr-carriere.lachavanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.02095404, 45.46773046] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Laissaud Les Gli√®res", "Adresse": "LES GLIERES", "Ville": "Laissaud", "Code postal": "73800", "Phone": "04 79 84 32 68", "Email": "fr-carriere.lachavanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.01306016, 45.45489245] } },
        { "type": "Feature", "properties": { "UP": "Sabli√®re - Sainte H√©l√®ne", "Adresse": "ZONE INDUSTRIELLE - BP 7", "Ville": "Sainte-H√©l√®ne-sur-Is√®re", "Code postal": "73460", "Phone": "04 79 32 43 52", "Email": "fr-carriere.gilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.29633754, 45.6105748] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Bocher", "Adresse": "BOCHER NORD", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 56 58", "Email": "fr-carriere.clairtemps@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.77918392, 45.90734967] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - La Salle", "Adresse": "route du Ch√¢teau", "Ville": "La Salle", "Code postal": "71260", "Phone": "03 85 23 86 07", "Email": "fr-carriere.lasalle@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.857418, 46.41025] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Montagny-l√®s-Buxy", "Adresse": "RD 977 Les Chaumes", "Ville": "Montagny-l√®s-Buxy", "Code postal": "71390", "Phone": "03 85 43 62 89", "Email": "fr-carriere.lesbuxy@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.671514, 46.713158] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Tournus", "Adresse": "7 quai de Sa√¥ne", "Ville": "Tournus", "Code postal": "71700", "Phone": "03 85 51 07 12", "Email": "fr-carriere.tournus@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.918228796295125, 46.55459105465899] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - M√¢con", "Adresse": "Rue des fr√®res lumi√®re", "Ville": "M√¢con", "Code postal": "71000", "Phone": "03 85 34 84 00", "Email": "fr-carriere.macon@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.824893, 46.284421] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Montagnole", "Adresse": "CARRIERE DE MONTAGNOLE", "Ville": "Montagnole", "Code postal": "73000", "Phone": "04 79 84 48 42", "Email": "fr-carriere.reveriaz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.920625, 45.543914] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie VICAT - Montalieu", "Adresse": "Route des Usines", "Ville": "Montalieu-Vercieu", "Code postal": "38390", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [5.4149292, 45.8041108] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie VICAT - La P√©relle", "Adresse": "2420 Rte de Fourvoirie", "Ville": "Saint-Laurent-du-Pont", "Code postal": "38380", "activity": "ciment-prompt" }, "geometry": { "type": "Point", "coordinates": [5.739827, 45.3793544] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie VICAT - Xeuilley", "Adresse": "16 Route de Pierreville", "Ville": "Xeuilley", "Code postal": "54990", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [6.102826118469238, 48.567970275878906] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie VICAT - Cr√©chy", "Adresse": "Rue des Andrivaux", "Ville": "Cr√©chy", "Code postal": "03150", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [3.427324, 46.2544481] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie VICAT - Peille", "Adresse": "2693 quart Grave de, 06440 Blausasc", "Ville": "Blausasc", "Code postal": "06440", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [7.374574415562, 43.790325370506] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie VICAT - Saint √âgr√®ve", "Adresse": "1 Rue du Lac", "Ville": "Saint-Egr√®ve", "Code postal": "38120", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [5.669908982548, 45.234425005147] } }
    ]
    };
    
    // Convertir automatiquement tous les caract√®res accentu√©s en Unicode
    const establishmentsData = convertToUnicodeEscapes(establishmentsDataRaw);

    // Ajouter des IDs uniques aux features
    establishmentsData.features.forEach((feature, index) => {
        feature.properties.id = feature.properties.UP + '_' + index;
    });

    // Fonctions utilitaires
    function debounce(func, wait) {
        return function executedFunction(...args) {
            const later = () => { clearTimeout(debounceTimer); func(...args); };
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(later, wait);
        };
    }
    function decodeHTMLEntities(text) {
        if (typeof text !== 'string') return text;
        // Retourner le texte directement sans d√©coder les entit√©s HTML
        // car les donn√©es sont d√©j√† en UTF-8 et non en entit√©s HTML
        return text;
    }
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    function findNearbyUPs(coordinates, radiusKm) {
        const nearbyUPs = [];
        if (!establishmentsData || !establishmentsData.features) return nearbyUPs;
        
        establishmentsData.features.forEach((feature) => {
            const distance = calculateDistance(
                coordinates[1], coordinates[0],
                feature.geometry.coordinates[1], feature.geometry.coordinates[0]
            );
            
            if (distance <= radiusKm) {
                nearbyUPs.push({
                    feature: feature,
                    distance: distance
                });
            }
        });
        
        // Trier par distance
        nearbyUPs.sort((a, b) => a.distance - b.distance);
        
        return nearbyUPs;
    }
    
    function localUPGeocoder(query) {
        if (!query || query.length < 2) {
            return [];
        }
        
        if (!establishmentsData || !establishmentsData.features) {
            return [];
        }
        
        const results = [];
        const queryLower = query.toLowerCase();
        
        // Chercher dans les UP
        establishmentsData.features.forEach((feature, index) => {
            if (results.length >= 5) return;
            
            if (feature.properties.UP && feature.properties.UP.toLowerCase().includes(queryLower)) {
                const upName = decodeHTMLEntities(feature.properties.UP);
                const address = decodeHTMLEntities(feature.properties.Adresse || '');
                const city = decodeHTMLEntities(feature.properties.Ville || '');
                
                results.push({
                    id: `local-up-${index}`,
                    type: 'Feature',
                    place_type: ['place'],
                    relevance: 1.0,
                    text: `[UP] ${upName}`,
                    place_name: `üìç ${upName}, ${address}, ${city}`,
                    center: feature.geometry.coordinates,
                    geometry: feature.geometry,
                    properties: feature.properties,
                    context: []
                });
            }
        });
        
        // Chercher dans les villes si pas assez de r√©sultats
        if (results.length < 3) {
            establishmentsData.features.forEach((feature, index) => {
                if (results.length >= 5) return;
                
                if (feature.properties.Ville && 
                    feature.properties.Ville.toLowerCase().includes(queryLower) &&
                    !results.some(r => r.properties && r.properties.UP === feature.properties.UP)) {
                    
                    const upName = decodeHTMLEntities(feature.properties.UP);
                    const city = decodeHTMLEntities(feature.properties.Ville || '');
                    
                    results.push({
                        id: `local-city-${index}`,
                        type: 'Feature',
                        place_type: ['place'],
                        relevance: 0.8,
                        text: `[UP] ${upName}`,
                        place_name: `üìç ${upName} ‚Ä¢ ${city}`,
                        center: feature.geometry.coordinates,
                        geometry: feature.geometry,
                        properties: feature.properties,
                        context: []
                    });
                }
            });
        }
        
        return results;
    }

    // D√©finition des r√©gions fran√ßaises avec leurs coordonn√©es approximatives
    const regions = {
        'Auvergne-Rh√¥ne-Alpes': { center: [5.7301, 45.3584], bounds: [[3.8, 44.0], [7.7, 46.8]] },
        'Bourgogne-Franche-Comt√©': { center: [5.0301, 47.0584], bounds: [[2.8, 46.0], [7.2, 48.5]] },
        'Nouvelle-Aquitaine': { center: [0.8301, 45.3584], bounds: [[-2.0, 42.0], [3.0, 47.0]] },
        'Occitanie': { center: [2.3301, 43.5584], bounds: [[-1.0, 42.0], [5.0, 45.0]] },
        'Grand Est': { center: [6.2301, 49.0584], bounds: [[4.0, 47.5], [8.5, 50.5]] },
        'Hauts-de-France': { center: [2.8301, 50.1584], bounds: [[1.0, 49.0], [4.5, 51.5]] },
        'Normandie': { center: [0.2301, 49.0584], bounds: [[-2.0, 48.0], [2.0, 50.0]] },
        '√éle-de-France': { center: [2.3488, 48.8534], bounds: [[1.4, 48.1], [3.6, 49.2]] },
        'Centre-Val de Loire': { center: [1.8301, 47.2584], bounds: [[0.0, 46.0], [3.5, 48.5]] },
        'Pays de la Loire': { center: [-1.1699, 47.4584], bounds: [[-2.5, 46.0], [0.5, 48.5]] },
        'Bretagne': { center: [-3.1699, 48.2584], bounds: [[-5.5, 47.0], [-1.0, 49.0]] },
        'Provence-Alpes-C√¥te d\'Azur': { center: [6.2301, 43.9584], bounds: [[4.2, 43.0], [7.7, 45.0]] },
        'Corse': { center: [9.1301, 42.1584], bounds: [[8.5, 41.3], [9.8, 43.1]] },
        'Languedoc-Roussillon': { center: [3.8301, 43.6584], bounds: [[1.7, 42.3], [4.9, 44.9]] }
    };

    function getRegionForCoordinates(lng, lat) {
        for (const [regionName, regionData] of Object.entries(regions)) {
            const [[minLng, minLat], [maxLng, maxLat]] = regionData.bounds;
            if (lng >= minLng && lng <= maxLng && lat >= minLat && lat <= maxLat) {
                return regionName;
            }
        }
        return 'Autre r√©gion';
    }


    function calculateTravelTime(distance) {
        // Calcul avec fourchette : temps optimiste (70 km/h) et pessimiste (40 km/h)
        const minHours = distance / 70; // Conditions id√©ales
        const maxHours = distance / 40; // Conditions difficiles (ville, traffic)
        
        const minMinutes = Math.round(minHours * 60 / 5) * 5; // Arrondir aux 5 min
        const maxMinutes = Math.round(maxHours * 60 / 5) * 5;
        
        if (maxMinutes < 60) {
            if (minMinutes === maxMinutes) {
                return `${minMinutes} min`;
            }
            return `${minMinutes}-${maxMinutes} min`;
        } else {
            const minH = Math.floor(minMinutes / 60);
            const minM = minMinutes % 60;
            const maxH = Math.floor(maxMinutes / 60);
            const maxM = maxMinutes % 60;
            
            if (minH === maxH && minM === maxM) {
                return minM > 0 ? `${minH}h${minM}` : `${minH}h`;
            }
            
            const minStr = minM > 0 ? `${minH}h${minM}` : `${minH}h`;
            const maxStr = maxM > 0 ? `${maxH}h${maxM}` : `${maxH}h`;
            return `${minStr}-${maxStr}`;
        }
    }

    function addClusterLayers() {
        // Cluster circles
        map.addLayer({
            id: 'clusters',
            type: 'circle',
            source: 'establishments',
            filter: ['has', 'point_count'],
            paint: {
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#555',     // cluster-small (gris moyen)
                    10, '#333', // cluster-medium (gris fonc√©)
                    50, '#222'  // cluster-large (gris tr√®s fonc√©)
                ],
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    17, // cluster-small (35px/2 = 17.5)
                    10, 22, // cluster-medium (45px/2 = 22.5)
                    50, 27  // cluster-large (55px/2 = 27.5)
                ],
                'circle-stroke-width': 3,
                'circle-stroke-color': '#fff'
            }
        });

        // Cluster count labels
        map.addLayer({
            id: 'cluster-count',
            type: 'symbol',
            source: 'establishments',
            filter: ['has', 'point_count'],
            layout: {
                'text-field': ['get', 'point_count_abbreviated'],
                'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                'text-size': 14
            },
            paint: {
                'text-color': '#fff'
            }
        });

        // Individual points (unclustered)
        map.addLayer({
            id: 'unclustered-point',
            type: 'symbol',
            source: 'establishments',
            filter: ['!', ['has', 'point_count']],
            layout: {
                'icon-image': [
                    'case',
                    ['==', ['get', 'activity'], 'beton'], 'beton-marker',
                    ['==', ['get', 'activity'], 'granulats'], 'granulats-marker',
                    ['==', ['get', 'activity'], 'ciment'], 'ciment-marker',
                    ['==', ['get', 'activity'], 'ciment-prompt'], 'ciment-prompt-marker',
                    'beton-marker'
                ],
                'icon-size': 1.0,   // Taille normale car images redimensionn√©es √† 32x32
                'icon-allow-overlap': true
            }
        });
    }
    
    function loadMarkerImages(callback) {
        const markers = {
            'beton-marker': 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-beton.png',
            'granulats-marker': 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-granulats.png',
            'ciment-marker': 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-ciment.png',
            'ciment-prompt-marker': 'https://www.solutions-vicat.fr/sites/default/files/2024-12/ciment-prompt-naturel.png'
        };
        
        const markerIds = Object.keys(markers);
        let loadedCount = 0;
        
        const checkComplete = () => {
            loadedCount++;
            if (loadedCount === markerIds.length && callback) {
                callback();
            }
        };
        
        Object.entries(markers).forEach(([id, url]) => {
            // Utiliser map.loadImage() directement (pas de probl√®me CORS sur solutions-vicat.fr)
            map.loadImage(url, (error, image) => {
                if (error) {
                    // Fallback avec ic√¥ne SVG
                    createSVGMarkerIcon(id, getColorForMarker(id), getSymbolForMarker(id));
                } else {
                    // Redimensionner l'image si elle est trop grande
                    const resizedImage = resizeImageForMap(image, 32, 32);
                    
                    if (!map.hasImage(id)) {
                        map.addImage(id, resizedImage);
                    }
                }
                checkComplete();
            });
        });
    }
    
    function resizeImageForMap(image, targetWidth, targetHeight) {
        // Si l'image est d√©j√† petite, la retourner telle quelle
        if (image.data && image.data.width <= targetWidth && image.data.height <= targetHeight) {
            return image;
        }
        
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            
            // Cr√©er une image HTML temporaire pour le redimensionnement
            const tempImg = new Image();
            tempImg.width = image.data ? image.data.width : targetWidth;
            tempImg.height = image.data ? image.data.height : targetHeight;
            
            // Si c'est un ImageBitmap ou ImageData, nous devons convertir diff√©remment
            if (image.data) {
                // Cr√©er ImageData √† partir des donn√©es
                const imageData = new ImageData(image.data.data, image.data.width, image.data.height);
                
                // Cr√©er un canvas temporaire avec l'image originale
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = image.data.width;
                tempCanvas.height = image.data.height;
                tempCtx.putImageData(imageData, 0, 0);
                
                // Redimensionner sur le canvas final
                ctx.drawImage(tempCanvas, 0, 0, targetWidth, targetHeight);
            } else {
                // Pour les autres formats, essayer de dessiner directement
                ctx.drawImage(image, 0, 0, targetWidth, targetHeight);
            }
            
            // Retourner les donn√©es d'image redimensionn√©es
            const resizedImageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
            return resizedImageData;
            
        } catch (e) {
            // Retourner l'image originale en cas d'erreur
            return image;
        }
    }
    
    function getColorForMarker(id) {
        const colors = {
            'beton-marker': '#4CAF50',
            'granulats-marker': '#FF9800',
            'ciment-marker': '#2196F3',
            'ciment-prompt-marker': '#9C27B0'
        };
        return colors[id] || '#666';
    }
    
    function getSymbolForMarker(id) {
        const symbols = {
            'beton-marker': 'B',
            'granulats-marker': 'G',
            'ciment-marker': 'C',
            'ciment-prompt-marker': 'P'
        };
        return symbols[id] || '?';
    }
    
    function createSVGMarkerIcon(id, color, symbol) {
        const size = 32;  // M√™me taille que les images redimensionn√©es
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Dessiner une ic√¥ne simple et coh√©rente
        // Ombre l√©g√®re
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath();
        ctx.ellipse(size/2 + 1, size - 2, 8, 3, 0, 0, 2 * Math.PI);
        ctx.fill();
        
        // Corps principal (cercle simple)
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(size/2, size/2, 10, 0, Math.PI * 2);
        ctx.fill();
        
        // Bordure blanche fine
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(size/2, size/2, 10, 0, Math.PI * 2);
        ctx.stroke();
        
        // Texte au centre
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(symbol, size/2, size/2);
        
        // Ajouter l'image √† Mapbox
        const imageData = ctx.getImageData(0, 0, size, size);
        if (!map.hasImage(id)) {
            map.addImage(id, imageData);
        }
    }
    
    function createFallbackMarker(id) {
        // Cr√©er un marqueur de base visible
        const size = 40;  // Taille augment√©e
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Dessiner un cercle de couleur selon le type
        const colors = {
            'beton-marker': '#4CAF50',    // Vert pour b√©ton
            'granulats-marker': '#FF9800', // Orange pour granulats
            'ciment-marker': '#2196F3',   // Bleu pour ciment
            'ciment-prompt-marker': '#9C27B0' // Violet pour ciment prompt
        };
        
        // Fond
        ctx.fillStyle = colors[id] || '#666';
        ctx.beginPath();
        ctx.arc(size/2, size/2, size/2 - 3, 0, 2 * Math.PI);
        ctx.fill();
        
        // Bordure blanche
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Ajouter une lettre pour identifier le type
        const letters = {
            'beton-marker': 'B',
            'granulats-marker': 'G',
            'ciment-marker': 'C',
            'ciment-prompt-marker': 'P'
        };
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(letters[id] || '?', size/2, size/2);
        
        const imageData = ctx.getImageData(0, 0, size, size);
        if (!map.hasImage(id)) {
            map.addImage(id, imageData);
        }
    }
    
    function createColoredMarkerForMapbox(id, color) {
        const size = 30;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Dessiner un cercle avec la couleur sp√©cifi√©e
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(size/2, size/2, size/2 - 3, 0, 2 * Math.PI);
        ctx.fill();
        
        // Bordure blanche
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        const imageData = ctx.getImageData(0, 0, size, size);
        if (!map.hasImage(id)) {
            map.addImage(id, imageData);
        }
    }
    
    function updateEstablishmentsSource(features) {
        if (map.getSource('establishments')) {
            const featureCollection = {
                type: 'FeatureCollection',
                features: features || establishmentsData.features
            };
            map.getSource('establishments').setData(featureCollection);
        }
    }
    
    function setupClusterInteractions() {
        // Click event for clusters - progressive zoom
        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            
            const currentZoom = map.getZoom();
            const maxZoom = 16; // Limite de zoom maximum
            const zoomIncrement = 2; // Zoom progressif par √©tapes de 2
            
            // Calculer le nouveau niveau de zoom
            const newZoom = Math.min(currentZoom + zoomIncrement, maxZoom);
            
            // Zoomer vers le cluster de mani√®re progressive
            map.easeTo({
                center: features[0].geometry.coordinates,
                zoom: newZoom,
                duration: 500
            });
        });

        // Click event for individual points - show popup
        map.on('click', 'unclustered-point', (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const properties = e.features[0].properties;
            
            // Ensure that if the map is zoomed out such that multiple copies of the feature are visible, the popup appears over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            
            // Si on est en vue zoom√©e (m√™me manuellement), consid√©rer cette UP comme active
            const currentPitch = map.getPitch();
            const currentZoom = map.getZoom();
            const mapCenter = map.getCenter();
            const distance = turf.distance(
                turf.point([mapCenter.lng, mapCenter.lat]),
                turf.point(coordinates),
                { units: 'kilometers' }
            );
            
            // Si on est tr√®s zoom√© ET proche de cette UP, la consid√©rer comme en vue 3D
            if ((currentPitch > 45 && currentZoom >= 16) || (currentZoom >= 15 && distance < 1)) {
                currentView3DCoordinates = coordinates;
            }
            
            // Utiliser showSinglePopup pour garantir qu'un seul popup soit visible
            showSinglePopup(properties, coordinates);
        });
        
        // Double-click event for individual points
        map.on('dblclick', 'unclustered-point', (e) => {
            e.preventDefault();
            const feature = {
                geometry: e.features[0].geometry,
                properties: e.features[0].properties
            };
            
            // En mode normal, s√©lectionner l'UP et afficher le rayon
            if (window.currentAppMode === 'normal') {
                selectUPAndShowRadius(feature);
            } else {
                // En mode itin√©raire, comportement normal
                focusOnEstablishment(feature);
            }
        });

        // Change cursor to pointer when hovering over clusters or points
        map.on('mouseenter', 'clusters', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'clusters', () => {
            map.getCanvas().style.cursor = '';
        });
        
        map.on('mouseenter', 'unclustered-point', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
        });
    }


    function updateLegendCountsFromViewport() {
        if (!map.isStyleLoaded() || !primaryFilteredFeatures) {
            return;
        }

        let featuresToCount = [];
        
        // D√©terminer quels √©tablissements compter selon le mode d'affichage
        if (currentLayoutMode === 'sidebarFull') {
            // En mode sidebar complet, compter tous les √©tablissements filtr√©s
            featuresToCount = [...primaryFilteredFeatures];
        } else if (currentLayoutMode === 'mapFull' || currentLayoutMode === 'dual') {
            // En mode carte, compter seulement les √©tablissements visibles dans le viewport
            if (currentSearchCenter && primaryFilteredFeatures.length > 0) {
                // Si recherche active, compter tous les r√©sultats filtr√©s
                featuresToCount = [...primaryFilteredFeatures];
            } else {
                // Sinon, compter seulement ceux visibles sur la carte
                const mapBounds = map.getBounds();
                featuresToCount = primaryFilteredFeatures.filter(feature => {
                    if (!feature.geometry || !feature.geometry.coordinates) return false;
                    return mapBounds.contains(feature.geometry.coordinates);
                });
            }
        }

        // Compter par type d'activit√©
        const counts = { beton: 0, granulats: 0, ciment: 0, 'ciment-prompt': 0 };
        
        featuresToCount.forEach(feature => {
            const activity = feature.properties.activity;
            if (counts.hasOwnProperty(activity)) {
                counts[activity]++;
            }
        });

        // Mettre √† jour les √©l√©ments de la l√©gende
        const betonCountElement = document.getElementById('beton-count');
        const granulatsCountElement = document.getElementById('granulats-count');
        const cimentCountElement = document.getElementById('ciment-count');
        const cimentPromptCountElement = document.getElementById('ciment-prompt-count');
        
        if (betonCountElement) betonCountElement.textContent = counts.beton;
        if (granulatsCountElement) granulatsCountElement.textContent = counts.granulats;
        if (cimentCountElement) cimentCountElement.textContent = counts.ciment;
        if (cimentPromptCountElement) cimentPromptCountElement.textContent = counts['ciment-prompt'];
        
        // Afficher la l√©gende ciment prompt seulement s'il y a des √©tablissements ciment-prompt dans les donn√©es
        const cimentPromptLegend = document.getElementById('ciment-prompt-legend');
        if (cimentPromptLegend) {
            // V√©rifier s'il y a au moins un √©tablissement ciment-prompt dans TOUTES les donn√©es
            const hasCimentPrompt = establishmentsData.features.some(feature => 
                getActivityType(feature.properties.activity) === 'ciment-prompt'
            );
            
            if (hasCimentPrompt) {
                cimentPromptLegend.style.display = 'flex';
            } else {
                cimentPromptLegend.style.display = 'none';
            }
        }
        
        // Afficher la l√©gende
        const mapLegend = document.getElementById('map-legend');
        if (mapLegend) {
            mapLegend.style.display = 'block';
        } else {
        }
    }

    
    function initializeMap() {
        // Pr√©server la l√©gende et le switcher avant de nettoyer le conteneur
        const mapContainer = document.getElementById('map');
        let legendElement = null;
        let switcherElement = null;
        
        if (mapContainer) {
            // Sauvegarder la l√©gende avant de nettoyer
            legendElement = mapContainer.querySelector('#map-legend');
            if (legendElement) {
                legendElement = legendElement.cloneNode(true);
            }
            
            // Sauvegarder le mode switcher avant de nettoyer
            switcherElement = mapContainer.querySelector('.mode-switcher-container');
            if (switcherElement) {
                switcherElement = switcherElement.cloneNode(true);
            }
            
            mapContainer.innerHTML = '';
        }
        
        map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/streets-v11',
            center: [2.2137, 46.2276], zoom: 5, pitch: 0, bearing: 0,
            zoomControl: false // D√©sactiver les contr√¥les de zoom par d√©faut (on utilise nos boutons custom)
            // Configuration Mapbox par d√©faut - tout est activ√© automatiquement
        });
        
        // Restaurer la l√©gende et le switcher apr√®s l'initialisation de Mapbox
        if (switcherElement) {
            mapContainer.appendChild(switcherElement);
            // R√©attacher les event listeners du switcher
            const modeNormalBtn = switcherElement.querySelector('#mode-normal');
            const modeRouteBtn = switcherElement.querySelector('#mode-route');
            if (modeNormalBtn && modeRouteBtn) {
                modeNormalBtn.addEventListener('click', () => switchMode('normal'));
                modeRouteBtn.addEventListener('click', () => switchMode('route'));
            }
        }
        if (legendElement) {
            mapContainer.appendChild(legendElement);
        }
        
        map.on('load', onMapLoad);
    }

    // Fonction pour ajouter les b√¢timents 3D et monuments
    function add3DBuildingsAndMonuments() {
        // Ajouter les b√¢timents 3D
        const layers = map.getStyle().layers;
        const labelLayerId = layers.find(
            (layer) => layer.type === 'symbol' && layer.layout['text-field']
        ).id;

        // Ajouter la couche des b√¢timents 3D
        map.addLayer({
            'id': '3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 15,
            'paint': {
                'fill-extrusion-color': '#aaa',
                'fill-extrusion-height': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    15,
                    0,
                    15.05,
                    ['get', 'height']
                ],
                'fill-extrusion-base': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    15,
                    0,
                    15.05,
                    ['get', 'min_height']
                ],
                'fill-extrusion-opacity': 0.6
            }
        }, labelLayerId);

        // Ajouter les monuments historiques (POI)
        map.addLayer({
            'id': 'monuments-3d',
            'source': 'composite',
            'source-layer': 'poi_label',
            'filter': [
                'all',
                ['==', ['get', 'class'], 'monument'],
                ['>=', ['zoom'], 16]
            ],
            'type': 'fill-extrusion',
            'paint': {
                'fill-extrusion-color': '#d4af37',
                'fill-extrusion-height': 20,
                'fill-extrusion-base': 0,
                'fill-extrusion-opacity': 0.8
            }
        }, labelLayerId);

        // Ajouter les symboles des monuments
        map.addLayer({
            'id': 'monuments-symbols',
            'type': 'symbol',
            'source': 'composite',
            'source-layer': 'poi_label',
            'filter': [
                'all',
                ['in', ['get', 'class'], ['literal', ['monument', 'landmark', 'place_of_worship']]]
            ],
            'minzoom': 14,
            'layout': {
                'icon-image': ['concat', ['get', 'maki'], '-15'],
                'icon-size': 1.2,
                'icon-allow-overlap': false,
                'text-field': ['get', 'name'],
                'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                'text-offset': [0, 1.5],
                'text-anchor': 'top',
                'text-size': 12
            },
            'paint': {
                'icon-opacity': 0.9,
                'text-color': '#d4af37',
                'text-halo-color': '#fff',
                'text-halo-width': 2
            }
        });

    }

    function onMapLoad() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
      
        if (typeof MapboxLanguage !== 'undefined') {
            const language = new MapboxLanguage({
                defaultLanguage: 'fr',
                excludedLayerIds: []
            });
            map.addControl(language);
            
            // Attendre que le style soit compl√®tement charg√© pour forcer le fran√ßais
            map.on('styledata', () => {
                const layers = map.getStyle().layers;
                layers.forEach(layer => {
                    if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                        // V√©rifier si le layer contient des labels de texte
                        if (layer.id.includes('label') || layer.id.includes('place')) {
                            try {
                                // Essayer de d√©finir le champ de texte en fran√ßais
                                const textField = ['coalesce',
                                    ['get', 'name_fr'],
                                    ['get', 'name:fr'],
                                    ['get', 'name']
                                ];
                                map.setLayoutProperty(layer.id, 'text-field', textField);
                            } catch (e) {
                                // Ignorer les erreurs pour les layers qui ne supportent pas cette propri√©t√©
                            }
                        }
                    }
                });
            });
        }
        map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512, 'maxzoom': 14 });
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
      
        // Ajouter les b√¢timents 3D
        add3DBuildingsAndMonuments();
      
        // Add establishments source with clustering
        map.addSource('establishments', {
            type: 'geojson',
            data: establishmentsData,
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 80,
            clusterMinPoints: 3  // Minimum 3 points pour former un cluster
        });
        
        // Load marker images first, then add layers
        loadMarkerImages(() => {
            addClusterLayers();
            setupClusterInteractions();
        });
      
        initializeGeocoder();
        initializeDirections();
        updateFilterOptions();
        setupEventListeners();
        initializeLayout();
        applyFilters();
        
        // Ajouter les √©v√©nements pour mise √† jour temps r√©el de la l√©gende
        setupMapViewportListeners();
        
        // Attendre que la carte soit compl√®tement charg√©e et rendue
        map.once('idle', () => {
            // Affichage initial des cartes et de la l√©gende
            updateSidebarBasedOnMapViewport();
            updateLegendCountsFromViewport();
        });
        
        // Fallback au cas o√π 'idle' ne se d√©clenche pas
        setTimeout(() => {
            updateSidebarBasedOnMapViewport();
            updateLegendCountsFromViewport();
        }, 1000);
    }

    function setupMapViewportListeners() {
        // Cr√©er une fonction debounced pour mettre √† jour la sidebar ET la l√©gende
        const debouncedViewportUpdate = debounce(() => {
            updateSidebarBasedOnMapViewport();
        }, 250); // R√©duit l√©g√®rement le d√©lai pour plus de r√©activit√©
        
        // √âcouter les mouvements de carte (pan)
        map.on('moveend', debouncedViewportUpdate);
        
        // √âcouter les changements de zoom
        map.on('zoomend', debouncedViewportUpdate);
        
        // √âcouter les changements de taille de fen√™tre
        map.on('resize', debouncedViewportUpdate);
        
    }

    function initializeGeocoder() {
       geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl,
            placeholder: 'Rechercher ville ou U.P.',
            countries: 'fr', localGeocoder: localUPGeocoder, localGeocoderOnly: false, language: 'fr'
       });
       document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));
       
       // Observer pour styliser les suggestions UP
       const observerConfig = { childList: true, subtree: true };
       const observerCallback = function(mutationsList) {
           for(let mutation of mutationsList) {
               if (mutation.addedNodes.length > 0) {
                   // Chercher les suggestions contenant [UP]
                   document.querySelectorAll('.mapboxgl-ctrl-geocoder--suggestion').forEach(suggestion => {
                       const title = suggestion.querySelector('.mapboxgl-ctrl-geocoder--suggestion-title');
                       if (title && title.textContent.includes('[UP]')) {
                           suggestion.classList.add('is-up');
                       }
                   });
               }
           }
       };
       const observer = new MutationObserver(observerCallback);
       observer.observe(document.body, observerConfig);
       // √âv√©nement principal 'result'
       geocoder.on('result', (e) => {
            currentSearchCenter = e.result.center || e.result.geometry.coordinates;
            // Point A s√©lectionn√© - afficher automatiquement le Point B
            showRouteInterface();
            showPointB();
            
            // Changer automatiquement le focus vers B pour le prochain double-clic
            setFocusOnPointB();
            
            // Mettre √† jour l'affichage
            if (e.result.properties && e.result.properties['Nom du site']) {
                updatePointADisplay(e.result.properties);
            } else {
                // Pour une adresse normale, afficher dans le bandeau
                const selectedPointA = document.getElementById('selected-point-a');
                const pointAName = document.getElementById('point-a-name');
                const geocoderContainer = document.getElementById('geocoder-container');
                const clearPointA = document.getElementById('clear-point-a');
                
                if (selectedPointA && pointAName) {
                    pointAName.textContent = e.result.place_name || e.result.text;
                    selectedPointA.style.display = 'block';
                    
                    // Cacher le geocoder
                    if (geocoderContainer) {
                        geocoderContainer.style.display = 'none';
                    }
                    
                    // Ajouter l'event listener sur la croix
                    if (clearPointA) {
                        clearPointA.addEventListener('click', clearPointASelection);
                    }
                }
            }
            
            // Afficher le contr√¥le de rayon et d√©finir √† 80 km
            showRadiusControl();
            
            // D√©finir le rayon √† 80 km
            currentSearchRadius = 80;
            const radiusSlider = document.getElementById('radius-slider');
            if (radiusSlider) radiusSlider.value = 80;
            const radiusValue = document.getElementById('radius-value');
            if (radiusValue) radiusValue.textContent = "80 km";
            
            // Dessiner le cercle de 80 km autour du point s√©lectionn√©
            drawSearchRadiusCircle(currentSearchCenter, 80);
            
            // Appliquer les filtres avec le rayon de 80 km
            applyFilters();
            
            if (e.result.properties && e.result.properties.UP) {
                map.flyTo({ center: e.result.center, zoom: 14, pitch: 45, essential: true });
            }
       });
       
       // Cr√©er le geocoder pour le Point B
       geocoderB = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl,
            placeholder: 'Rechercher ville ou U.P.',
            countries: 'fr', localGeocoder: localUPGeocoder, localGeocoderOnly: false, language: 'fr'
       });
       document.getElementById('geocoder-container-b').appendChild(geocoderB.onAdd(map));
       // √âv√©nement 'result' pour Point B
       geocoderB.on('result', (e) => {
            const newDestinationCoords = e.result.center || e.result.geometry.coordinates;
            
            // V√©rifier si les points ne sont pas identiques
            if (areCoordinatesIdentical(currentSearchCenter, newDestinationCoords)) {
                showIdenticalPointsWarning();
                geocoderB.clear();
                return;
            }
            
            destinationCoords = newDestinationCoords;
            // Mettre √† jour l'affichage
            if (e.result.properties && e.result.properties['Nom du site']) {
                updatePointBDisplay(e.result.properties);
            } else {
                // Pour une adresse normale
                const selectedPointB = document.getElementById('selected-point-b');
                const pointBName = document.getElementById('point-b-name');
                const geocoderContainerB = document.getElementById('geocoder-container-b');
                const clearPointB = document.getElementById('clear-point-b');
                
                if (selectedPointB && pointBName) {
                    pointBName.textContent = e.result.place_name || e.result.text;
                    selectedPointB.style.display = 'block';
                    
                    // Cacher le geocoder B
                    if (geocoderContainerB) {
                        geocoderContainerB.style.display = 'none';
                    }
                    
                    // Ajouter l'event listener sur la croix
                    if (clearPointB) {
                        clearPointB.addEventListener('click', clearPointBSelection);
                    }
                    
                    const pointBSection = document.getElementById('point-b-section');
                    if (pointBSection) {
                        pointBSection.style.borderColor = '#ffc107';
                        pointBSection.style.borderWidth = '2px';
                    }
                }
            }
            
            // Si A et B sont d√©finis, calculer automatiquement l'itin√©raire
            if (currentSearchCenter && destinationCoords) {
                setTimeout(() => {
                    showRouteOnMap(currentSearchCenter, destinationCoords);
                }, 500);
            } else {
            }
       });
       
       // √âv√©nements suppl√©mentaires pour debug
       geocoder.on('loading', (e) => {
       });
       
       geocoder.on('results', (e) => {
       });
       
       geocoder.on('error', (e) => {
       });
       
       // Nouvel √©v√©nement pour capturer les s√©lections (alternative)
       geocoder.on('response', (e) => {
       });
       
       geocoder.on('clear', () => {
            currentSearchCenter = null; 
            
            // Ne cacher l'interface de routage que si Point B n'est pas s√©lectionn√©
            if (!isPointBSelected()) {
                hideRouteInterface();
            }
            
            // Cacher le contr√¥le de rayon quand on efface la recherche
            hideRadiusControl();
            removeSearchRadiusCircle(); 
            applyFilters();
       });
       
       // Surveillance DOM en fallback pour capturer les clics sur les suggestions
       setupGeocoderDOMWatcher();
    }
    
    function setupGeocoderDOMWatcher() {
        // Surveiller les changements dans le container du geocoder
        setTimeout(() => {
            const geocoderContainer = document.querySelector('.mapboxgl-ctrl-geocoder');
            if (geocoderContainer) {
                // Surveiller les clics sur les suggestions
                geocoderContainer.addEventListener('click', (e) => {
                    // V√©rifier si c'est un clic sur une suggestion
                    const suggestion = e.target.closest('.mapboxgl-ctrl-geocoder--suggestion');
                    if (suggestion) {
                        // Attendre un peu pour que le geocoder traite le clic
                        setTimeout(() => {
                            const inputValue = geocoderContainer.querySelector('.mapboxgl-ctrl-geocoder--input').value;
                            // Si l'input contient quelque chose qui ressemble √† une UP, d√©clencher showRadiusControl
                            if (inputValue && inputValue.includes(',')) {
                                // Essayer de trouver les coordonn√©es depuis les donn√©es
                                const matchingUP = establishmentsData.features.find(f => 
                                    f.properties.UP && inputValue.includes(f.properties.UP)
                                );
                                if (matchingUP) {
                                    currentSearchCenter = matchingUP.geometry.coordinates;
                                    showRadiusControl();
                                    applyFilters();
                                }
                            }
                        }, 100);
                    }
                });
            } else {
                setTimeout(setupGeocoderDOMWatcher, 1000);
            }
        }, 500);
    }

    function initializeDirections() {
        // Initialiser le service Mapbox Directions
        directions = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            unit: 'metric',
            profile: 'mapbox/driving',
            controls: {
                inputs: false,
                instructions: false,
                profileSwitcher: false
            },
            interactive: false,
            flyTo: false // Emp√™cher le zoom automatique
        });
        
        // Ajouter le contr√¥le √† la carte
        map.addControl(directions, 'top-right');
        // Masquer seulement l'interface utilisateur, pas les routes
        setTimeout(() => {
            const directionsControl = document.querySelector('.mapbox-directions-component');
            if (directionsControl) {
                // Masquer seulement les inputs et contr√¥les, pas les routes
                const inputs = directionsControl.querySelector('.mapbox-directions-instructions');
                const inputContainer = directionsControl.querySelector('.mapbox-directions-inputs');
                
                if (inputs) inputs.style.display = 'none';
                if (inputContainer) inputContainer.style.display = 'none';
                
            }
        }, 100);
    }

    function showRouteOnMap(originCoords, destinationCoords) {
        if (!originCoords || !destinationCoords) {
            return;
        }
        
        // V√©rifier que les coordonn√©es sont valides
        if (!Array.isArray(originCoords) || !Array.isArray(destinationCoords)) {
            return;
        }
        
        // Nettoyer la route pr√©c√©dente
        clearCurrentRoute();
        
        // Approche alternative : utiliser directement l'API Directions
        showRouteWithDirectAPI(originCoords, destinationCoords);
    }
    
    async function showRouteWithDirectAPI(originCoords, destinationCoords) {
        const loader = showRouteLoader();
        
        try {
            // R√©cup√©rer les options s√©lectionn√©es depuis les boutons ULTRATHINK
            const vehicleType = currentVehicleType;
            const tollOption = currentTollOption;
            const optimizeOption = 'time'; // Toujours optimiser pour le temps
            
            // V√©rifier le cache d'abord
            const options = { vehicleType, tollOption, optimizeOption };
            const cacheKey = generateCacheKey(originCoords, destinationCoords, options);
            const cachedData = getCachedRoute(cacheKey);
            
            if (cachedData) {
                hideRouteLoader();
                processRouteData(cachedData);
                return;
            }
            
            // Validation des coordonn√©es
            if (!originCoords || !destinationCoords || originCoords.length !== 2 || destinationCoords.length !== 2) {
                throw new Error('Coordonn√©es invalides pour le calcul d\'itin√©raire');
            }
            
            // Construire l'URL de l'API Directions avec les options avanc√©es
            const coordinates = `${originCoords[0]},${originCoords[1]};${destinationCoords[0]},${destinationCoords[1]}`;
            
            // Profil de routage selon le v√©hicule
            let profile = 'driving';
            if (vehicleType === 'driving-traffic') {
                profile = 'driving-traffic'; // Pour les poids lourds avec info trafic
            }
            
            // Construction des param√®tres de l'URL
            let urlParams = new URLSearchParams({
                geometries: 'geojson',
                overview: 'full',
                steps: 'true',
                voice_instructions: 'true',
                annotations: 'duration,distance,speed',
                language: 'fr',
                access_token: mapboxgl.accessToken
            });
            
            // Ajouter l'√©vitement des p√©ages si s√©lectionn√©
            if (tollOption === 'avoid') {
                urlParams.append('exclude', 'toll');
            }
            
            // Ajouter l'optimisation
            if (optimizeOption === 'distance') {
                urlParams.append('annotations', 'duration,distance');
            }
            
            const url = `https://api.mapbox.com/directions/v5/mapbox/${profile}/${coordinates}?${urlParams}`;
            
            // Timeout pour l'API (r√©duit √† 10 secondes)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`Erreur API: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // V√©rifier si la r√©ponse contient des erreurs
            if (data.code && data.code !== 'Ok') {
                throw new Error(`API Error: ${data.code} - ${data.message || 'Erreur inconnue'}`);
            }
            
            // Mettre en cache pour les requ√™tes futures
            cacheRoute(cacheKey, data);
            
            hideRouteLoader();
            processRouteData(data);
            
        } catch (error) {
            hideRouteLoader();
            // Fallback : essayer avec l'API simple
            try {
                const fallbackUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordinates}?geometries=geojson&overview=full&steps=true&access_token=${mapboxgl.accessToken}`;
                
                const fallbackResponse = await fetch(fallbackUrl);
                const fallbackData = await fallbackResponse.json();
                
                if (fallbackData.routes && fallbackData.routes[0]) {
                    processRouteData(fallbackData);
                    return;
                }
            } catch (fallbackError) {
            }
            
            // Si les deux √©chouent, afficher l'erreur
            let errorMessage = 'Impossible de calculer l\'itin√©raire. Veuillez r√©essayer.';
            
            if (error.name === 'AbortError') {
                errorMessage = 'Le calcul d\'itin√©raire a pris trop de temps. Essai en cours avec options simplifi√©es...';
            } else if (error.message.includes('Erreur API')) {
                errorMessage = 'Service d\'itin√©raire temporairement indisponible. Veuillez r√©essayer dans quelques minutes.';
            } else if (error.message.includes('Coordonn√©es invalides')) {
                errorMessage = 'Les points s√©lectionn√©s ne sont pas valides. Veuillez s√©lectionner d\'autres emplacements.';
            }
            
            showRouteError(errorMessage);
        }
    }
    
    // Fonction factorisant le traitement des donn√©es de routage
    function processRouteData(data) {
        if (!data.routes || !data.routes[0]) {
            showRouteError('Aucun itin√©raire trouv√© entre ces deux points. Essayez avec d\'autres destinations.');
            return;
        }
        
        const route = data.routes[0];
        
        // Validation des donn√©es de route
        if (!route.geometry || !route.geometry.coordinates || route.geometry.coordinates.length === 0) {
            showRouteError('Donn√©es d\'itin√©raire invalides re√ßues du service.');
            return;
        }
        
        // Ajouter la route √† la carte comme source et layer
        addRouteToMap(route);
        
        // Centrer la carte sur la route
        try {
            const bounds = new mapboxgl.LngLatBounds();
            route.geometry.coordinates.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds, { padding: 50 });
        } catch (boundsError) {
        }
        
        // Mettre √† jour les temps de trajet avec les donn√©es r√©elles
        if (typeof updateTravelTimesWithRealData === 'function') {
            updateTravelTimesWithRealData(route);
        }
        
        // Mettre √† jour le r√©sum√© et afficher le panneau
        updateRouteSummary(data);
        showRouteDetails();
        
        // Ajouter le bouton pour nettoyer le trajet
        if (typeof addRouteClearButton === 'function') {
            addRouteClearButton();
        }
        
    }
    
    // Cache pour les itin√©raires
    const routeCache = new Map();
    const CACHE_EXPIRY = 30 * 60 * 1000; // 30 minutes
    
    // Fonction pour g√©n√©rer une cl√© de cache
    function generateCacheKey(originCoords, destinationCoords, options) {
        const { vehicleType, tollOption, optimizeOption } = options;
        return `${originCoords.join(',')}-${destinationCoords.join(',')}-${vehicleType}-${tollOption}-${optimizeOption}`;
    }
    
    // Fonction pour v√©rifier le cache
    function getCachedRoute(cacheKey) {
        const cached = routeCache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < CACHE_EXPIRY) {
            return cached.data;
        }
        if (cached) {
            routeCache.delete(cacheKey); // Supprimer l'entr√©e expir√©e
        }
        return null;
    }
    
    // Fonction pour mettre en cache un itin√©raire
    function cacheRoute(cacheKey, data) {
        routeCache.set(cacheKey, {
            data: data,
            timestamp: Date.now()
        });
    }
    
    // Fonction pour afficher les erreurs de routage
    function showRouteError(message) {
        const errorContainer = document.createElement('div');
        errorContainer.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(220, 53, 69, 0.3);
            z-index: 10000;
            font-family: Arial, sans-serif;
            text-align: center;
            max-width: 400px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        `;
        
        // Cr√©er les √©l√©ments sans innerHTML pour √©viter les probl√®mes d'iframe
        const errorIcon = document.createElement('div');
        errorIcon.style.fontSize = '24px';
        errorIcon.style.marginBottom = '10px';
        errorIcon.textContent = '[!]';
        
        const errorTitle = document.createElement('div');
        errorTitle.style.fontWeight = 'bold';
        errorTitle.style.marginBottom = '10px';
        errorTitle.textContent = 'Erreur de calcul d\'itin\u00E9raire';
        
        const errorMessage = document.createElement('div');
        errorMessage.style.marginBottom = '15px';
        errorMessage.style.lineHeight = '1.4';
        errorMessage.textContent = message;
        
        const closeButton = document.createElement('button');
        closeButton.textContent = 'Fermer';
        closeButton.style.cssText = 'background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;';
        closeButton.onclick = () => errorContainer.remove();
        
        errorContainer.appendChild(errorIcon);
        errorContainer.appendChild(errorTitle);
        errorContainer.appendChild(errorMessage);
        errorContainer.appendChild(closeButton);
        
        document.body.appendChild(errorContainer);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorContainer && errorContainer.parentElement) {
                errorContainer.remove();
            }
        }, 5000);
    }
    
    // Fonction pour afficher le loader
    function showRouteLoader() {
        const loader = document.createElement('div');
        loader.id = 'route-loader';
        loader.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            text-align: center;
            font-family: Arial, sans-serif;
            border: 1px solid rgba(0, 32, 96, 0.1);
        `;
        
        // Ajouter l'animation CSS si elle n'existe pas d√©j√†
        if (!document.getElementById('spin-animation-style')) {
            const styleElement = document.createElement('style');
            styleElement.id = 'spin-animation-style';
            styleElement.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
            document.head.appendChild(styleElement);
        }
        
        // Cr√©er les √©l√©ments du loader
        const spinner = document.createElement('div');
        spinner.style.cssText = 'width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #002060; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto;';
        
        const mainText = document.createElement('div');
        mainText.style.cssText = 'color: #002060; font-weight: bold; font-size: 16px;';
        mainText.textContent = 'Calcul de l\'itin\u00E9raire en cours...';
        
        const subText = document.createElement('div');
        subText.style.cssText = 'color: #666; font-size: 12px; margin-top: 5px;';
        subText.textContent = 'Veuillez patienter';
        
        loader.appendChild(spinner);
        loader.appendChild(mainText);
        loader.appendChild(subText);
        
        document.body.appendChild(loader);
        return loader;
    }
    
    // Fonction pour masquer le loader
    function hideRouteLoader() {
        const loader = document.getElementById('route-loader');
        if (loader) {
            loader.remove();
        }
    }
    
    // Fonction de nettoyage du cache (appel√©e p√©riodiquement)
    function cleanupCache() {
        const now = Date.now();
        for (const [key, value] of routeCache.entries()) {
            if (now - value.timestamp > CACHE_EXPIRY) {
                routeCache.delete(key);
            }
        }
    }
    
    // Nettoyer le cache toutes les 10 minutes
    setInterval(cleanupCache, 10 * 60 * 1000);
    
    // Fonction de validation des inputs utilisateur
    function validateRouteInputs() {
        const errors = [];
        
        if (!currentSearchCenter) {
            errors.push('Veuillez s√©lectionner un point de d√©part');
        }
        
        if (!destinationCoords) {
            errors.push('Veuillez s√©lectionner une destination');
        }
        
        if (currentSearchCenter && destinationCoords) {
            const distance = calculateDistance(currentSearchCenter, destinationCoords);
            if (distance < 0.1) { // Moins de 100m
                errors.push('Les points de d√©part et d\'arriv√©e sont trop proches');
            }
            if (distance > 1000) { // Plus de 1000km
                errors.push('La distance entre les points est trop importante');
            }
        }
        
        return errors;
    }
    
    // Fonction pour calculer la distance entre deux points (en km)
    function calculateDistance(coord1, coord2) {
        const R = 6371; // Rayon de la Terre en km
        const dLat = (coord2[1] - coord1[1]) * Math.PI / 180;
        const dLon = (coord2[0] - coord1[0]) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(coord1[1] * Math.PI / 180) * Math.cos(coord2[1] * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    // Fonction d'optimisation des performances
    function optimizePerformance() {
        // D√©sactiver les animations sur les appareils avec peu de m√©moire
        if (navigator.deviceMemory && navigator.deviceMemory < 4) {
            document.documentElement.style.setProperty('--animation-duration', '0.1s');
        }
        
        // R√©duire la complexit√© visuelle sur mobile
        if (window.innerWidth < 768) {
            const routeInstructions = document.querySelectorAll('.route-instruction-item');
            routeInstructions.forEach(item => {
                item.style.transition = 'none';
            });
        }
        
        // Nettoyer les event listeners inutiles
        window.addEventListener('beforeunload', () => {
            if (window.routeAnimation) {
                clearInterval(window.routeAnimation);
            }
            routeCache.clear();
        });
    }
    
    // Initialiser les optimisations au chargement
    document.addEventListener('DOMContentLoaded', optimizePerformance);
    
    function addRouteToMap(route) {
        // Supprimer la source existante si elle existe
        if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }
        
        // Ajouter la nouvelle route
        map.addSource('route', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': route.geometry
            }
        });
        
        map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#3887be',
                'line-width': 5,
                'line-opacity': 0.75
            }
        });
        
        currentRouteSource = 'route';
        isRouteMode = true; // Activer le mode itin√©raire
        
        // Masquer rayon et l√©gende quand itin√©raire affich√©
        hideRadiusControl();
        hideLegend();
        
        // Supprimer le cercle de rayon de la carte
        removeSearchRadiusCircle();
        
        // Centrer la carte sur l'itin√©raire avec fit bounds
        fitMapToRoute(route);
        
        // Afficher info route sur la carte
        showRouteInfoOnMap(route);
    }
    
    // Fonctions pour contr√¥ler la l√©gende
    function hideLegend() {
        const mapLegend = document.getElementById('map-legend');
        if (mapLegend) {
            mapLegend.style.display = 'none';
        }
    }
    
    function showLegend() {
        const mapLegend = document.getElementById('map-legend');
        if (mapLegend) {
            mapLegend.style.display = 'block';
        }
    }
    
    // Fonction pour centrer la carte sur l'itin√©raire avec zoom optimal sur les deux points
    function fitMapToRoute(route) {
        try {
            const coordinates = route.geometry.coordinates;
            const startPoint = coordinates[0];
            const endPoint = coordinates[coordinates.length - 1];
            const distance = route.distance / 1000; // distance en km
            
            // Cr√©er bounds uniquement avec les points de d√©part et d'arriv√©e pour zoom maximum
            const bounds = new mapboxgl.LngLatBounds()
                .extend(startPoint)
                .extend(endPoint);
            
            let maxZoom;
            let padding;
            
            // Zoom plus agressif avec padding minimal pour voir les deux points au maximum
            if (distance < 2) {
                maxZoom = 18;  // Tr√®s proche - zoom ultra-max
                padding = 10;
            } else if (distance < 5) {
                maxZoom = 17;  // Tr√®s proche - zoom tr√®s √©lev√©
                padding = 15;
            } else if (distance < 15) {
                maxZoom = 15;  // Distance courte - zoom √©lev√©
                padding = 20;
            } else if (distance < 40) {
                maxZoom = 13;  // Distance moyenne - zoom mod√©r√©-√©lev√©
                padding = 25;
            } else if (distance < 100) {
                maxZoom = 11;  // Distance longue - zoom mod√©r√©
                padding = 30;
            } else {
                maxZoom = 9;   // Tr√®s longue distance - zoom large
                padding = 40;
            }
            
            map.fitBounds(bounds, {
                padding: padding,
                maxZoom: maxZoom,
                duration: 1500,
                essential: true // Force l'animation m√™me si l'utilisateur interagit
            });
            
        } catch (error) {
        }
    }
    
    // Fonction pour afficher les infos de l'itin√©raire sur la carte
    function showRouteInfoOnMap(route) {
        // Supprimer l'info pr√©c√©dente si elle existe
        hideRouteInfoOnMap();
        
        const distance = (route.distance / 1000).toFixed(1);
        const durationHours = Math.floor(route.duration / 3600);
        const durationMinutes = Math.floor((route.duration % 3600) / 60);
        const durationText = durationHours > 0 ? `${durationHours}h ${durationMinutes}min` : `${durationMinutes}min`;
        
        const routeInfo = document.createElement('div');
        routeInfo.id = 'route-info-overlay';
        routeInfo.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 32, 96, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            z-index: 1002;
            animation: slideInFromRight 0.5s ease-out;
        `;
        
        // Cr√©er les √©l√©ments sans innerHTML pour √©viter les probl√®mes d'iframe
        const infoContainer = document.createElement('div');
        infoContainer.style.cssText = 'display: flex; align-items: center; gap: 8px;';
        
        const pinSpan = document.createElement('span');
        pinSpan.textContent = '[PIN]';
        
        const distanceSpan = document.createElement('span');
        distanceSpan.textContent = distance + ' km ‚Ä¢ ' + durationText;
        
        infoContainer.appendChild(pinSpan);
        infoContainer.appendChild(distanceSpan);
        routeInfo.appendChild(infoContainer);
        
        // Ajouter √† la carte
        document.getElementById('map').appendChild(routeInfo);
    }
    
    // Fonction pour masquer les infos de l'itin√©raire sur la carte
    function hideRouteInfoOnMap() {
        const routeInfo = document.getElementById('route-info-overlay');
        if (routeInfo) {
            routeInfo.remove();
        }
    }

    function clearCurrentRoute() {
        // R√©initialiser les donn√©es r√©elles de routage
        realRouteData = null;
        
        // Nettoyer la route du plugin Directions
        if (directions) {
            directions.removeRoutes();
        }
        
        // Nettoyer la route ajout√©e manuellement
        if (currentRouteSource === 'route' && map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }
        
        // Supprimer le marker de destination et nettoyer l'interface
        removeDestinationMarker();
        
        // Supprimer le bouton de nettoyage fixe s'il existe
        const clearBtn = document.getElementById('clear-route-btn');
        if (clearBtn) {
            clearBtn.remove();
        }
        
        currentRouteSource = null;
        isRouteMode = false; // D√©sactiver le mode itin√©raire
        
        // R√©activer la l√©gende et le rayon quand itin√©raire supprim√©
        showLegend();
        if (currentSearchCenter) {
            showRadiusControl();
            // Redessiner le cercle de rayon avec la valeur courante
            drawSearchRadiusCircle(currentSearchCenter, currentSearchRadius);
        }
        
        // Masquer les infos de route de la carte
        hideRouteInfoOnMap();
        
        // Rafra√Æchir les popups actifs pour mettre √† jour les boutons
        activePopups.forEach(popup => {
            try {
                const lngLat = popup.getLngLat();
                const popupElement = popup.getElement();
                if (popupElement && establishmentsData && establishmentsData.features) {
                    // Trouver les propri√©t√©s de l'√©tablissement bas√© sur les coordonn√©es
                    const feature = establishmentsData.features.find(f => 
                        Math.abs(f.geometry.coordinates[0] - lngLat.lng) < 0.0001 &&
                        Math.abs(f.geometry.coordinates[1] - lngLat.lat) < 0.0001
                    );
                    if (feature) {
                        const newPopup = createPopupContent(feature.properties, [lngLat.lng, lngLat.lat]);
                        const newPopupElement = newPopup.getElement();
                        if (newPopupElement && newPopupElement.firstChild) {
                            popup.setDOMContent(newPopupElement.firstChild);
                        }
                    }
                }
            } catch (error) {
            }
        });
        
        // Rafra√Æchir la barre lat√©rale pour mettre √† jour les boutons
        updateSidebarBasedOnMapViewport();
        
    }

    function updateTravelTimesWithRealData(route) {
        // V√©rifier que la route contient les donn√©es attendues
        if (!route || typeof route.duration === 'undefined' || typeof route.distance === 'undefined') {
            return;
        }
        
        // Extraire la dur√©e r√©elle du trajet depuis l'API (en secondes)
        const realDurationSeconds = route.duration;
        const realDistanceMeters = route.distance;
        
        // Convertir en format lisible
        const realTravelTime = formatDuration(realDurationSeconds);
        const realDistance = (realDistanceMeters / 1000).toFixed(1); // convertir en km
        
        // Stocker les donn√©es r√©elles pour une utilisation dans les popups
        realRouteData = {
            distance: realDistance,
            travelTime: realTravelTime,
            distanceMeters: realDistanceMeters,
            durationSeconds: realDurationSeconds
        };
        
        // Mettre √† jour les badges existants avec les donn√©es r√©elles
        const distanceBadges = document.querySelectorAll('.distance-badge');
        if (distanceBadges) {
            distanceBadges.forEach(badge => {
                if (badge && badge.textContent && badge.textContent.includes(' km')) {
                    badge.textContent = `${realDistance} km`;
                }
            });
        }
        
        const timeBadges = document.querySelectorAll('.time-badge');
        if (timeBadges) {
            timeBadges.forEach(badge => {
                if (badge) {
                    badge.textContent = realTravelTime;
                }
            });
        }
        
        // Rafra√Æchir la sidebar pour utiliser les nouvelles donn√©es r√©elles
        applyFilters();
    }

    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}min`;
        } else {
            return `${minutes} min`;
        }
    }

    function addRouteClearButton() {
        // Cette fonction ne cr√©e plus de bouton fixe car les boutons sont maintenant int√©gr√©s 
        // dans les popups et les cartes de la barre lat√©rale
        // Supprimer le bouton fixe existant s'il existe
        const existingBtn = document.getElementById('clear-route-btn');
        if (existingBtn) {
            existingBtn.remove();
        }
    }
    
    function updateFilterOptions() {
        const activityOptions = new Set();
        establishmentsData.features.forEach(feature => {
            if (feature.properties.activity) activityOptions.add(feature.properties.activity);
        });
    }
    
    function setupEventListeners() {
        // Les event listeners du contr√¥le de rayon seront ajout√©s dynamiquement
        // quand le contr√¥le devient visible

        document.getElementById('geolocate').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    currentSearchCenter = [position.coords.longitude, position.coords.latitude];
                    if (geocoder) geocoder.setInput('Ma position actuelle');
                    
                    // Afficher le contr√¥le de rayon et d√©finir √† 80 km
                    showRadiusControl();
                    currentSearchRadius = 80;
                    const radiusSlider = document.getElementById('radius-slider');
                    if (radiusSlider) radiusSlider.value = 80;
                    const radiusValue = document.getElementById('radius-value');
                    if (radiusValue) radiusValue.textContent = "80 km";
                    
                    // Dessiner le cercle de 80 km
                    drawSearchRadiusCircle(currentSearchCenter, 80);
                    
                    // Zoomer pour voir tout le rayon
                    map.flyTo({ center: currentSearchCenter, zoom: 9.5, duration: 1500 });
                    
                    showRouteInterface();
                    applyFilters();
                }, () => { alert("Impossible d'acc√©der √† votre position."); });
            } else { alert("La g√©olocalisation n'est pas support√©e par votre navigateur."); }
        });

        document.getElementById('reset-map').addEventListener('click', resetMap);
        
        // Initialiser les event listeners de la l√©gende interactive
        initializeLegendListeners();
        
        // Initialiser les event listeners de l'interface d'itin√©raire
        initializeRouteInterface();
        
        // Initialiser les contr√¥les de zoom personnalis√©s
        initializeCustomZoomControls();
        
        
        const modal = document.getElementById('modal');
        const closeButton = document.querySelector('.close-button');
        if (closeButton) { closeButton.addEventListener('click', () => modal.style.display = 'none'); }
        window.addEventListener('click', (event) => { if (event.target === modal) modal.style.display = 'none'; });
        window.addEventListener('resize', debounce(checkAndSetLayout, 300));
    }
    
    // Fonction pour initialiser les contr√¥les de zoom personnalis√©s
    function initializeCustomZoomControls() {
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        
        if (zoomInBtn && zoomOutBtn) {
            zoomInBtn.addEventListener('click', () => {
                if (map) {
                    map.zoomIn();
                }
            });
            
            zoomOutBtn.addEventListener('click', () => {
                if (map) {
                    map.zoomOut();
                }
            });
            
        } else {
        }
    }
    
    // Fonction pour initialiser les √©v√©nements de clic sur la l√©gende
    function initializeLegendListeners() {
        const legendItems = document.querySelectorAll('.legend-item');
        
        legendItems.forEach(item => {
            // Extraire le type d'activit√© du marker
            const marker = item.querySelector('.legend-marker');
            const activityType = marker.className.split(' ').find(cls => 
                cls === 'beton' || cls === 'granulats' || cls === 'ciment' || cls === 'ciment-prompt'
            );
            
            if (activityType) {
                item.addEventListener('click', () => {
                    toggleActivityFilter(activityType);
                });
                
                // Ajouter l'attribut pour l'accessibilit√©
                item.setAttribute('role', 'button');
                item.setAttribute('tabindex', '0');
                item.setAttribute('aria-pressed', 'true');
                
                // Support clavier
                item.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        toggleActivityFilter(activityType);
                    }
                });
            }
        });
    }
    
    // Fonction pour basculer un filtre d'activit√©
    function toggleActivityFilter(activityType) {
        // Si aucun filtre actif, on affiche tout
        // Si on clique sur une cat√©gorie :
        //   - Si elle est la seule active, on la d√©sactive (= afficher tout)
        //   - Si elle n'est pas active, on l'active
        //   - Si elle est active parmi d'autres, on la d√©sactive
        
        if (activeFilters.size === 0) {
            // Aucun filtre actif = tout est affich√©
            // On active seulement cette cat√©gorie
            activeFilters.add(activityType);
        } else if (activeFilters.has(activityType)) {
            // Cette cat√©gorie est active, on la d√©sactive
            activeFilters.delete(activityType);
        } else {
            // Cette cat√©gorie n'est pas active, on l'active
            activeFilters.add(activityType);
        }
        
        updateLegendVisualState();
        applyFilters();
    }
    
    // Fonction pour mettre √† jour l'√©tat visuel de la l√©gende
    function updateLegendVisualState() {
        const legendItems = document.querySelectorAll('.legend-item');
        
        legendItems.forEach(item => {
            const marker = item.querySelector('.legend-marker');
            const activityType = marker.className.split(' ').find(cls => 
                cls === 'beton' || cls === 'granulats' || cls === 'ciment' || cls === 'ciment-prompt'
            );
            
            if (activityType) {
                // Si aucun filtre actif, aucun item n'est marqu√© comme actif visuellement
                // Sinon, on marque comme inactif ceux qui ne sont pas dans activeFilters
                const isActive = activeFilters.size === 0 ? false : activeFilters.has(activityType);
                item.classList.toggle('inactive', activeFilters.size > 0 && !isActive);
                item.setAttribute('aria-pressed', isActive.toString());
            }
        });
    }
    
    // Fonctions pour l'interface d'itin√©raire am√©lior√©e
    function showRouteInterface() {
        // Ne plus afficher automatiquement le Point B - seulement s'assurer que le Point A est visible
        // Le Point A est toujours visible maintenant
    }
    
    function showPointB() {
        const pointBSection = document.getElementById('point-b-section');
        const addBtn = document.getElementById('add-destination-btn');
        if (pointBSection && addBtn) {
            pointBSection.style.display = 'block';
            addBtn.textContent = '‚àí';
            addBtn.title = 'Masquer la destination';
        }
    }
    
    function hidePointB() {
        const pointBSection = document.getElementById('point-b-section');
        const addBtn = document.getElementById('add-destination-btn');
        if (pointBSection && addBtn) {
            pointBSection.style.display = 'none';
            addBtn.textContent = '+';
            addBtn.title = 'Ajouter une destination';
            // Reset destination data
            destinationCoords = null;
            clearPointBDisplay();
            // R√©initialiser le geocoder B
            if (geocoderB) {
                geocoderB.clear();
            }
            removeDestinationMarker();
        }
    }
    
    function togglePointB() {
        const pointBSection = document.getElementById('point-b-section');
        if (pointBSection) {
            if (pointBSection.style.display === 'none' || pointBSection.style.display === '') {
                showPointB();
            } else {
                hidePointB();
                // Clear route if it exists
                clearRoute();
            }
        }
    }
    
    function hideRouteInterface() {
        // Reset everything to initial state
        hidePointB();
        destinationCoords = null;
        routeMode = false;
    }
    
    // Fonctions pour masquer/afficher les cartes d'√©tablissements
    function hideEstablishmentCards() {
        const establishmentsView = document.getElementById('establishments-view');
        const resultsCount = document.getElementById('results-count');
        const resetMapBtn = document.getElementById('reset-map');
        
        if (establishmentsView) {
            establishmentsView.classList.add('hide-establishments');
            establishmentsView.classList.remove('show-establishments');
        }
        
        if (resultsCount) {
            resultsCount.style.display = 'none';
        }
        
        if (resetMapBtn) {
            resetMapBtn.style.display = 'none';
        }
        
    }
    
    function showEstablishmentCards() {
        const establishmentsView = document.getElementById('establishments-view');
        const resultsCount = document.getElementById('results-count');
        const resetMapBtn = document.getElementById('reset-map');
        
        if (establishmentsView) {
            establishmentsView.classList.remove('hide-establishments');
            establishmentsView.classList.add('show-establishments');
        }
        
        if (resultsCount) {
            resultsCount.style.display = 'block';
        }
        
        if (resetMapBtn) {
            resetMapBtn.style.display = 'block';
        }
        
    }
    
    function showRouteDetails() {
        const routeDetailsPanel = document.getElementById('route-details-panel');
        const establishmentsView = document.getElementById('establishments-view');
        
        if (routeDetailsPanel) {
            routeDetailsPanel.style.display = 'block';
            routeDetailsPanel.classList.add('route-active');
        }
        
        hideEstablishmentCards();
        activateRouteMode();
        
    }
    
    function hideRouteDetails() {
        const routeDetailsPanel = document.getElementById('route-details-panel');
        
        if (routeDetailsPanel) {
            routeDetailsPanel.style.display = 'none';
            routeDetailsPanel.classList.remove('route-active');
        }
        
        showEstablishmentCards();
        deactivateRouteMode();
        
    }
    
    // Mode visuel avanc√© pour l'itin√©raire
    function activateRouteMode() {
        const mapContainer = document.getElementById('map-container');
        if (mapContainer) {
            mapContainer.classList.add('route-mode-active');
            
            // Animation fluide avec d√©lai
            setTimeout(() => {
                if (map) {
                    map.resize(); // Redimensionner la carte
                }
            }, 500);
        }
        
        // Ajout d'effets visuels sur la route
        addRouteVisualEffects();
        
    }
    
    function deactivateRouteMode() {
        const mapContainer = document.getElementById('map-container');
        if (mapContainer) {
            mapContainer.classList.remove('route-mode-active');
            
            // Animation fluide avec d√©lai
            setTimeout(() => {
                if (map) {
                    map.resize(); // Redimensionner la carte
                }
            }, 500);
        }
        
        removeRouteVisualEffects();
        
    }
    
    // Effets visuels avanc√©s pour la route
    function addRouteVisualEffects() {
        if (!map || !map.getLayer('route')) return;
        
        // Ajouter l'animation de pulsation √† la route
        try {
            map.setPaintProperty('route', 'line-opacity', 0.9);
            map.setPaintProperty('route', 'line-width', [
                'interpolate',
                ['linear'],
                ['zoom'],
                10, 6,
                18, 12
            ]);
            
            // Animation de la route (effet de pulsation)
            let opacity = 0.7;
            let direction = 1;
            
            const routeAnimation = setInterval(() => {
                if (!map || !map.getLayer('route')) {
                    clearInterval(routeAnimation);
                    return;
                }
                
                opacity += direction * 0.05;
                if (opacity >= 1 || opacity <= 0.7) {
                    direction *= -1;
                }
                
                try {
                    map.setPaintProperty('route', 'line-opacity', opacity);
                } catch (e) {
                    clearInterval(routeAnimation);
                }
            }, 100);
            
            // Stocker l'animation pour pouvoir l'arr√™ter
            window.routeAnimation = routeAnimation;
            
        } catch (error) {
        }
    }
    
    function removeRouteVisualEffects() {
        // Arr√™ter l'animation
        if (window.routeAnimation) {
            clearInterval(window.routeAnimation);
            window.routeAnimation = null;
        }
        
        // Restaurer les propri√©t√©s de la route
        try {
            if (map && map.getLayer('route')) {
                map.setPaintProperty('route', 'line-opacity', 0.8);
                map.setPaintProperty('route', 'line-width', 5);
            }
        } catch (error) {
        }
    }
    
    // Fonction pour mettre √† jour uniquement le r√©sum√© de l'itin√©raire
    function updateRouteSummary(routeData) {
        const routeDistance = document.getElementById('route-distance');
        const routeDuration = document.getElementById('route-duration');
        const routeVehicleInfo = document.getElementById('route-vehicle-info');
        
        if (!routeData || !routeData.routes || !routeData.routes[0]) {
            return;
        }
        
        const route = routeData.routes[0];
        
        // Mise √† jour du r√©sum√©
        const totalDistance = (route.distance / 1000).toFixed(1);
        const totalDurationHours = Math.floor(route.duration / 3600);
        const totalDurationMinutes = Math.floor((route.duration % 3600) / 60);
        
        routeDistance.textContent = `${totalDistance} km`;
        routeDuration.textContent = `${totalDurationHours}h ${totalDurationMinutes}min`;
        
        // Mise √† jour des infos v√©hicule
        const vehicleText = currentVehicleType === 'driving-traffic' ? 'Poids lourd' : 'Voiture';
        const tollText = currentTollOption === 'avoid' ? 'P√©ages √©vit√©s' : 'P√©ages autoris√©s';
        routeVehicleInfo.textContent = `Type: ${vehicleText} ‚Ä¢ ${tollText}`;
        
    }
    
    function initializeRouteInterface() {
        const addDestinationBtn = document.getElementById('add-destination-btn');
        const clearRouteBtn = document.getElementById('clear-route-btn');
        const pointASection = document.getElementById('point-a-section');
        const pointBSection = document.getElementById('point-b-section');
        
        // Initialiser les switchers de routage
        initializeRouteSwitchers();
        
        // Event listeners pour tracker le focus
        if (pointASection) {
            pointASection.addEventListener('click', () => {
                setFocusOnPointA();
            });
        }
        
        if (pointBSection) {
            pointBSection.addEventListener('click', () => {
                setFocusOnPointB();
            });
        }
        
        // Bouton pour expand/collapse le Point B
        if (addDestinationBtn) {
            addDestinationBtn.addEventListener('click', () => {
                togglePointB();
            });
        }
        
        // Plus besoin de bouton calculer - c'est automatique avec les boutons d'options
        
        // Effacer l'itin√©raire
        if (clearRouteBtn) {
            clearRouteBtn.addEventListener('click', () => {
                clearCurrentRoute();
                destinationCoords = null;
                clearPointBDisplay();
                // R√©initialiser le geocoder B
                if (geocoderB) {
                    geocoderB.clear();
                }
                hidePointB(); // Masquer le Point B apr√®s effacement
                hideRouteDetails(); // Masquer le panneau de d√©tails
            });
        }
        
        // Bouton retour √† la recherche
        const backToSearchBtn = document.getElementById('back-to-search-btn');
        if (backToSearchBtn) {
            backToSearchBtn.addEventListener('click', () => {
                hideRouteDetails();
                clearCurrentRoute();
            });
        }
        
    }
    
    // Variables pour les options de routage actuelles
    let currentVehicleType = 'driving';
    let currentTollOption = 'allow';
    
    // Initialiser les switchers de routage
    function initializeRouteSwitchers() {
        // Switcher v√©hicule
        const vehicleCar = document.getElementById('vehicle-car');
        const vehicleTruck = document.getElementById('vehicle-truck');
        
        if (vehicleCar && vehicleTruck) {
            vehicleCar.addEventListener('click', () => {
                vehicleCar.classList.add('active');
                vehicleTruck.classList.remove('active');
                vehicleCar.style.background = '#007bff';
                vehicleCar.style.color = 'white';
                vehicleTruck.style.background = 'transparent';
                vehicleTruck.style.color = '#6c757d';
                
                currentVehicleType = 'driving';
                recalculateRoute();
            });
            
            vehicleTruck.addEventListener('click', () => {
                vehicleTruck.classList.add('active');
                vehicleCar.classList.remove('active');
                vehicleTruck.style.background = '#ffc107';
                vehicleTruck.style.color = 'white';
                vehicleCar.style.background = 'transparent';
                vehicleCar.style.color = '#6c757d';
                
                currentVehicleType = 'driving-traffic';
                recalculateRoute();
            });
        }
        
        // Switcher p√©ages
        const tollAllow = document.getElementById('toll-allow');
        const tollAvoid = document.getElementById('toll-avoid');
        
        if (tollAllow && tollAvoid) {
            tollAllow.addEventListener('click', () => {
                tollAllow.classList.add('active');
                tollAvoid.classList.remove('active');
                tollAllow.style.background = '#28a745';
                tollAllow.style.color = 'white';
                tollAvoid.style.background = 'transparent';
                tollAvoid.style.color = '#6c757d';
                
                currentTollOption = 'allow';
                recalculateRoute();
            });
            
            tollAvoid.addEventListener('click', () => {
                tollAvoid.classList.add('active');
                tollAllow.classList.remove('active');
                tollAvoid.style.background = '#dc3545';
                tollAvoid.style.color = 'white';
                tollAllow.style.background = 'transparent';
                tollAllow.style.color = '#6c757d';
                
                currentTollOption = 'avoid';
                recalculateRoute();
            });
        }
        
        // Toggle pour les options de routage (molette)
        const toggleBtn = document.getElementById('toggle-route-options');
        const optionsContainer = document.getElementById('route-options-container');
        
        if (toggleBtn && optionsContainer) {
            toggleBtn.addEventListener('click', () => {
                const isHidden = optionsContainer.style.display === 'none';
                
                if (isHidden) {
                    optionsContainer.style.display = 'block';
                    optionsContainer.style.opacity = '0';
                    optionsContainer.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        optionsContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        optionsContainer.style.opacity = '1';
                        optionsContainer.style.transform = 'translateY(0)';
                    }, 10);
                    
                    toggleBtn.style.background = 'rgba(255,255,255,0.3)';
                    toggleBtn.title = 'Masquer les options';
                } else {
                    optionsContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    optionsContainer.style.opacity = '0';
                    optionsContainer.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        optionsContainer.style.display = 'none';
                    }, 300);
                    
                    toggleBtn.style.background = 'rgba(255,255,255,0.2)';
                    toggleBtn.title = 'Options de routage';
                }
            });
            
            // Effet hover sur la molette
            toggleBtn.addEventListener('mouseenter', () => {
                toggleBtn.style.background = 'rgba(255,255,255,0.3)';
                toggleBtn.style.transform = 'scale(1.1)';
            });
            
            toggleBtn.addEventListener('mouseleave', () => {
                const isOptionsVisible = optionsContainer.style.display !== 'none';
                toggleBtn.style.background = isOptionsVisible ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.2)';
                toggleBtn.style.transform = 'scale(1)';
            });
        }
    }
    
    // Auto-recalcul quand les options changent
    function recalculateRoute() {
        if (currentSearchCenter && destinationCoords) {
            showRouteOnMap(currentSearchCenter, destinationCoords);
        }
    }
    
    async function searchDestination() {
        const destinationInput = document.getElementById('destination-input');
        const query = destinationInput.value.trim();
        
        if (!query) {
            alert('Veuillez saisir une adresse de destination.');
            return;
        }
        
        try {
            const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?country=fr&access_token=${mapboxgl.accessToken}`);
            const data = await response.json();
            
            if (data.features && data.features.length > 0) {
                const feature = data.features[0];
                destinationCoords = feature.center;
                
                // Mettre √† jour le placeholder avec le lieu trouv√©
                destinationInput.value = feature.place_name;
                
                // Ajouter un marker temporaire pour la destination
                addDestinationMarker(destinationCoords);
                
                // Zoomer sur la destination
                map.flyTo({ 
                    center: destinationCoords, 
                    zoom: 12, 
                    essential: true 
                });
            } else {
                alert('Aucun r√©sultat trouv√© pour cette adresse.');
            }
        } catch (error) {
            alert('Erreur lors de la recherche. Veuillez r√©essayer.');
        }
    }
    
    function addDestinationMarker(coords) {
        // Supprimer l'ancien marker de destination s'il existe
        removeDestinationMarker();
        
        // Cr√©er un nouveau marker pour la destination
        const marker = new mapboxgl.Marker({ 
            color: '#ff0000',
            scale: 1.2
        })
        .setLngLat(coords)
        .addTo(map);
        
        // Stocker le marker pour pouvoir le supprimer plus tard
        window.destinationMarker = marker;
    }
    
    function removeDestinationMarker() {
        if (window.destinationMarker) {
            window.destinationMarker.remove();
            window.destinationMarker = null;
        }
    }
    
    // Fonctions pour contr√¥ler l'affichage du s√©lecteur de rayon
    function showRadiusControl() {
        let radiusControl = document.getElementById('map-radius-control-overlay');
        
        if (!radiusControl) {
            // Cr√©er l'√©l√©ment dynamiquement
            radiusControl = document.createElement('div');
            radiusControl.id = 'map-radius-control-overlay';
            radiusControl.className = 'map-radius-control';
            radiusControl.style.cssText = 'position:absolute;bottom:220px;left:10px;background:#fff;padding:12px 15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:1001;font-size:13px;display:block;';
            
            // Cr√©er le contenu sans innerHTML pour √©viter les probl√®mes d'iframe
            const h4 = document.createElement('h4');
            h4.style.cssText = 'margin:0 0 8px 0;font-size:14px;color:#333;font-weight:bold;';
            h4.textContent = 'Rayon de recherche';
            
            const controlDiv = document.createElement('div');
            controlDiv.style.cssText = 'display:flex;align-items:center;gap:10px;';
            
            const label = document.createElement('label');
            label.style.cssText = 'font-size:13px;color:#333;white-space:nowrap;';
            label.textContent = 'Rayon:';
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = 'radius-slider';
            slider.value = '80';
            slider.min = '1';
            slider.max = '200';
            slider.step = '1';
            slider.style.cssText = 'flex:1;min-width:120px;';
            
            const valueSpan = document.createElement('span');
            valueSpan.id = 'radius-value';
            valueSpan.style.cssText = 'font-weight:bold;color:#002060;min-width:50px;font-size:13px;';
            valueSpan.textContent = '80 km';
            
            controlDiv.appendChild(label);
            controlDiv.appendChild(slider);
            controlDiv.appendChild(valueSpan);
            
            radiusControl.appendChild(h4);
            radiusControl.appendChild(controlDiv);
            
            // Ajouter √† la carte
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.appendChild(radiusControl);
            } else {
                return;
            }
        } else {
            radiusControl.style.display = 'block';
        }
        
        // Ajouter les event listeners maintenant que l'√©l√©ment est visible
        initializeRadiusControlListeners();
    }
    
    // Variable pour √©viter d'ajouter les listeners plusieurs fois
    let radiusControlListenersInitialized = false;
    
    function initializeRadiusControlListeners() {
        if (radiusControlListenersInitialized) return;
        
        const radiusSlider = document.getElementById('radius-slider');
        const radiusValue = document.getElementById('radius-value');
        
        if (radiusSlider && radiusValue) {
            radiusSlider.addEventListener('input', () => {
                radiusValue.textContent = `${radiusSlider.value} km`;
            });
            
            radiusSlider.addEventListener('change', debounce(() => {
                if (currentSearchCenter) { applyFilters(); }
            }, 300));
            
            radiusControlListenersInitialized = true;
        } else {
        }
    }
    
    function hideRadiusControl() {
        const radiusControl = document.getElementById('map-radius-control-overlay');
        if (radiusControl) {
            radiusControl.style.display = 'none';
        } else {
        }
    }
    
    function applyFilters() {
        const radiusSlider = document.getElementById('radius-slider');
        currentSearchRadius = radiusSlider ? parseInt(radiusSlider.value, 10) : 80;

        if (currentSearchCenter) {
            drawSearchRadiusCircle(currentSearchCenter, currentSearchRadius);
        }

        let featuresToDisplay = [...establishmentsData.features];
        
        // Filtrer par activit√© selon la l√©gende interactive
        // Si aucun filtre n'est actif, afficher tout
        if (activeFilters.size > 0) {
            featuresToDisplay = featuresToDisplay.filter(feature => {
                const activityType = getActivityType(feature.properties.activity);
                // Pour ciment, il faut g√©rer aussi ciment-prompt
                if (activityType === 'ciment-prompt' && activeFilters.has('ciment')) {
                    return false; // Ne pas afficher ciment-prompt si on veut seulement ciment
                }
                return activeFilters.has(activityType);
            });
        }
        
        // Filtrer par distance si un centre de recherche est d√©fini
        if (currentSearchCenter && !isNaN(currentSearchRadius) && currentSearchRadius > 0) {
            featuresToDisplay = featuresToDisplay.filter(feature => {
                if (!feature.geometry || !feature.geometry.coordinates) return false;
                const distance = getDistanceFromLatLonInKm(currentSearchCenter[1], currentSearchCenter[0], feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
                return distance <= currentSearchRadius;
            });
        }
        
        
        primaryFilteredFeatures = featuresToDisplay;
        
        // Mettre √† jour la source avec les donn√©es filtr√©es
        updateEstablishmentsSource(featuresToDisplay);
        adjustMapView(primaryFilteredFeatures);
        // Le compteur est maintenant mis √† jour dans updateSidebarCards() pour refl√©ter les √©tablissements visibles
    }

    function adjustMapView(features) {
        if (features.length === 1 && currentSearchCenter) {
            map.flyTo({ center: features[0].geometry.coordinates, zoom: 10, essential: true });
        } else if (features.length === 0 && currentSearchCenter) {
            map.flyTo({ center: currentSearchCenter, zoom: 9, essential: true });
        } else if (features.length > 1) {
            const bounds = new mapboxgl.LngLatBounds();
            features.forEach(feature => {
                if (feature.geometry && feature.geometry.coordinates) { bounds.extend(feature.geometry.coordinates); }
            });
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds, { padding: 70, maxZoom: 15, duration: 500 });
            }
        } else if (features.length === 0 && !currentSearchCenter) {
            map.flyTo({ center: [2.2137, 46.2276], zoom: 5, pitch: 0, bearing: 0 });
        }
        setTimeout(updateSidebarBasedOnMapViewport, 100);
    }
    
    function resetMap() {
        
        const radiusSlider = document.getElementById('radius-slider');
        if (radiusSlider) radiusSlider.value = 80;
        
        const radiusValue = document.getElementById('radius-value');
        if (radiusValue) radiusValue.textContent = "80 km";
        
        // R√©initialiser toutes les variables d'√©tat
        currentSearchCenter = null;
        currentSearchRadius = 80;
        destinationCoords = null;
        currentFocusedInput = 'A'; // Remettre le focus sur A
        currentPointAFeature = null;
        currentPointBFeature = null;
        
        removeSearchRadiusCircle();
        clearPointADisplay();
        clearCurrentRoute(); // Effacer la route trac√©e
        
        // Fermer tous les popups ouverts
        activePopups.forEach(p => p.remove());
        activePopups.length = 0;
        
        // Supprimer le marker de g√©olocalisation s'il existe
        if (userLocationMarker) {
            userLocationMarker.remove();
            userLocationMarker = null;
        }
        
        // R√©initialiser les filtres de l√©gende (aucun filtre = tout affich√©)
        activeFilters.clear();
        updateLegendVisualState();
        
        // R√©initialiser l'interface d'itin√©raire
        hideRouteInterface();
        removeDestinationMarker();
        const destinationInput = document.getElementById('destination-input');
        if (destinationInput) destinationInput.value = '';
        
        // Cacher le contr√¥le de rayon
        hideRadiusControl();
        
        // Vider les geocoders
        if (geocoder && typeof geocoder.clear === 'function') { geocoder.clear(); }
        if (geocoderB && typeof geocoderB.clear === 'function') { geocoderB.clear(); }
        if (window.normalGeocoder && typeof window.normalGeocoder.clear === 'function') { 
            window.normalGeocoder.clear(); 
        }
        
        checkAndSetLayout();
        map.flyTo({ center: [2.2137, 46.2276], zoom: 5, pitch: 0, bearing: 0, essential: true });
        setTimeout(applyFilters, 100);
    }

    function createMarkerElement(activity) {
      let el;
      
      // Fonction pour cr√©er un marqueur color√© de fallback
      function createColoredMarker(color) {
        const marker = document.createElement('div');
        marker.style.width = '24px';
        marker.style.height = '24px';
        marker.style.borderRadius = '50%';
        marker.style.border = '3px solid white';
        marker.style.boxShadow = '0 2px 4px rgba(0,0,0,0.4)';
        marker.style.cursor = 'pointer';
        marker.style.backgroundColor = color;
        
        // Ajouter un effet de hover
        marker.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.2)';
          this.style.transition = 'transform 0.2s';
        });
        
        marker.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1)';
        });
        
        return marker;
      }
      
      // Essayer d'utiliser les images d'abord
      if (activity === "beton") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-beton.png';
        el.onerror = function() {
          // Si l'image ne charge pas, utiliser un marqueur color√©
          const fallback = createColoredMarker('#FF6B6B');
          this.parentNode.replaceChild(fallback, this);
        };
      } else if (activity === "granulats") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-granulats.png';
        el.onerror = function() {
          const fallback = createColoredMarker('#4ECDC4');
          this.parentNode.replaceChild(fallback, this);
        };
      } else if (activity === "ciment-prompt") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-12/ciment-prompt-naturel.png';
        el.onerror = function() {
          const fallback = createColoredMarker('#45B7D1');
          this.parentNode.replaceChild(fallback, this);
        };
      } else if (activity === "ciment") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-ciment.png';
        el.onerror = function() {
          const fallback = createColoredMarker('#002060');
          this.parentNode.replaceChild(fallback, this);
        };
      } else {
        // Pour les autres activit√©s, utiliser directement un marqueur color√©
        el = createColoredMarker('#95A5A6');
      }
      
      // Si c'est une image, d√©finir les styles appropri√©s
      if (el.tagName === 'IMG') {
        el.style.width = '30px';
        el.style.height = '30px';
        el.style.cursor = 'pointer';
      }
      
      return el;
    }

    function createPopupContent(props, coordinates = null) {
        const name = decodeHTMLEntities(props.UP||'N/A');
        const address = decodeHTMLEntities(props.Adresse||'N/A');
        const city = decodeHTMLEntities(props.Ville||'');
        const postalCode = props["Code postal"]||'';
        const phone = props.Phone&&props.Phone!=="null"?props.Phone:null;
        const email = props.Email&&props.Email!=="null"?props.Email:null;
        
        let distanceInfo = '';
        if (currentSearchCenter && coordinates) {
            let distance, travelTime;
            
            // Utiliser les donn√©es r√©elles de routage si disponibles, sinon calcul √† vol d'oiseau
            if (realRouteData) {
                distance = parseFloat(realRouteData.distance);
                travelTime = realRouteData.travelTime;
            } else {
                distance = getDistanceFromLatLonInKm(
                    currentSearchCenter[1], currentSearchCenter[0],
                    coordinates[1], coordinates[0]
                );
                travelTime = calculateTravelTime(distance);
            }
            
            // Ne pas afficher les badges si distance = 0 ou temps = "0 min"
            const distanceValue = distance.toFixed ? distance.toFixed(1) : distance;
            if (parseFloat(distanceValue) > 0 && travelTime !== "0 min") {
                distanceInfo = `<p><strong>Distance:</strong> <span class="distance-badge">${distanceValue} km</span> <span class="time-badge">${travelTime}</span></p>`;
            }
        }
        
        // Cr√©er le popup avec DOM uniquement (√©vite tous probl√®mes de syntaxe)
        const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '300px' });
        
        // Cr√©er le contenu avec DOM pour √©viter les probl√®mes de balises
        const popupDiv = document.createElement('div');
        
        // Titre
        const title = document.createElement('h3');
        title.textContent = name;
        popupDiv.appendChild(title);
        
        // Adresse
        const addressP = document.createElement('p');
        const addressStrong = document.createElement('strong');
        addressStrong.textContent = 'Adresse: ';
        addressP.appendChild(addressStrong);
        addressP.appendChild(document.createTextNode(address));
        addressP.appendChild(document.createElement('br'));
        addressP.appendChild(document.createTextNode(city + ' ' + postalCode));
        popupDiv.appendChild(addressP);
        
        // Distance (si disponible)
        if (currentSearchCenter && coordinates) {
            let distance, travelTime;
            
            // Utiliser les donn√©es r√©elles de routage si disponibles, sinon calcul √† vol d'oiseau
            if (realRouteData) {
                distance = parseFloat(realRouteData.distance);
                travelTime = realRouteData.travelTime;
            } else {
                distance = getDistanceFromLatLonInKm(
                    currentSearchCenter[1], currentSearchCenter[0],
                    coordinates[1], coordinates[0]
                );
                travelTime = calculateTravelTime(distance);
            }
            
            // Arrondir la distance pour les popups aussi
            let distanceDisplay;
            if (isDestination && realRouteData) {
                distanceDisplay = distance.toFixed(1) + ' km';
            } else {
                if (distance < 10) {
                    distanceDisplay = '~' + Math.round(distance) + ' km';
                } else if (distance < 50) {
                    distanceDisplay = '~' + (Math.round(distance / 5) * 5) + ' km';
                } else {
                    distanceDisplay = '~' + (Math.round(distance / 10) * 10) + ' km';
                }
            }
            
            if (distance > 0 && travelTime !== "0 min") {
                const distanceP = document.createElement('p');
                const distanceStrong = document.createElement('strong');
                distanceStrong.textContent = 'Distance: ';
                distanceP.appendChild(distanceStrong);
                
                const distanceBadge = document.createElement('span');
                distanceBadge.className = 'distance-badge';
                distanceBadge.textContent = distanceDisplay;
                distanceBadge.title = (isDestination && realRouteData) ? 
                    'Distance r√©elle par la route' : 
                    'Distance approximative √† vol d\'oiseau';
                distanceP.appendChild(distanceBadge);
                
                const timeBadge = document.createElement('span');
                timeBadge.className = 'time-badge';
                timeBadge.textContent = travelTime;
                timeBadge.title = (isDestination && realRouteData) ? 
                    'Temps de trajet r√©el' : 
                    'Estimation du temps de trajet';
                distanceP.appendChild(timeBadge);
                
                popupDiv.appendChild(distanceP);
            }
        }
        
        // T√©l√©phone
        const phoneP = document.createElement('p');
        const phoneStrong = document.createElement('strong');
        phoneStrong.textContent = 'T\u00E9l\u00E9phone: ';
        phoneP.appendChild(phoneStrong);
        if (phone) {
            const phoneLink = document.createElement('a');
            phoneLink.href = 'tel:' + phone;
            phoneLink.textContent = phone;
            phoneP.appendChild(phoneLink);
        } else {
            phoneP.appendChild(document.createTextNode('Non disponible'));
        }
        popupDiv.appendChild(phoneP);
        
        // Email
        const emailP = document.createElement('p');
        const emailStrong = document.createElement('strong');
        emailStrong.textContent = 'Email: ';
        emailP.appendChild(emailStrong);
        if (email) {
            const emailLink = document.createElement('a');
            emailLink.href = 'mailto:' + email;
            emailLink.textContent = email;
            emailP.appendChild(emailLink);
        } else {
            emailP.appendChild(document.createTextNode('Non disponible'));
        }
        popupDiv.appendChild(emailP);
        
        // Ajout du bouton appropri√© selon le contexte
        const currentZoom = map.getZoom();
        const currentPitch = map.getPitch();
        const mapCenter = map.getCenter();
        
        // Calculer la distance entre le centre de la carte et cette UP
        const centerDistance = turf.distance(
            turf.point([mapCenter.lng, mapCenter.lat]),
            turf.point(coordinates),
            { units: 'kilometers' }
        );
        
        // D√©terminer si on est en vue "zoom√©e" sur cette UP
        // Inclure aussi si on est en train de zoomer vers cette UP
        const isCurrentlyZoomingHere = zoomingToCoordinates && 
            Math.abs(zoomingToCoordinates[0] - coordinates[0]) < 0.0001 &&
            Math.abs(zoomingToCoordinates[1] - coordinates[1]) < 0.0001;
            
        const isZoomedOnThisUP = isCurrentlyZoomingHere || (
            (currentPitch > 45 && currentZoom >= 16 && centerDistance < 2) || // Vue 3D
            (currentZoom >= 16 && centerDistance < 0.5) || // Vue tr√®s zoom√©e et tr√®s proche
            (currentZoom >= 15 && centerDistance < 0.2) // Vue zoom√©e et extr√™mement proche
        );
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'popup-actions';
        
        const viewBtn = document.createElement('button');
        viewBtn.className = 'popup-view-btn';
        
        if (isZoomedOnThisUP) {
            // Bouton "Retour √† la carte" car on est zoom√© sur cette UP
            viewBtn.textContent = 'Retour √† la carte';
            viewBtn.style.backgroundColor = '#28a745';
            viewBtn.onclick = function() {
                // R√©initialiser les variables de tracking
                currentView3DCoordinates = null;
                zoomingToCoordinates = null;
                
                map.flyTo({
                    center: coordinates,
                    zoom: 12,
                    pitch: 0,
                    bearing: 0,
                    speed: 1.2,
                    essential: true
                });
                
                // Rafra√Æchir le popup ET les cards apr√®s le retour
                setTimeout(() => {
                    // Fermer le popup actuel et le recr√©er avec le bon bouton
                    activePopups.forEach(p => p.remove());
                    activePopups.length = 0;
                    // Recr√©er le popup avec le bouton "Voir en 3D"
                    const refreshedPopup = createPopupContent(props, coordinates);
                    refreshedPopup.setLngLat(coordinates).addTo(map);
                    activePopups.push(refreshedPopup);
                    // Rafra√Æchir aussi les cards
                    updateSidebarBasedOnMapViewport();
                }, 1300);
            };
        } else {
            // Bouton "Voir en 3D" car on n'est pas zoom√© sur cette UP
            viewBtn.textContent = 'Voir en 3D';
            viewBtn.onclick = function() {
                // Marquer qu'on est en train de zoomer vers cette UP
                zoomingToCoordinates = coordinates;
                currentView3DCoordinates = coordinates;
                
                map.flyTo({
                    center: coordinates,
                    zoom: 17,
                    pitch: 60,
                    bearing: 30,
                    speed: 1.2,
                    essential: true
                });
                
                // Fermer le popup actuel et en rouvrir un avec le bon bouton
                setTimeout(() => {
                    activePopups.forEach(p => p.remove());
                    activePopups.length = 0;
                    // Recr√©er le popup avec les m√™mes propri√©t√©s
                    const refreshedPopup = createPopupContent(props, coordinates);
                    refreshedPopup.setLngLat(coordinates).addTo(map);
                    activePopups.push(refreshedPopup);
                    updateSidebarBasedOnMapViewport();
                    // R√©initialiser APR√àS avoir recr√©√© le popup
                    setTimeout(() => {
                        zoomingToCoordinates = null; // Zoom termin√©
                    }, 100);
                }, 1300);
            };
        }
        
        actionsDiv.appendChild(viewBtn);
        popupDiv.appendChild(actionsDiv);
        
        popup.setDOMContent(popupDiv);
        
        return popup;
    }
    
    function updatePointADisplay(properties) {
        const selectedPointA = document.getElementById('selected-point-a');
        const pointAName = document.getElementById('point-a-name');
        const pointASection = document.getElementById('point-a-section');
        const geocoderContainer = document.getElementById('geocoder-container');
        const clearPointA = document.getElementById('clear-point-a');
        
        if (selectedPointA && pointAName) {
            // Utiliser le nom complet de l'UP
            const displayName = properties.UP || properties['Nom du site'] || properties['Nom_du_site'] || '\u00C9tablissement s\u00E9lectionn\u00E9';
            
            // Afficher l'√©l√©ment avec le nom
            pointAName.textContent = displayName;
            selectedPointA.style.display = 'block';
            
            // Cacher le geocoder quand un point est s√©lectionn√©
            if (geocoderContainer) {
                geocoderContainer.style.display = 'none';
            }
            
            // Ajouter l'event listener sur la croix
            if (clearPointA) {
                clearPointA.addEventListener('click', clearPointASelection);
            }
            
            // Ajouter une bordure color√©e √† la section Point A
            if (pointASection) {
                pointASection.style.borderColor = '#1976d2';
                pointASection.style.borderWidth = '2px';
            }
        }
    }
    
    function clearPointADisplay() {
        const selectedPointA = document.getElementById('selected-point-a');
        const pointASection = document.getElementById('point-a-section');
        const geocoderContainer = document.getElementById('geocoder-container');
        
        if (selectedPointA) {
            selectedPointA.style.display = 'none';
        }
        
        // R√©afficher le geocoder
        if (geocoderContainer) {
            geocoderContainer.style.display = 'flex';
        }
        
        if (pointASection) {
            pointASection.style.borderColor = '#ddd';
            pointASection.style.borderWidth = '1px';
        }
    }
    
    function updatePointBDisplay(properties) {
        const selectedPointB = document.getElementById('selected-point-b');
        const pointBName = document.getElementById('point-b-name');
        const pointBSection = document.getElementById('point-b-section');
        const geocoderContainerB = document.getElementById('geocoder-container-b');
        const clearPointB = document.getElementById('clear-point-b');
        
        if (selectedPointB && pointBName) {
            // Utiliser le nom complet de l'UP
            const displayName = properties.UP || properties['Nom du site'] || properties['Nom_du_site'] || '\u00C9tablissement s\u00E9lectionn\u00E9';
            
            // Afficher l'√©l√©ment avec le nom
            pointBName.textContent = displayName;
            selectedPointB.style.display = 'block';
            
            // Cacher le geocoder B quand un point est s√©lectionn√©
            if (geocoderContainerB) {
                geocoderContainerB.style.display = 'none';
            }
            
            // Ajouter l'event listener sur la croix
            if (clearPointB) {
                clearPointB.addEventListener('click', clearPointBSelection);
            }
            
            // Ajouter une bordure color√©e √† la section Point B
            if (pointBSection) {
                pointBSection.style.borderColor = '#ffc107';
                pointBSection.style.borderWidth = '2px';
            }
        }
    }
    
    function clearPointBDisplay() {
        const selectedPointB = document.getElementById('selected-point-b');
        const pointBSection = document.getElementById('point-b-section');
        const geocoderContainerB = document.getElementById('geocoder-container-b');
        
        if (selectedPointB) {
            selectedPointB.style.display = 'none';
        }
        
        // R√©afficher le geocoder B
        if (geocoderContainerB) {
            geocoderContainerB.style.display = 'flex';
        }
        
        if (pointBSection) {
            pointBSection.style.borderColor = '#ddd';
            pointBSection.style.borderWidth = '1px';
        }
    }
    
    function setFocusOnPointA() {
        currentFocusedInput = 'A';
        const pointASection = document.getElementById('point-a-section');
        const pointBSection = document.getElementById('point-b-section');
        
        if (pointASection) {
            pointASection.style.borderColor = '#1976d2';
            pointASection.style.borderWidth = '3px';
            pointASection.style.boxShadow = '0 2px 8px rgba(25, 118, 210, 0.3)';
        }
        
        if (pointBSection) {
            pointBSection.style.borderColor = '#ddd';
            pointBSection.style.borderWidth = '1px';
            pointBSection.style.boxShadow = 'none';
        }
        
    }
    
    function setFocusOnPointB() {
        currentFocusedInput = 'B';
        const pointASection = document.getElementById('point-a-section');
        const pointBSection = document.getElementById('point-b-section');
        
        if (pointASection) {
            pointASection.style.borderColor = '#ddd';
            pointASection.style.borderWidth = '1px';
            pointASection.style.boxShadow = 'none';
        }
        
        if (pointBSection) {
            pointBSection.style.borderColor = '#ff9800';
            pointBSection.style.borderWidth = '3px';
            pointBSection.style.boxShadow = '0 2px 8px rgba(255, 152, 0, 0.3)';
        }
        
    }
    
    function clearPointASelection() {
        // R√©initialiser les variables
        currentSearchCenter = null;
        currentPointAFeature = null;
        
        // Cacher l'affichage du Point A s√©lectionn√©
        clearPointADisplay();
        
        // R√©afficher le geocoder A
        const geocoderContainer = document.getElementById('geocoder-container');
        if (geocoderContainer) {
            geocoderContainer.style.display = 'flex';
        }
        
        // R√©initialiser le geocoder A sans d√©clencher l'√©v√©nement clear
        if (geocoder) {
            // Nettoyer manuellement l'input du geocoder plut√¥t que d'utiliser .clear()
            const geocoderInput = geocoderContainer.querySelector('input');
            if (geocoderInput) {
                geocoderInput.value = '';
            }
            // Alternative : utiliser setInput si disponible
            if (typeof geocoder.setInput === 'function') {
                geocoder.setInput('');
            }
        }
        
        // Supprimer le trajet (mais garder Point B si il est s√©lectionn√©)
        clearCurrentRoute();
        
        // Remettre le focus sur A
        setFocusOnPointA();
        
        // G√©rer le rayon intelligemment selon la pr√©sence de Point B (sauf en mode itin√©raire)
        if (!isRouteMode) {
            const pointBCoords = getCurrentPointBCoords();
            if (pointBCoords) {
                // Si Point B existe, l'utiliser comme nouveau centre pour le rayon
                currentSearchCenter = pointBCoords;
                // Maintenir le contr√¥le de rayon visible et redessiner le cercle
                const radiusControl = document.querySelector('.map-radius-control');
                if (radiusControl) radiusControl.style.display = 'block';
                
                drawSearchRadiusCircle(pointBCoords, currentSearchRadius);
            } else {
                // Si Point B n'existe pas, comportement normal (cacher le rayon)
                const radiusControl = document.querySelector('.map-radius-control');
                if (radiusControl) radiusControl.style.display = 'none';
                removeSearchRadiusCircle();
            }
        }
        
        // R√©appliquer les filtres avec le nouveau contexte
        applyFilters();
        
    }
    
    function clearPointBSelection() {
        // R√©initialiser la destination
        destinationCoords = null;
        currentPointBFeature = null;
        
        // Cacher l'affichage du Point B s√©lectionn√©
        clearPointBDisplay();
        
        // R√©afficher le geocoder B
        const geocoderContainerB = document.getElementById('geocoder-container-b');
        if (geocoderContainerB) {
            geocoderContainerB.style.display = 'flex';
        }
        
        // R√©initialiser le geocoder B
        if (geocoderB) {
            geocoderB.clear();
        }
        
        // Supprimer le trajet actuel
        clearCurrentRoute();
        
    }
    
    function areCoordinatesIdentical(coords1, coords2, tolerance = 0.00001) {
        if (!coords1 || !coords2) return false;
        return Math.abs(coords1[0] - coords2[0]) < tolerance && Math.abs(coords1[1] - coords2[1]) < tolerance;
    }
    
    function areEstablishmentsIdentical(feature1, feature2) {
        // V√©rification robuste pour identifier si deux √©tablissements sont identiques
        if (!feature1 || !feature2) return false;
        
        // Comparaison par propri√©t√© UP (identifiant principal)
        const up1 = feature1.properties?.UP;
        const up2 = feature2.properties?.UP;
        if (up1 && up2 && up1 === up2) {
            return true;
        }
        
        // Comparaison par coordonn√©es en fallback
        const coords1 = feature1.geometry?.coordinates;
        const coords2 = feature2.geometry?.coordinates;
        if (coords1 && coords2 && areCoordinatesIdentical(coords1, coords2)) {
            return true;
        }
        
        return false;
    }
    
    function showIdenticalPointsWarning() {
        alert('Les points A et B ne peuvent pas √™tre identiques. Veuillez choisir une destination diff√©rente.');
    }

    function isPointBSelected() {
        // V√©rifier si Point B est actuellement s√©lectionn√©
        const selectedPointB = document.getElementById('selected-point-b');
        const pointBSection = document.getElementById('point-b-section');
        
        return destinationCoords !== null && 
               selectedPointB && 
               selectedPointB.style.display !== 'none' &&
               pointBSection &&
               pointBSection.style.display !== 'none';
    }

    function getCurrentPointACoords() {
        // Obtenir les coordonn√©es r√©elles du Point A depuis l'affichage ou les variables
        const selectedPointA = document.getElementById('selected-point-a');
        if (selectedPointA && selectedPointA.style.display !== 'none') {
            // Si Point A est affich√©, utiliser currentSearchCenter ou chercher dans les donn√©es
            return currentSearchCenter;
        }
        return null;
    }

    function getCurrentPointBCoords() {
        // Obtenir les coordonn√©es r√©elles du Point B depuis l'affichage ou les variables
        const selectedPointB = document.getElementById('selected-point-b');
        const pointBSection = document.getElementById('point-b-section');
        
        if (selectedPointB && selectedPointB.style.display !== 'none' &&
            pointBSection && pointBSection.style.display !== 'none') {
            return destinationCoords;
        }
        return null;
    }
    
    function showSinglePopup(properties, coordinates) {
        // Fermer tous les popups existants
        activePopups.forEach(p => p.remove());
        activePopups.length = 0;
        
        // Cr√©er et afficher le nouveau popup
        const popup = createPopupContent(properties, coordinates);
        popup.setLngLat(coordinates).addTo(map);
        
        // Ajouter au tracking
        activePopups.push(popup);
        
        return popup;
    }

    // Fonction pour s√©lectionner une UP et afficher le rayon en mode normal
    function selectUPAndShowRadius(feature) {
        const coordinates = feature.geometry.coordinates;
        
        // D√©finir le centre de recherche actuel
        currentSearchCenter = coordinates;
        
        // Marquer qu'on zoome vers cette UP (pour le cas du double-clic)
        zoomingToCoordinates = coordinates;
        currentView3DCoordinates = coordinates;
        
        // Calculer le zoom appropri√© en fonction du rayon actuel
        // Formule approximative : zoom = 11.5 - log2(radius_km / 10)
        const radiusKm = currentSearchRadius || 80;
        let zoomLevel;
        if (radiusKm <= 20) zoomLevel = 11;
        else if (radiusKm <= 40) zoomLevel = 10.5;
        else if (radiusKm <= 60) zoomLevel = 10;
        else if (radiusKm <= 80) zoomLevel = 9.5;
        else if (radiusKm <= 100) zoomLevel = 9;
        else zoomLevel = 8.5;
        
        // Zoomer pour voir tout le rayon
        map.flyTo({
            center: coordinates,
            zoom: zoomLevel,
            duration: 1500
        });
        
        // Afficher le contr√¥le de rayon
        showRadiusControl();
        
        // Dessiner le cercle de rayon
        drawSearchRadiusCircle(coordinates, currentSearchRadius);
        
        // Attendre que le zoom soit termin√© avant d'afficher le popup
        setTimeout(() => {
            showSinglePopup(feature.properties, coordinates);
            // R√©initialiser apr√®s affichage
            setTimeout(() => {
                zoomingToCoordinates = null;
            }, 100);
        }, 1600);
        
        // Appliquer les filtres avec le nouveau centre
        applyFilters();
    }

    function focusOnEstablishment(feature) {
        const coordinates = feature.geometry.coordinates;
        
        // V√©rifier si on est en mode normal - activer le rayon au lieu du zoom 3D
        if (window.currentAppMode === 'normal') {
            // S√©lectionner l'UP et afficher le rayon (comme un double-clic sur la carte)
            selectUPAndShowRadius(feature);
            return;
        }
        
        // Mode itin√©raire - comportement original
        // üîç √âTAPE 1: V√©rification anti-doublon robuste
        if (currentPointAFeature && areEstablishmentsIdentical(currentPointAFeature, feature)) {
            showIdenticalPointsWarning();
            return;
        }
        if (currentPointBFeature && areEstablishmentsIdentical(currentPointBFeature, feature)) {
            showIdenticalPointsWarning();
            return;
        }
        
        // [TARGET] √âTAPE 2: Logique de s√©lection bas√©e sur l'√©tat actuel
        if (!currentPointAFeature) {
            // CAS 1: Aucun Point A ‚Üí S√©lectionner comme Point A
            selectAsPointA(feature);
            
        } else if (!currentPointBFeature) {
            // CAS 2: Point A existe, pas de Point B ‚Üí S√©lectionner comme Point B
            selectAsPointB(feature);
            
        } else {
            // CAS 3: A et B existent ‚Üí Utiliser le focus pour d√©terminer lequel remplacer
            if (currentFocusedInput === 'A') {
                selectAsPointA(feature);
            } else {
                selectAsPointB(feature);
            }
        }
        
        // Zoom sur l'√©tablissement
        map.flyTo({ center: coordinates, zoom: 17, pitch: 60, bearing: 30, speed: 1.2, essential: true });
        
        // Utiliser showSinglePopup pour garantir qu'un seul popup soit visible
        showSinglePopup(feature.properties, coordinates);
    }
    
    function selectAsPointA(feature) {
        const coordinates = feature.geometry.coordinates;
        
        // Mettre √† jour les variables globales
        currentSearchCenter = coordinates;
        currentPointAFeature = feature;
        
        // Mettre √† jour l'affichage
        updatePointADisplay(feature.properties);
        
        // Configuration de l'interface
        showPointB();
        setFocusOnPointB();
        showRadiusControl();
        showRouteInterface();
        
        // Configuration du rayon
        const radiusSlider = document.getElementById('radius-slider');
        if (radiusSlider) radiusSlider.value = 80;
        const radiusValue = document.getElementById('radius-value');
        if (radiusValue) radiusValue.textContent = "80 km";
        drawSearchRadiusCircle(currentSearchCenter, 80);
        applyFilters();
        
        // Si Point B existe d√©j√†, calculer l'itin√©raire
        if (currentPointBFeature && destinationCoords) {
            setTimeout(() => {
                showRouteOnMap(currentSearchCenter, destinationCoords);
            }, 500);
        }
    }
    
    function selectAsPointB(feature) {
        const coordinates = feature.geometry.coordinates;
        
        // Mettre √† jour les variables globales
        destinationCoords = coordinates;
        currentPointBFeature = feature;
        
        // Mettre √† jour l'affichage
        updatePointBDisplay(feature.properties);
        showPointB();
        
        // Si Point A existe, calculer l'itin√©raire
        if (currentPointAFeature && currentSearchCenter) {
            setTimeout(() => {
                showRouteOnMap(currentSearchCenter, destinationCoords);
            }, 500);
        }
    }
    
    function updateSidebarBasedOnMapViewport() {
        if (!map.isStyleLoaded()) { 
            // Au lieu de retourner vide, essayer d'afficher avec les donn√©es disponibles
            if (!primaryFilteredFeatures) {
                primaryFilteredFeatures = [...establishmentsData.features];
            }
        }
        
        // Si primaryFilteredFeatures n'est pas encore d√©fini, utiliser toutes les donn√©es
        if (!primaryFilteredFeatures) {
            primaryFilteredFeatures = [...establishmentsData.features];
        }
        
        let featuresToDisplay=[];
        
        if (currentLayoutMode==='sidebarFull') {
            // En mode sidebar complet, afficher tous les √©tablissements filtr√©s
            featuresToDisplay=[...primaryFilteredFeatures];
        } else if (currentLayoutMode==='mapFull') {
            // En mode carte complet, ne rien afficher dans la sidebar
            featuresToDisplay=[];
        } else {
            // En mode dual, afficher SEULEMENT les √©tablissements visibles sur la carte
            if (primaryFilteredFeatures.length > 0) {
                try {
                    const mapBounds = map.getBounds();
                    if (mapBounds) {
                        featuresToDisplay = primaryFilteredFeatures.filter(feature => {
                            if (!feature.geometry||!feature.geometry.coordinates) return false;
                            return mapBounds.contains(feature.geometry.coordinates);
                        });
                    } else {
                        // Si getBounds() ne fonctionne pas, afficher tous les √©tablissements
                        featuresToDisplay = [...primaryFilteredFeatures];
                    }
                } catch (e) {
                    // En cas d'erreur, afficher tous les √©tablissements
                    featuresToDisplay = [...primaryFilteredFeatures];
                }
            }
        }
        
        updateSidebarCards(featuresToDisplay);
        
        // Synchroniser les compteurs de la l√©gende avec le viewport
        updateLegendCountsFromViewport();
    }

    function updateSidebarCards(features) {
        const sidebar = document.getElementById('establishments-view');
        
        // Effet de transition subtil
        sidebar.style.opacity = '0.7';
        setTimeout(() => {
            sidebar.innerHTML = '';
            
            if (features.length === 0) {
                const noResultsP = document.createElement('p');
                noResultsP.textContent = 'Aucun \u00E9tablissement trouv\u00E9 pour les crit\u00E8res s\u00E9lectionn\u00E9s ou dans la vue actuelle.';
                sidebar.appendChild(noResultsP);
                updateResultsCount(0);
                sidebar.style.opacity = '1';
                return;
            }

        // Trier par distance si on a un centre de recherche
        let sortedFeatures = [...features];
        if (currentSearchCenter && sortByDistance) {
            sortedFeatures.sort((a, b) => {
                const distanceA = getDistanceFromLatLonInKm(
                    currentSearchCenter[1], currentSearchCenter[0],
                    a.geometry.coordinates[1], a.geometry.coordinates[0]
                );
                const distanceB = getDistanceFromLatLonInKm(
                    currentSearchCenter[1], currentSearchCenter[0],
                    b.geometry.coordinates[1], b.geometry.coordinates[0]
                );
                return distanceA - distanceB;
            });
        }

        sortedFeatures.forEach(feature => {
            const card = document.createElement('div');
            card.className = 'establishment-card';
            
            // Ajouter l'attribut data-activity pour le style de bordure
            const activityType = getActivityType(feature.properties.activity);
            card.setAttribute('data-activity', activityType);
            
            card.setAttribute('tabindex', '0');
            card.setAttribute('role', 'button');
            card.setAttribute('aria-label', `√âtablissement ${feature.properties.UP}`);
            
            const props = feature.properties;
            const name = decodeHTMLEntities(props.UP || 'N/A');
            const address = decodeHTMLEntities(props.Adresse || 'N/A');
            const city = decodeHTMLEntities(props.Ville || '');
            const postalCode = props["Code postal"] || '';
            const phone = props.Phone && props.Phone !== "null" ? props.Phone : null;
            const email = props.Email && props.Email !== "null" ? props.Email : null;

            // Calculer la distance et le temps de trajet
            let distanceHTML = '';
            if (currentSearchCenter) {
                let distance, travelTime;
                
                // V√©rifier si c'est l'√©tablissement de destination avec donn√©es r√©elles
                const isDestination = destinationCoords && 
                    Math.abs(feature.geometry.coordinates[0] - destinationCoords[0]) < 0.0001 &&
                    Math.abs(feature.geometry.coordinates[1] - destinationCoords[1]) < 0.0001;
                
                if (isDestination && realRouteData) {
                    distance = parseFloat(realRouteData.distance);
                    travelTime = realRouteData.travelTime;
                } else {
                    distance = getDistanceFromLatLonInKm(
                        currentSearchCenter[1], currentSearchCenter[0],
                        feature.geometry.coordinates[1], feature.geometry.coordinates[0]
                    );
                    travelTime = calculateTravelTime(distance);
                }
                
                // Ne pas afficher les badges si distance = 0 ou temps = "0 min"
                const distanceValue = distance.toFixed ? distance.toFixed(1) : distance;
                if (parseFloat(distanceValue) > 0 && travelTime !== "0 min") {
                    distanceHTML = `<span class="distance-badge">${distanceValue} km</span> <span class="time-badge">${travelTime}</span>`;
                }
            }

            // Nouvelle structure compacte de la card
            
            // Header avec titre et badges sur la m√™me ligne
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';
            
            // Titre
            const title = document.createElement('h3');
            title.textContent = name;
            cardHeader.appendChild(title);
            
            // Badges de distance et temps (si disponibles)
            if (currentSearchCenter) {
                let distance, travelTime;
                
                // V√©rifier si c'est l'√©tablissement de destination avec donn√©es r√©elles
                const isDestination = destinationCoords && 
                    Math.abs(feature.geometry.coordinates[0] - destinationCoords[0]) < 0.0001 &&
                    Math.abs(feature.geometry.coordinates[1] - destinationCoords[1]) < 0.0001;
                
                if (isDestination && realRouteData) {
                    distance = parseFloat(realRouteData.distance);
                    travelTime = realRouteData.travelTime;
                } else {
                    distance = getDistanceFromLatLonInKm(
                        currentSearchCenter[1], currentSearchCenter[0],
                        feature.geometry.coordinates[1], feature.geometry.coordinates[0]
                    );
                    travelTime = calculateTravelTime(distance);
                }
                
                // Arrondir la distance diff√©remment selon la valeur
                let distanceDisplay;
                if (isDestination && realRouteData) {
                    // Donn√©es r√©elles : affichage pr√©cis
                    distanceDisplay = distance.toFixed(1) + ' km';
                } else {
                    // Estimations : arrondir pour montrer l'approximation
                    if (distance < 10) {
                        distanceDisplay = '~' + Math.round(distance) + ' km';
                    } else if (distance < 50) {
                        distanceDisplay = '~' + (Math.round(distance / 5) * 5) + ' km';
                    } else {
                        distanceDisplay = '~' + (Math.round(distance / 10) * 10) + ' km';
                    }
                }
                
                if (distance > 0 && travelTime !== "0 min") {
                    const badgesContainer = document.createElement('div');
                    badgesContainer.className = 'card-badges';
                    
                    const distanceBadge = document.createElement('span');
                    distanceBadge.className = 'distance-badge';
                    distanceBadge.textContent = distanceDisplay;
                    distanceBadge.title = (isDestination && realRouteData) ? 
                        'Distance r√©elle par la route' : 
                        'Distance approximative √† vol d\'oiseau';
                    badgesContainer.appendChild(distanceBadge);
                    
                    const timeBadge = document.createElement('span');
                    timeBadge.className = 'time-badge';
                    timeBadge.textContent = (isDestination && realRouteData) ? 
                        travelTime : 
                        travelTime;
                    timeBadge.title = (isDestination && realRouteData) ? 
                        'Temps de trajet r√©el' : 
                        'Estimation du temps de trajet';
                    badgesContainer.appendChild(timeBadge);
                    
                    cardHeader.appendChild(badgesContainer);
                }
            }
            
            card.appendChild(cardHeader);
            
            // Adresse (plus compacte)
            const addressEl = document.createElement('div');
            addressEl.className = 'card-address';
            addressEl.textContent = `${address}, ${city} ${postalCode}`;
            card.appendChild(addressEl);
            
            // Actions compactes avec ic√¥nes
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'card-actions-compact';
            
            // Bouton t√©l√©phone
            if (phone && phone !== "null") {
                const phoneBtn = document.createElement('button');
                phoneBtn.className = 'card-action-icon phone';
                phoneBtn.setAttribute('aria-label', 'Appeler');
                phoneBtn.setAttribute('title', 'Appeler');
                phoneBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>`;
                phoneBtn.onclick = (e) => {
                    e.stopPropagation();
                    window.location.href = `tel:${phone}`;
                };
                actionsContainer.appendChild(phoneBtn);
            }
            
            // Bouton itin√©raire
            const routeBtn = document.createElement('button');
            routeBtn.className = 'card-action-icon route';
            routeBtn.setAttribute('aria-label', 'Itin√©raire');
            routeBtn.setAttribute('title', 'Calculer un itin√©raire');
            routeBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M21.71 11.29l-9-9a.996.996 0 00-1.41 0l-9 9a.996.996 0 000 1.41l9 9c.39.39 1.02.39 1.41 0l9-9a.996.996 0 000-1.41zM14 14.5V12h-4v3H8v-4c0-.55.45-1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/></svg>`;
            routeBtn.onclick = (e) => {
                e.stopPropagation();
                // Basculer en mode route si n√©cessaire
                if (window.switchToRouteMode) {
                    window.switchToRouteMode();
                }
                // S√©lectionner cette UP comme point A
                selectAsPointA(feature);
            };
            actionsContainer.appendChild(routeBtn);
            
            // Bouton info (remplace "Plus d'informations")
            const infoBtn = document.createElement('button');
            infoBtn.className = 'card-action-icon info';
            infoBtn.setAttribute('aria-label', 'Plus d\'informations');
            infoBtn.setAttribute('title', 'Plus d\'informations');
            infoBtn.setAttribute('data-feature', encodeURIComponent(JSON.stringify(props)));
            infoBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>`;
            
            // Ajouter l'event listener pour le bouton info
            infoBtn.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
            });
            
            actionsContainer.appendChild(infoBtn);
            
            // Bouton Voir en 3D / Retour √† la carte
            const view3dBtn = document.createElement('button');
            
            // V√©rifier si cette UP est actuellement en vue zoom√©e
            const currentZoom = map.getZoom();
            const currentPitch = map.getPitch();
            const mapCenter = map.getCenter();
            const centerDistance = turf.distance(
                turf.point([mapCenter.lng, mapCenter.lat]),
                turf.point(feature.geometry.coordinates),
                { units: 'kilometers' }
            );
            
            const isCurrently3D = (
                (currentPitch > 45 && currentZoom >= 16 && centerDistance < 2) ||
                (currentZoom >= 16 && centerDistance < 0.5) ||
                (currentZoom >= 15 && centerDistance < 0.2)
            );
            
            if (isCurrently3D) {
                // Mode retour √† la carte
                view3dBtn.className = 'card-action-icon view3d active';
                view3dBtn.setAttribute('aria-label', 'Retour √† la carte');
                view3dBtn.setAttribute('title', 'Retour √† la carte');
                view3dBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M21 11l-6-6v5H8c-2.76 0-5 2.24-5 5v4h2v-4c0-1.65 1.35-3 3-3h7v5l6-6z"/></svg>`;
                
                view3dBtn.onclick = (e) => {
                    e.stopPropagation();
                    // Retour √† la vue normale
                    map.flyTo({
                        center: feature.geometry.coordinates,
                        zoom: 12,
                        pitch: 0,
                        bearing: 0,
                        speed: 1.2,
                        essential: true
                    });
                    // R√©initialiser les variables de tracking
                    currentView3DCoordinates = null;
                    zoomingToCoordinates = null;
                    
                    // Rafra√Æchir les cards apr√®s l'animation
                    setTimeout(() => {
                        if (window.currentAppMode === 'normal') {
                            updateSidebarBasedOnMapViewport();
                        }
                    }, 1300);
                };
            } else {
                // Mode voir en 3D
                view3dBtn.className = 'card-action-icon view3d';
                view3dBtn.setAttribute('aria-label', 'Voir en 3D');
                view3dBtn.setAttribute('title', 'Voir en 3D');
                view3dBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 7C6.48 7 2 9.24 2 12c0 2.24 2.94 4.13 7 4.77V20l4-4-4-4v2.73c-3.15-.56-5-1.9-5-2.73 0-1.06 3.04-3 8-3s8 1.94 8 3c0 .73-1.46 1.89-4 2.53v1.05c2.8-.59 5-1.94 5-3.58 0-2.76-4.48-5-10-5z"/></svg>`;
                
                view3dBtn.onclick = (e) => {
                    e.stopPropagation();
                    // Marquer qu'on est en train de zoomer vers cette UP
                    zoomingToCoordinates = feature.geometry.coordinates;
                    currentView3DCoordinates = feature.geometry.coordinates;
                    
                    // Zoom 3D sur l'√©tablissement
                    map.flyTo({
                        center: feature.geometry.coordinates,
                        zoom: 17,
                        pitch: 60,
                        bearing: 30,
                        speed: 1.2,
                        essential: true
                    });
                    
                    // Rafra√Æchir les cards apr√®s l'animation
                    setTimeout(() => {
                        if (window.currentAppMode === 'normal') {
                            updateSidebarBasedOnMapViewport();
                        }
                    }, 1300);
                };
            }
            
            actionsContainer.appendChild(view3dBtn);
            card.appendChild(actionsContainer);
            
            // Click handler pour la card enti√®re (focus sur l'√©tablissement)
            card.addEventListener('click', (event) => {
                if (!event.target.closest('.card-action-icon')) {
                    focusOnEstablishment(feature);
                }
            });
            
            // Emp√™cher la propagation du clic sur les boutons d'action
            card.querySelectorAll('.card-action-icon').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                });
            });
            
            sidebar.appendChild(card);
        });
        
        attachModalListeners();
        
        // Mettre √† jour le compteur d'√©tablissements visibles
        updateResultsCount(features.length);
        
        // Restaurer l'opacit√© apr√®s le rendu
        sidebar.style.opacity = '1';
        
        // Corriger les entit√©s HTML dans les cards apr√®s leur cr√©ation
        setTimeout(() => {
            fixCardEntities();
        }, 100);
        
        }, 50); // D√©lai court pour l'effet de transition
    }
    
    function updateResultsCount(visibleCount) {
        const resultsCountElement = document.getElementById('results-count');
        if (resultsCountElement) {
            let message = '';
            
            if (currentLayoutMode === 'sidebarFull') {
                // En mode sidebar complet, on affiche tous les √©tablissements filtr√©s
                message = `${visibleCount} \u00E9tablissement(s) trouv\u00E9(s).`;
            } else if (currentLayoutMode === 'mapFull') {
                // En mode carte complet, pas de message dans la sidebar
                message = '';
            } else {
                // En mode dual, pr√©ciser "visibles" et donner le contexte
                const totalFiltered = primaryFilteredFeatures ? primaryFilteredFeatures.length : 0;
                if (visibleCount === 0) {
                    message = `Aucun \u00E9tablissement visible dans cette zone.`;
                    if (totalFiltered > 0) {
                        message += ` (${totalFiltered} au total)`;
                    }
                } else if (visibleCount === totalFiltered) {
                    message = `${visibleCount} \u00E9tablissement(s) trouv\u00E9(s).`;
                } else {
                    message = `${visibleCount} visible(s) sur ${totalFiltered} trouv\u00E9(s).`;
                }
            }
            
            resultsCountElement.textContent = message;
        }
    }
    
    function closeModal() {
        const modal = document.getElementById('modal');
        const modalContent = document.querySelector('.modal-content');
        
        // Appliquer les animations de fermeture
        modal.style.animation = 'fadeOut 0.3s ease';
        modalContent.style.animation = 'slideDown 0.3s ease';
        
        // Attendre la fin de l'animation avant de masquer
        setTimeout(() => {
            modal.style.display = 'none';
            // R√©initialiser les animations pour la prochaine ouverture
            modal.style.animation = '';
            modalContent.style.animation = '';
        }, 300);
    }
    
    function attachModalListeners() {
        // Nouvelle s√©lection pour les boutons info avec ic√¥nes
        document.querySelectorAll('#establishments-view .card-action-icon.info').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                // La propagation est d√©j√† stopp√©e par un autre listener, mais on le laisse par s√©curit√©
                event.stopPropagation();
                const modal = document.getElementById('modal');
                const modalInfo = document.getElementById('modal-info');
                try {
                    const props = JSON.parse(decodeURIComponent(this.dataset.feature));
                    const name=decodeHTMLEntities(props.UP||'N/A');
                    const address=decodeHTMLEntities(props.Adresse||'N/A');
                    const city=decodeHTMLEntities(props.Ville||'');
                    const postalCode=props["Code postal"]||'';
                    const phone=props.Phone&&props.Phone!=="null"?props.Phone:null;
                    const email=props.Email&&props.Email!=="null"?props.Email:null;
                    const activity=props.activity?props.activity.charAt(0).toUpperCase()+props.activity.slice(1):'N/A';
                    
                    // Cr√©er le contenu moderne de la modal
                    const modalContent = document.querySelector('.modal-content');
                    modalContent.innerHTML = '';
                    
                    // Header
                    const modalHeader = document.createElement('div');
                    modalHeader.className = 'modal-header';
                    const modalTitle = document.createElement('h3');
                    modalTitle.textContent = name;
                    modalHeader.appendChild(modalTitle);
                    
                    const closeBtn = document.createElement('span');
                    closeBtn.className = 'close-button';
                    closeBtn.innerHTML = '√ó';
                    closeBtn.onclick = () => closeModal();
                    modalHeader.appendChild(closeBtn);
                    
                    modalContent.appendChild(modalHeader);
                    
                    // Body
                    const modalBody = document.createElement('div');
                    modalBody.className = 'modal-body';
                    
                    // Adresse
                    const addressRow = document.createElement('div');
                    addressRow.className = 'modal-info-row';
                    const addressLabel = document.createElement('div');
                    addressLabel.className = 'modal-info-label';
                    addressLabel.textContent = 'Adresse';
                    const addressValue = document.createElement('div');
                    addressValue.className = 'modal-info-value';
                    addressValue.innerHTML = `${address}<br>${city} ${postalCode}`;
                    addressRow.appendChild(addressLabel);
                    addressRow.appendChild(addressValue);
                    modalBody.appendChild(addressRow);
                    
                    // T√©l√©phone
                    const phoneRow = document.createElement('div');
                    phoneRow.className = 'modal-info-row';
                    const phoneLabel = document.createElement('div');
                    phoneLabel.className = 'modal-info-label';
                    phoneLabel.textContent = 'T√©l√©phone';
                    const phoneValue = document.createElement('div');
                    phoneValue.className = 'modal-info-value';
                    if (phone) {
                        const phoneLink = document.createElement('a');
                        phoneLink.href = `tel:${phone}`;
                        phoneLink.textContent = phone;
                        phoneValue.appendChild(phoneLink);
                    } else {
                        phoneValue.textContent = 'Non disponible';
                    }
                    phoneRow.appendChild(phoneLabel);
                    phoneRow.appendChild(phoneValue);
                    modalBody.appendChild(phoneRow);
                    
                    // Email
                    const emailRow = document.createElement('div');
                    emailRow.className = 'modal-info-row';
                    const emailLabel = document.createElement('div');
                    emailLabel.className = 'modal-info-label';
                    emailLabel.textContent = 'Email';
                    const emailValue = document.createElement('div');
                    emailValue.className = 'modal-info-value';
                    if (email) {
                        const emailLink = document.createElement('a');
                        emailLink.href = `mailto:${email}`;
                        emailLink.textContent = email;
                        emailValue.appendChild(emailLink);
                    } else {
                        emailValue.textContent = 'Non disponible';
                    }
                    emailRow.appendChild(emailLabel);
                    emailRow.appendChild(emailValue);
                    modalBody.appendChild(emailRow);
                    
                    // Activit√©
                    const activityRow = document.createElement('div');
                    activityRow.className = 'modal-info-row';
                    const activityLabel = document.createElement('div');
                    activityLabel.className = 'modal-info-label';
                    activityLabel.textContent = 'Activit√©';
                    const activityValue = document.createElement('div');
                    activityValue.className = 'modal-info-value';
                    const activityBadge = document.createElement('span');
                    activityBadge.className = 'activity-badge';
                    activityBadge.textContent = activity;
                    activityValue.appendChild(activityBadge);
                    activityRow.appendChild(activityLabel);
                    activityRow.appendChild(activityValue);
                    modalBody.appendChild(activityRow);
                    
                    modalContent.appendChild(modalBody);
                    
                    // Footer avec actions
                    const modalFooter = document.createElement('div');
                    modalFooter.className = 'modal-footer';
                    
                    if (phone) {
                        const callBtn = document.createElement('button');
                        callBtn.className = 'modal-action-btn primary';
                        callBtn.innerHTML = 'üìû Appeler';
                        callBtn.onclick = () => window.location.href = `tel:${phone}`;
                        modalFooter.appendChild(callBtn);
                    }
                    
                    const closeActionBtn = document.createElement('button');
                    closeActionBtn.className = 'modal-action-btn secondary';
                    closeActionBtn.textContent = 'Fermer';
                    closeActionBtn.onclick = () => closeModal();
                    modalFooter.appendChild(closeActionBtn);
                    
                    modalContent.appendChild(modalFooter);
                } catch (e) {
                    modalInfo.innerHTML = '';
                    const errorP = document.createElement('p');
                    errorP.textContent = "Impossible d'afficher les informations.";
                    modalInfo.appendChild(errorP);
                }
                // Afficher la modal avec animations
                modal.style.display = 'block';
                modal.style.animation = 'fadeIn 0.3s ease';
                modalContent.style.animation = 'slideUp 0.3s ease';
                // Corriger les entit√©s HTML dans la modal
                setTimeout(fixCardEntities, 100);
            });
        });
    }

    function drawSearchRadiusCircle(center, radiusKm) {
        removeSearchRadiusCircle();
        if (!turf) return;
        try {
            const circleGeoJSON = turf.circle(center, radiusKm, { steps: 64, units: 'kilometers' });
            if (map.getSource('radius-circle-source')) {
                map.getSource('radius-circle-source').setData(circleGeoJSON);
            } else {
                map.addSource('radius-circle-source', { type: 'geojson', data: circleGeoJSON });
                map.addLayer({ id: 'radius-circle-layer', type: 'line', source: 'radius-circle-source', layout: {}, paint: { 'line-color': '#555', 'line-width': 2, 'line-dasharray': [2, 2] } });
            }
        } catch (e) { console.error("Erreur lors de la cr√©ation du cercle:", e); }
    }
    
    function removeSearchRadiusCircle() {
        if (map.getLayer('radius-circle-layer')) map.removeLayer('radius-circle-layer');
        if (map.getSource('radius-circle-source')) map.removeSource('radius-circle-source');
    }
    
    // Fonction simplifi√©e pour nettoyer les anciens marqueurs/popups si n√©cessaire
    function cleanupOldMarkers() {
        currentMapboxMarkers.forEach(marker => marker.remove());
        currentMapboxMarkers.length = 0;
        activePopups.forEach(popup => popup.remove());
        activePopups.length = 0;
        // Mettre √† jour la l√©gende
        setTimeout(() => updateLegendCountsFromViewport(), 100);
    }

    function initializeLayout(){
        const viewSwitcherButton=document.getElementById('view-switcher');
        viewSwitcherButton.addEventListener('click',()=>{
            if(currentLayoutMode==='sidebarFull'){ switchToMapFullScreen(); }
            else if(currentLayoutMode==='mapFull'){ switchToSidebarFullScreen(); }
        });
        checkAndSetLayout();
    }
    
    function checkAndSetLayout(){
        const isBelowThreshold=window.innerHeight<VIEW_MODE_THRESHOLD;
        const viewSwitcherButton=document.getElementById('view-switcher');
        if(isBelowThreshold){
            if(currentLayoutMode==='dual'){ switchToSidebarFullScreen(); }
            viewSwitcherButton.style.display='block';
        }else{
            if(currentLayoutMode!=='dual'){ switchToDualView(); }
            viewSwitcherButton.style.display='none';
        }
        setTimeout(()=>{if(map)map.resize();},550);
    }
    
    function switchToSidebarFullScreen(){
        const mapContainer=document.getElementById('map-container');
        const viewSwitcherButton=document.getElementById('view-switcher');
        mapContainer.className='layout-sidebar-full';
        viewSwitcherButton.textContent='Afficher Carte';
        currentLayoutMode='sidebarFull';
        setTimeout(()=>{if(map){map.resize();updateSidebarBasedOnMapViewport();}},550);
    }
    
    function switchToMapFullScreen(){
        const mapContainer=document.getElementById('map-container');
        const viewSwitcherButton=document.getElementById('view-switcher');
        mapContainer.className='layout-map-full';
        viewSwitcherButton.textContent='Afficher Liste';
        currentLayoutMode='mapFull';
        setTimeout(()=>{if(map){map.resize();updateSidebarBasedOnMapViewport();}},550);
    }
    
    function switchToDualView(){
        const mapContainer=document.getElementById('map-container');
        mapContainer.className='layout-dual';
        currentLayoutMode='dual';
        setTimeout(()=>{if(map){map.resize();updateSidebarBasedOnMapViewport();}},550);
    }

    // Solution: Utiliser des caract√®res Unicode directement pour √©viter la transformation par Drupal
    function safeText(text) {
        // Si on est dans un iframe, utiliser des caract√®res Unicode √©chapp√©s
        if (window.self !== window.top) {
            return text
                .replace(/√©/g, '\u00E9')
                .replace(/√â/g, '\u00C9')
                .replace(/√®/g, '\u00E8')
                .replace(/√à/g, '\u00C8')
                .replace(/√†/g, '\u00E0')
                .replace(/√Ä/g, '\u00C0')
                .replace(/√π/g, '\u00F9')
                .replace(/√ô/g, '\u00D9')
                .replace(/√¥/g, '\u00F4')
                .replace(/√î/g, '\u00D4')
                .replace(/√ß/g, '\u00E7')
                .replace(/√á/g, '\u00C7')
                .replace(/√¢/g, '\u00E2')
                .replace(/√Ç/g, '\u00C2')
                .replace(/√™/g, '\u00EA')
                .replace(/√ä/g, '\u00CA')
                .replace(/√Æ/g, '\u00EE')
                .replace(/√é/g, '\u00CE')
                .replace(/√ª/g, '\u00FB')
                .replace(/√õ/g, '\u00DB')
                .replace(/√Ø/g, '\u00EF')
                .replace(/√è/g, '\u00CF')
                .replace(/√´/g, '\u00EB')
                .replace(/√ã/g, '\u00CB')
                .replace(/‚Ä¢/g, '\u2022');
        }
        return text;
    }
    
    // Alternative: Cr√©er des text nodes avec createTextNode qui √©chappe au traitement HTML
    function createSafeTextNode(text) {
        // Cr√©er un noeud texte qui ne sera pas interpr√©t√© comme HTML
        const textNode = document.createTextNode(text);
        return textNode;
    }
    
    // Fonction pour corriger les entit√©s HTML dans les cards et modals
    function fixCardEntities() {
        const entityMap = {
            '&eacute;': '√©', '&Eacute;': '√â',
            '&egrave;': '√®', '&Egrave;': '√à',
            '&agrave;': '√†', '&Agrave;': '√Ä',
            '&ugrave;': '√π', '&Ugrave;': '√ô',
            '&ocirc;': '√¥', '&Ocirc;': '√î',
            '&ccedil;': '√ß', '&Ccedil;': '√á',
            '&acirc;': '√¢', '&Acirc;': '√Ç',
            '&ecirc;': '√™', '&Ecirc;': '√ä',
            '&icirc;': '√Æ', '&Icirc;': '√é',
            '&ucirc;': '√ª', '&Ucirc;': '√õ',
            '&uuml;': '√º', '&Uuml;': '√ú',
            '&nbsp;': ' ', '&bull;': '‚Ä¢',
            '&#233;': '√©', '&#201;': '√â',
            '&#232;': '√®', '&#200;': '√à',
            '&#224;': '√†', '&#192;': '√Ä'
        };
        
        const fixText = (text) => {
            if (!text) return text;
            let fixed = text;
            for (const [entity, char] of Object.entries(entityMap)) {
                fixed = fixed.replace(new RegExp(entity, 'gi'), char);
            }
            return fixed;
        };
        
        // Corriger toutes les cards
        document.querySelectorAll('.establishment-card').forEach(card => {
            // Parcourir tous les n≈ìuds de texte dans la card
            const walker = document.createTreeWalker(
                card,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                if (node.nodeValue && node.nodeValue.includes('&')) {
                    node.nodeValue = fixText(node.nodeValue);
                }
            }
        });
        
        // Corriger la modal si elle est ouverte
        const modalInfo = document.getElementById('modal-info');
        if (modalInfo && modalInfo.innerHTML) {
            const walker = document.createTreeWalker(
                modalInfo,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                if (node.nodeValue && node.nodeValue.includes('&')) {
                    node.nodeValue = fixText(node.nodeValue);
                }
            }
        }
        
        // Corriger les popups Mapbox
        document.querySelectorAll('.mapboxgl-popup-content').forEach(popup => {
            const walker = document.createTreeWalker(
                popup,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                if (node.nodeValue && node.nodeValue.includes('&')) {
                    node.nodeValue = fixText(node.nodeValue);
                }
            }
        });
    }
    
    // Fonction pour surveiller et corriger les cards
    function setupCardEntityFix() {
        // Observer uniquement les changements dans le container des cards
        const establishmentsView = document.getElementById('establishments-view');
        const modalContainer = document.getElementById('modal');
        
        if (establishmentsView) {
            const observer = new MutationObserver((mutations) => {
                // V√©rifier si des cards ont √©t√© ajout√©es
                let hasNewCards = false;
                for (const mutation of mutations) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        for (const node of mutation.addedNodes) {
                            if (node.nodeType === Node.ELEMENT_NODE && 
                                (node.classList && node.classList.contains('establishment-card') ||
                                 node.querySelector && node.querySelector('.establishment-card'))) {
                                hasNewCards = true;
                                break;
                            }
                        }
                    }
                }
                
                if (hasNewCards) {
                    // Corriger apr√®s un court d√©lai pour laisser Drupal faire sa transformation
                    setTimeout(fixCardEntities, 100);
                    setTimeout(fixCardEntities, 500);
                    setTimeout(fixCardEntities, 1000);
                }
            });
            
            observer.observe(establishmentsView, {
                childList: true,
                subtree: false
            });
        }
        
        // Observer aussi la modal
        if (modalContainer) {
            const modalObserver = new MutationObserver(() => {
                if (modalContainer.style.display === 'block') {
                    setTimeout(fixCardEntities, 100);
                }
            });
            
            modalObserver.observe(modalContainer, {
                attributes: true,
                attributeFilter: ['style']
            });
        }
        
        // Correction initiale apr√®s un d√©lai
        setTimeout(fixCardEntities, 1500);
        setTimeout(fixCardEntities, 3000);
    }

    // D√©marrage de l'application
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
        initializeSearchAndFilters();
        initializeMobileToggle();
        initializeKeyboardNavigation();
        initializeModeSwitcher();
        
        // Configurer la correction des entit√©s HTML pour les cards
        setupCardEntityFix();
        
        // G√©rer le clic en dehors de la modal pour la fermer
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Corriger sp√©cifiquement le bouton reset si n√©cessaire
        const resetButton = document.getElementById('reset-map');
        if (resetButton && resetButton.textContent.includes('\\u')) {
            resetButton.textContent = 'R√©initialiser la carte';
        }
        
        // Corriger si Drupal transforme en entit√©s HTML
        setTimeout(() => {
            const resetBtn = document.getElementById('reset-map');
            if (resetBtn && (resetBtn.textContent.includes('&') || resetBtn.textContent.includes('\\u'))) {
                resetBtn.textContent = 'R√©initialiser la carte';
            }
        }, 1000);
    });

    function initializeSearchAndFilters() {
        
    }

    function initializeMobileToggle() {
        const mobileToggle = document.getElementById('mobile-toggle');
        const mapContainer = document.getElementById('map-container');
        
        function checkMobile() {
            if (window.innerWidth <= 768) {
                mobileToggle.style.display = 'flex';
            } else {
                mobileToggle.style.display = 'none';
            }
        }
        
        checkMobile();
        window.addEventListener('resize', checkMobile);
        
        mobileToggle.addEventListener('click', () => {
            if (currentLayoutMode === 'dual') {
                switchToMapFullScreen();
                document.getElementById('mobile-toggle-icon').setAttribute('d', 'M4 6H20M4 12H20M4 18H11');
            } else if (currentLayoutMode === 'mapFull') {
                switchToSidebarFullScreen();
                document.getElementById('mobile-toggle-icon').setAttribute('d', 'M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z');
            } else {
                switchToDualView();
                document.getElementById('mobile-toggle-icon').setAttribute('d', 'M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z');
            }
        });
    }

    function initializeKeyboardNavigation() {
        // Navigation au clavier dans la liste d'√©tablissements
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // Fermer les popups
                activePopups.forEach(p => p.remove());
                activePopups.length = 0;
                
                // Fermer la modal si elle est ouverte
                const modal = document.getElementById('modal');
                if (modal && modal.style.display === 'block') {
                    closeModal();
                }
            }
        });
    }

    // Fonction globale pour changer de mode (utilis√©e par le switcher sur la carte)
    function switchMode(mode) {
        const modeNormalBtn = document.getElementById('mode-normal');
        const modeRouteBtn = document.getElementById('mode-route');
        
        if (mode === 'normal') {
            if (window.switchToNormalMode) window.switchToNormalMode();
            if (modeNormalBtn) modeNormalBtn.classList.add('active');
            if (modeRouteBtn) modeRouteBtn.classList.remove('active');
        } else if (mode === 'route') {
            if (window.switchToRouteMode) window.switchToRouteMode();
            if (modeNormalBtn) modeNormalBtn.classList.remove('active');
            if (modeRouteBtn) modeRouteBtn.classList.add('active');
        }
    }
    
    // Initialisation du mode switcher
    function initializeModeSwitcher() {
        const modeNormalBtn = document.getElementById('mode-normal');
        const modeRouteBtn = document.getElementById('mode-route');
        const normalInterface = document.getElementById('normal-mode-interface');
        const routeInterface = document.getElementById('route-mode-interface');
        
        // Exposer le mode actuel globalement pour que d'autres fonctions puissent le v√©rifier
        window.currentAppMode = 'normal';
        let normalGeocoder = null;
        // Rendre normalGeocoder accessible globalement
        window.normalGeocoder = null;

        // Fonction pour basculer vers le mode normal (expos√©e globalement)
        window.switchToNormalMode = function() {
            window.currentAppMode = 'normal';
            
            // Mise √† jour des boutons
            modeNormalBtn.classList.add('active');
            modeRouteBtn.classList.remove('active');
            
            // Afficher/Masquer les interfaces
            normalInterface.style.display = 'block';
            routeInterface.style.display = 'none';
            
            // Masquer le bouton d'ajout de destination
            const addDestBtn = document.getElementById('add-destination-btn');
            if (addDestBtn) addDestBtn.style.display = 'none';
            
            // Masquer la section point B si elle √©tait visible
            const pointBSection = document.getElementById('point-b-section');
            if (pointBSection) pointBSection.style.display = 'none';
            
            // Effacer les routes si elles existent
            clearRoute();
            
            // R√©initialiser les s√©lections d'itin√©raire
            clearRoutePoints();
            
            // Rafra√Æchir les cards pour mettre √† jour le style de curseur
            updateSidebarBasedOnMapViewport();
        }

        // Fonction pour basculer vers le mode itin√©raire (expos√©e globalement)
        window.switchToRouteMode = function() {
            window.currentAppMode = 'route';
            
            // Mise √† jour des boutons
            modeNormalBtn.classList.remove('active');
            modeRouteBtn.classList.add('active');
            
            // Afficher/Masquer les interfaces
            normalInterface.style.display = 'none';
            routeInterface.style.display = 'block';
            
            // Afficher le bouton d'ajout de destination en mode route
            const addDestBtn = document.getElementById('add-destination-btn');
            if (addDestBtn) addDestBtn.style.display = 'block';
            
            // Rafra√Æchir les cards pour mettre √† jour le style de curseur
            updateSidebarBasedOnMapViewport();
        }

        // Fonction pour effacer les points de route
        function clearRoutePoints() {
            // R√©initialiser point A
            const selectedPointA = document.getElementById('selected-point-a');
            const pointAName = document.getElementById('point-a-name');
            if (selectedPointA) selectedPointA.style.display = 'none';
            if (pointAName) pointAName.textContent = '';
            if (window.pointAData) window.pointAData = null;
            
            // R√©initialiser point B
            const selectedPointB = document.getElementById('selected-point-b');
            const pointBName = document.getElementById('point-b-name');
            if (selectedPointB) selectedPointB.style.display = 'none';
            if (pointBName) pointBName.textContent = '';
            if (window.pointBData) window.pointBData = null;
        }

        // Fonction pour effacer la route de la carte
        function clearRoute() {
            if (map && map.getSource('route')) {
                if (map.getLayer('route')) {
                    map.removeLayer('route');
                }
                map.removeSource('route');
            }
            
            // Supprimer les markers de route s'ils existent
            if (window.routeMarkers) {
                window.routeMarkers.forEach(marker => marker.remove());
                window.routeMarkers = [];
            }
        }

        // Initialiser le geocoder pour le mode normal apr√®s le chargement de la carte
        function initializeNormalGeocoder() {
            if (!map || normalGeocoder) return;
            
            const geocoderContainer = document.getElementById('normal-geocoder-container');
            if (!geocoderContainer) return;
            
            normalGeocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl,
                placeholder: 'Rechercher une ville ou UP...',
                countries: 'fr',
                language: 'fr',
                localGeocoder: localUPGeocoder,
                localGeocoderOnly: false,
                limit: 8
            });
            
            // Rendre accessible globalement pour le reset
            window.normalGeocoder = normalGeocoder;
            
            // Ajouter le geocoder avant le bouton de g√©olocalisation
            const geolocateBtn = document.getElementById('normal-geolocate');
            if (geolocateBtn && geolocateBtn.parentNode) {
                geolocateBtn.parentNode.insertBefore(normalGeocoder.onAdd(map), geolocateBtn);
            } else {
                geocoderContainer.appendChild(normalGeocoder.onAdd(map));
            }
            
            // G√©rer les r√©sultats de recherche
            normalGeocoder.on('result', function(e) {
                if (e.result && e.result.geometry) {
                    // D√©finir le centre de recherche
                    currentSearchCenter = e.result.geometry.coordinates;
                    
                    // Afficher le contr√¥le de rayon et d√©finir √† 80 km
                    showRadiusControl();
                    currentSearchRadius = 80;
                    const radiusSlider = document.getElementById('radius-slider');
                    if (radiusSlider) radiusSlider.value = 80;
                    const radiusValue = document.getElementById('radius-value');
                    if (radiusValue) radiusValue.textContent = "80 km";
                    
                    // Dessiner le cercle de 80 km autour du point s√©lectionn√©
                    drawSearchRadiusCircle(currentSearchCenter, 80);
                    
                    map.flyTo({
                        center: e.result.geometry.coordinates,
                        zoom: 12,
                        duration: 1500
                    });
                    
                    // Appliquer les filtres avec le rayon de 80 km apr√®s le zoom
                    setTimeout(() => {
                        applyFilters();
                    }, 1600);
                }
            });
        }

        // Attendre que la carte soit initialis√©e
        const checkMapInterval = setInterval(() => {
            if (window.map) {
                clearInterval(checkMapInterval);
                initializeNormalGeocoder();
            }
        }, 100);

        // Event listeners pour les boutons
        modeNormalBtn.addEventListener('click', window.switchToNormalMode);
        modeRouteBtn.addEventListener('click', window.switchToRouteMode);

        // G√©olocalisation pour le mode normal
        const normalGeolocateBtn = document.getElementById('normal-geolocate');
        if (normalGeolocateBtn) {
            normalGeolocateBtn.addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const userLocation = [position.coords.longitude, position.coords.latitude];
                            
                            // D√©finir le centre de recherche
                            currentSearchCenter = userLocation;
                            
                            // Afficher le contr√¥le de rayon et d√©finir √† 80 km
                            showRadiusControl();
                            currentSearchRadius = 80;
                            const radiusSlider = document.getElementById('radius-slider');
                            if (radiusSlider) radiusSlider.value = 80;
                            const radiusValue = document.getElementById('radius-value');
                            if (radiusValue) radiusValue.textContent = "80 km";
                            
                            // Dessiner le cercle de 80 km
                            drawSearchRadiusCircle(userLocation, 80);
                            
                            // Zoomer pour voir tout le rayon
                            map.flyTo({
                                center: userLocation,
                                zoom: 9.5,
                                duration: 1500
                            });
                            
                            // Supprimer l'ancien marker s'il existe
                            if (userLocationMarker) {
                                userLocationMarker.remove();
                            }
                            
                            // Ajouter un nouveau marker pour la position de l'utilisateur
                            userLocationMarker = new mapboxgl.Marker({ color: '#FF0000' })
                                .setLngLat(userLocation)
                                .addTo(map);
                            
                            // Appliquer les filtres avec le rayon de 80 km
                            applyFilters();
                            
                            // Mettre √† jour les √©tablissements visibles
                            setTimeout(() => {
                                updateSidebarBasedOnMapViewport();
                            }, 1600);
                        },
                        function(error) {
                            alert('Impossible de r√©cup√©rer votre position: ' + error.message);
                        }
                    );
                } else {
                    alert('La g√©olocalisation n\'est pas support√©e par votre navigateur');
                }
            });
        }

        // Initialiser en mode normal par d√©faut
        window.switchToNormalMode();
    }


</script>
</body>
</html>