<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte des Établissements</title>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.css' />
  <link href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js'></script>
  
<style>
body,html{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;overflow:hidden}#map-container{display:flex;height:85vh;width:100vw;overflow:hidden;position:relative;transition:height .3s ease-in-out}#sidebar{width:30%;min-width:415px;max-width:450px;background-color:#fff;padding:20px;box-sizing:border-box;display:flex;flex-direction:column;height:100%;transition:width .5s ease-in-out,opacity .5s ease-in-out,transform .5s ease-in-out,min-width .5s ease-in-out;overflow-x:hidden;z-index:20}#map{width:70%;height:100%;transition:width .5s ease-in-out,opacity .5s ease-in-out;opacity:1;z-index:10}.filter-section{margin-bottom:20px}.filter-section h2{margin-bottom:10px;font-size:18px;color:#333}#geocoder-container{display:flex;align-items:center;gap:5px}.geolocate-btn{background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23333" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>') center/18px no-repeat;width:34px;height:34px;border:1px solid #ccc;border-radius:4px;cursor:pointer;background-color:#fff;flex-shrink:0}.filter-controls-inline{display:flex;justify-content:flex-start;align-items:center;flex-wrap:wrap;gap:15px}.radius-control-group,.activity-control-group{display:flex;align-items:center;gap:8px}.activity-control-group label,.radius-control-group label{font-size:14px;white-space:nowrap;color:#333}#activity-filter{padding:8px;box-sizing:border-box;border:1px solid #ccc;border-radius:4px;min-width:150px;flex-grow:1}#radius-slider{flex-grow:1;cursor:pointer}#radius-value{font-weight:bold;color:#002060;min-width:45px}.mapboxgl-ctrl-geocoder{margin-left:0!important;min-width:0;flex-grow:1}#results-count{font-size:14px;color:#555;margin-top:15px;font-weight:bold}#establishments-view{flex-grow:1;overflow-y:auto;margin-top:5px}.establishment-card{background:#fff;margin:6px 8px 10px 7px;padding:11px 15px 0 20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.38);cursor:pointer;transition:transform .2s,box-shadow .2s;font-family:Arial,sans-serif}.establishment-card:hover{transform:scale(1.02);box-shadow:0 4px 8px rgba(0,0,0,.15)}.establishment-card h3{font-size:16px;color:#002060;margin:0 0 5px 0}.establishment-card p{font-size:14px;color:#333;margin:0 0 12px 0}.establishment-card a{color:#002060;text-decoration:none}.establishment-card a:hover{text-decoration:underline}.establishment-card .more-info{font-size:12px;color:#ff9900;margin-top:10px;display:block}#reset-map{width:100%;padding:10px;background-color:#555;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:16px;transition:background-color .3s}#reset-map:hover{background-color:#333}#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);z-index:9999;display:flex;justify-content:center;align-items:center;font-size:20px;color:#333;transition:opacity .5s}.mapboxgl-popup-content{width:max-content;font-family:Arial,sans-serif;padding:15px!important;max-width:280px!important}.mapboxgl-popup-content h3{color:#002060;margin:0 0 10px 0;font-size:16px}.mapboxgl-popup-content p{margin:0 0 5px 0;line-height:1.4;font-size:14px}.mapboxgl-popup-content p strong{color:#333;font-weight:bold}#map>div.mapboxgl-control-container>div.mapboxgl-ctrl-bottom-right,#map>div.mapboxgl-control-container>div.mapboxgl-ctrl-bottom-left{display:none}.modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:600px;border-radius:8px}.close-button{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close-button:hover,.close-button:focus{color:#000;text-decoration:none}.view-switcher{position:fixed;top:83px;right:28px;z-index:1005;padding:10px 15px;background-color:#002060;color:#fff;border:0;border-radius:5px;cursor:pointer;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,.2);display:none;transition:background-color .3s}.view-switcher:hover{background-color:#003380}#map-container.layout-dual #sidebar{width:30%;min-width:415px;opacity:1;transform:translateX(0)}#map-container.layout-dual #map{width:calc(100% - max(30%,415px));opacity:1}#map-container.layout-sidebar-full{height:100vh}#map-container.layout-sidebar-full #sidebar{width:94%;min-width:94%;opacity:1;transform:translateX(0)}#map-container.layout-sidebar-full #map{width:0;opacity:0;pointer-events:none}#map-container.layout-map-full{height:100vh}#map-container.layout-map-full #sidebar{width:0;min-width:0;opacity:0;transform:translateX(-100%);pointer-events:none}#map-container.layout-map-full #map{width:100%;opacity:1}@media (max-width:1383px){#map-container.layout-dual #sidebar{width:415px}#map-container.layout-dual #map{width:calc(100% - 415px)}}@media (max-width:600px){.radius-control-group,.activity-control-group{scale:.8;max-width:121px}#map-container.layout-sidebar-full #sidebar{width:100%;min-width:88%}}.card-actions{display:flex;gap:10px;margin-top:10px;padding-bottom:5px}.action-btn{flex:1;padding:8px 5px;border-radius:4px;color:#fff!important;text-align:center;text-decoration:none;font-size:14px;transition:transform .2s,background-color .2s}.action-btn:hover{transform:scale(1.05);text-decoration:none}.action-btn.call{background-color:#28a745}.action-btn.call:hover{background-color:#218838}.action-btn.mail{background-color:#007bff}.action-btn.mail:hover{background-color:#0069d9}.action-btn.route{background-color:#17a2b8}.action-btn.route:hover{background-color:#138496}.action-btn:disabled{background-color:#6c757d!important;cursor:not-allowed;transform:none}.action-btn:disabled:hover{transform:none}
/* Légende de la carte */
.map-legend{position:absolute;bottom:30px;left:10px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:100;font-size:13px}.map-legend h4{margin:0 0 8px 0;font-size:14px;color:#333;font-weight:bold}.legend-item{display:flex;align-items:center;margin:6px 0}.legend-marker{width:30px;height:30px;margin-right:8px;background-size:contain;background-repeat:no-repeat;background-position:center}.legend-marker.beton{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-beton.png')}.legend-marker.granulats{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-granulats.png')}.legend-marker.ciment{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-ciment.png')}.legend-marker.ciment-prompt{background-image:url('https://www.solutions-vicat.fr/sites/default/files/2024-12/ciment-prompt-naturel.png')}

/* Clustering */
.cluster-marker{background:#555;border:3px solid #fff;border-radius:50%;color:#fff;font-weight:bold;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:transform .2s}.cluster-marker:hover{transform:scale(1.1)}.cluster-small{width:35px;height:35px;background:#555}.cluster-medium{width:45px;height:45px;background:#333}.cluster-large{width:55px;height:55px;background:#222}

/* Barre de recherche */
.search-container{position:relative;margin-bottom:15px}.search-input{width:100%;padding:10px 35px 10px 12px;border:1px solid #ccc;border-radius:4px;font-size:14px;box-sizing:border-box}.search-input:focus{outline:none;border-color:#002060}.search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#999;cursor:pointer;font-size:18px;padding:5px}.search-clear:hover{color:#333}

/* Indicateurs de distance */
.distance-badge{display:inline-block;background:#002060;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:bold;margin-left:8px}.time-badge{display:inline-block;background:#28a745;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:bold;margin-left:5px}

/* Accessibilité */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}*:focus-visible{outline:2px solid #002060;outline-offset:2px}button:focus-visible,a:focus-visible{outline:2px solid #002060;outline-offset:2px}

/* Mobile responsive amélioré */
@media (max-width:768px){.map-legend{bottom:60px;left:5px;padding:8px;font-size:12px}.legend-item{margin:4px 0}.legend-marker{width:24px;height:24px;margin-right:6px}.mobile-toggle-btn{position:fixed;bottom:20px;right:20px;z-index:1007;background:#002060;color:#fff;border:none;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 10px rgba(0,0,0,.3);cursor:pointer;transition:all .3s}.mobile-toggle-btn:hover{transform:scale(1.1);background:#003380}.mobile-toggle-btn svg{width:24px;height:24px}}
</style>

</head>
<body>
  <div id="loading-overlay">Chargement de la carte...</div>

  <button id="view-switcher" class="view-switcher">Afficher Carte</button>


  <div id="map-container">
    <div id="sidebar">
      <!-- Barre de recherche -->
      <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Rechercher un établissement..." aria-label="Rechercher un établissement">
        <button class="search-clear" id="search-clear" aria-label="Effacer la recherche" style="display:none;">×</button>
      </div>

      <div class="filter-section">
        <div id="geocoder-container">
          <button id="geolocate" class="geolocate-btn" title="Utiliser ma position"></button>
        </div>
      </div>

      <div class="filter-section filter-controls-inline">
        <div class="radius-control-group">
          <label for="radius-slider">Rayon:</label>
          <input type="range" id="radius-slider" value="30" min="1" max="200" step="1">
          <span id="radius-value">30 km</span>
        </div>
        <div class="activity-control-group">
          <label for="activity-filter">Activité:</label>
          <select id="activity-filter">
            <option value="">Toutes activités</option>
          </select>
        </div>
      </div>

      <div class="filter-section">
        <button id="reset-map">Réinitialiser la carte</button>
      </div>
      
      <div id="results-count"></div>
      <div id="establishments-view"></div>
    </div>
    <div id="map">
      <!-- Légende de la carte (overlay sur la carte) -->
      <div class="map-legend" id="map-legend" style="display:none;">
        <h4>Légende</h4>
        <div class="legend-item">
          <div class="legend-marker beton"></div>
          <span>Béton</span>
          <span class="distance-badge" id="beton-count">0</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker granulats"></div>
          <span>Granulats</span>
          <span class="distance-badge" id="granulats-count">0</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker ciment"></div>
          <span>Ciment</span>
          <span class="distance-badge" id="ciment-count">0</span>
        </div>
        <div class="legend-item" id="ciment-prompt-legend" style="display:none;">
          <div class="legend-marker ciment-prompt"></div>
          <span>Ciment Prompt</span>
          <span class="distance-badge" id="ciment-prompt-count">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bouton mobile pour basculer carte/liste -->
  <button class="mobile-toggle-btn" id="mobile-toggle" aria-label="Basculer vue" style="display:none;">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path id="mobile-toggle-icon" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
    </svg>
  </button>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-button">×</span>
      <div id="modal-info"></div>
    </div>
  </div>

<script>
    // Configuration
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ2hpc2xhaW5sZXZyYXQiLCJhIjoiY2x0ZTRlYTFpMGM4ZTJrcGI1OWFsNXRjcSJ9.63vk7d4NVv3i75ozPADUbw';

    // Variables globales
    let map;
    let geocoder;
    let directions;
    let currentSearchCenter = null;
    let currentSearchRadius = 30;
    let currentLayoutMode = 'dual';
    let primaryFilteredFeatures = [];
    let currentMapboxMarkers = [];
    let activePopups = [];
    let debounceTimer;
    let currentRouteSource = null;
    const VIEW_MODE_THRESHOLD = 700;
    
    // Nouvelles variables pour les améliorations
    let searchQuery = '';
    let sortByDistance = true;
    
    // Données des établissements
    const establishmentsData = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LUXEUIL", "Adresse": "4 Rue des Prés", "Ville": "Saint-Sauveur", "Code postal": "70300", "Phone": "03 84 40 36 82", "Email": "beton.luxeuil@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.8278029, 47.7370072] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - AMBERIEU-EN-BUGEY", "Adresse": "980 route des carrières", "Ville": "Ambronay", "Code postal": "01500", "Phone": "04 74 36 99 14", "Email": "beton.amberieuenbugey@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.3469648361206055, 46.021080017089844] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - HERIMENIL", "Adresse": "La Cour Déguillette", "Ville": "Réhainviller", "Code postal": "54300", "Phone": "03 29 86 76 15", "Email": "beton.herimenil@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.477688312530518, 48.57072448730469] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MEXIMIEUX", "Adresse": "Route St Maurice de Gourdans", "Ville": "Pérouges", "Code postal": "01800", "Phone": "04 74 46 08 41", "Email": "beton.meximieux@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.191800117492676, 45.89667510986328] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BEAUNE", "Adresse": "Rue du Docteur Barolet", "Ville": "Vignoles", "Code postal": "21200", "Phone": "03 85 38 01 10", "Email": "beton.beaune@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.8679518699646, 47.02422332763672] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BOURG-LES-VALENCE", "Adresse": "Lieu-dit l'Armailler", "Ville": "Chateauneuf-sur-Isère", "Code postal": "26300", "Phone": "04 75 83 47 53", "Email": "beton.bourglesvalence@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.889292, 44.978434] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MALATAVERNE", "Adresse": "ZAC des Plaines", "Ville": "Malataverne", "Code postal": "26780", "Phone": "04 75 90 81 16", "Email": "beton.malataverne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.759271, 44.465050] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CREST", "Adresse": "Quartier Chaumiane", "Ville": "Divajeu", "Code postal": "26400", "Phone": "04 75 76 80 60", "Email": "beton.crest@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.984421125824487, 44.73059383446513] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - SAINT MARCELLIN", "Adresse": "ZI la Gloriette", "Ville": "Chatte", "Code postal": "38100", "Phone": "04 76 64 05 07", "Email": "beton.stmarcellin@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.2994366, 45.1398532] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - L'ARBRESLE", "Adresse": "Le Moiné, route de Lauzanne", "Ville": "Nuelles", "Code postal": "69210", "Phone": "04 74 01 18 45", "Email": "beton.larbresle@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.634372297885533, 45.84405368765808] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CHÂLON SUR SAÔNE", "Adresse": "19 rue Férrée", "Ville": "Crissey", "Code postal": "71530", "Phone": "03 85 46 15 44", "Email": "beton.chalonsursaone@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.862700409755355, 46.81515376893618] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - NANCY", "Adresse": "ZI des clais chênes", "Ville": "Chavigny", "Code postal": "54230", "Phone": "03 83 44 02 44", "Email": "beton.nancy@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1396337262534875, 48.647642870040876] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - St ROMAIN EN GAL", "Adresse": "Zone portuaire CNR", "Ville": "Saint-Germain-au-Mont-d'Or", "Code postal": "69560", "Phone": "04 72 30 14 07", "Email": "beton.stromainengal@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.834036131213699, 45.54622652007517] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - SAINT QUENTIN FALLAVIER", "Adresse": "Rue de la Pierre-Millière", "Ville": "Saint-Quentin-Fallavier", "Code postal": "38200", "Phone": "04 74 94 21 36", "Email": "beton.stquentinfallavier@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.121313128076019, 45.644587261118026] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - TARARE", "Adresse": "Lieu-dit Le Mortier", "Ville": "Poncharra sur Turdine", "Code postal": "69490", "Phone": "04 74 05 02 05", "Email": "beton.tarare@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.4737393291702725, 45.88480938955108] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BORDEROUGE", "Adresse": "10 impasse Paul Harris", "Ville": "Toulouse", "Code postal": "31200", "Phone": "05 34 25 08 66", "Email": "beton.borderouge@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.4487552718081338, 43.64923484442168] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - SAINT GERMAIN DES FOSSES", "Adresse": "Chemin du pont des îles", "Ville": "Vichy", "Code postal": "03260", "Phone": "04 70 59 67 35", "Email": "beton.stgermaindesfosses@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.4223448491246224, 46.20666434745773] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - GUERET", "Adresse": "Le Masgerot", "Ville": "Saint Sulpice le Guérétois", "Code postal": "23000", "Phone": "05 55 52 77 71", "Email": "beton.gueret@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.8380017025266484, 46.189182811122386] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BOURG EN BRESSE", "Adresse": "9 Rue des Crêts", "Ville": "Bourg en Bresse", "Code postal": "01000", "Phone": "04 74 23 46 48", "Email": "beton.bourgenbresse@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.224688204489039, 46.21993457215142] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CHÂTILLON SUR CHALARONNE", "Adresse": "Lieu-dit Champ de l'Allée, ZI Nord", "Ville": "Châtillon-sur-Chalaronne", "Code postal": "01400", "Phone": "04 74 55 50 12", "Email": "beton.chatillonsurchalaronne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.945347744057035, 46.12426485423063] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VICHY SUD", "Adresse": "Route d'Haute Rive", "Ville": "Abrest", "Code postal": "03200", "Phone": "04 70 32 19 00", "Email": "beton.abrest@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.4341453655199574, 46.10402332383727] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - JASSANS-RIOTTIER", "Adresse": "Rue du 3 septembre 44", "Ville": "Jassans Riottier", "Code postal": "01480", "Phone": "04 74 09 96 91", "Email": "beton.jassans-riottier@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.754265871994541, 45.98884270369173] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MONTLUÇON", "Adresse": "Pont de Vaux", "Ville": "Estivareilles", "Code postal": "03190", "Phone": "04 70 06 01 05", "Email": "beton.estivareilles@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.6005321401916706, 46.429078273218025] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CROZET", "Adresse": "Z.I. 212 Rue de la Vie Chatelme", "Ville": "Crozet", "Code postal": "01170", "Phone": "04 50 42 15 01", "Email": "beton.crozet@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.022756230104438, 46.266538545287474] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LA ROQUETTE", "Adresse": "1081 Chemin de la Levade", "Ville": "La Roquette sur Siagne", "Code postal": "06550", "Phone": "06 12 91 97 85", "Email": "beton.roquette@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.943274058448792, 43.576986763042726] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - JARJAYES", "Adresse": "Lieu-dit la Madeleine - Les Mânes", "Ville": "Jarjayes", "Code postal": "05130", "Phone": "04 92 50 44 95", "Email": "beton.jarjayes@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.093213821355874, 44.48282523501814] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - GAP", "Adresse": "29 Route de Saint Jean", "Ville": "Gap", "Code postal": "05000", "Phone": "04 92 51 01 36", "Email": "beton.gap@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.047677702003625, 44.53935442486306] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - NICE VAR", "Adresse": "79 Boulevard Jean LUCIANO", "Ville": "Nice", "Code postal": "06200", "Phone": "06 16 12 19 09", "Email": "beton.nicevar@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [7.195868396709341, 43.68654779334091] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - DOMPIERRE", "Adresse": "Rue de l' écluse", "Ville": "Dompierre-sur-Besbre", "Code postal": "03290", "Phone": "04 70 34 50 90", "Email": "beton.dompierre@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.7017209699746023, 46.542232459053196] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CROTS", "Adresse": "Z.A. les Moulins", "Ville": "Crots", "Code postal": "05200", "Phone": "04 92 43 13 37", "Email": "beton.crots@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.445663424536943, 44.53561162210869] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - RIBIERS", "Adresse": "Quartier le Virail", "Ville": "Ribiers", "Code postal": "05300", "Phone": "04 92 62 25 17", "Email": "beton.ribiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.901160373181472, 44.2084945381101] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MENTON", "Adresse": "Z.I. Haut Carei - 971 Avenue de St Roman", "Ville": "Menton", "Code postal": "06500", "Phone": "06 11 30 84 57", "Email": "beton.menton@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [7.487003299999999, 43.8071439] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VALBONNE", "Adresse": "100 chemin des Clausonnes", "Ville": "Valbonne", "Code postal": "06560", "Phone": "06 11 30 84 66", "Email": "beton.menton@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [7.051935192027538, 43.60717987750158] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BOURG DE PÉAGE", "Adresse": "116 Allée du Vivarais", "Ville": "Bourg de Péage", "Code postal": "26300", "Phone": "04 75 02 84 10", "Email": "beton.bourgdepeage@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.0340255992184755, 45.02032338571791] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BOURGES", "Adresse": "Z.I. Rue Voltaire", "Ville": "Saint Germain du Puy", "Code postal": "18390", "Phone": "02 48 70 38 75", "Email": "beton.bourges@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.442654273224061, 47.102261728646994] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MOULINS", "Adresse": "Rue des Cheminots", "Ville": "Yzeure", "Code postal": "03400", "Phone": "04 70 32 77 78", "Email": "beton.moulins@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.348134347868352, 46.552932861617144] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - PORTES-LES-VALENCE", "Adresse": "8 rue Jean Jaurès", "Ville": "Portes-lès-Valence", "Code postal": "26800", "Phone": "04 75 57 16 00", "Email": "beton.porteslesvalence@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.876573245526226, 44.88588867466865] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - COLOMIERS", "Adresse": "11 Chemin de Chasse", "Ville": "Colomiers", "Code postal": "31770", "Phone": "05 62 74 85 81", "Email": "beton.colomiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.3116828374391245, 43.60566093264553] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - St AMAND MONTROND", "Adresse": "Rue Sarrault - Lieu dit les Epousardes", "Ville": "Saint Amand Montrond", "Code postal": "18200", "Phone": "02 48 56 42 12", "Email": "beton.stamand@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.4922138596501946, 46.74294570114782] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BRIVE-LA-GAILLARDE", "Adresse": "ZI Cana Ouest - Rue Jules Bouchet", "Ville": "Brive-la-Gaillarde", "Code postal": "19100", "Phone": "05 55 88 25 25", "Email": "beton.brive@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.482992352790208, 45.159192408466375] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - Loriol", "Adresse": "Route de Crest RN 7", "Ville": "Loriol-sur-Drôme", "Code postal": "26270", "Phone": "04 75 61 62 20", "Email": "beton.loriol@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.842658539278163, 44.7643023820668] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CARBONNE", "Adresse": "31 Route de Lançon", "Ville": "Carbonne", "Code postal": "31390", "Phone": "05 61 98 40 81", "Email": "beton.carbonne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.218098912227801, 43.325254064604735] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - St MARTIN D'HERES", "Adresse": "16 Rue Barnave", "Ville": "Saint Martin d'Hères", "Code postal": "38400", "Phone": "04 76 42 38 34", "Email": "beton.stmartindheres@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.761762727644929, 45.189108923281076] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VOREPPE", "Adresse": "Chemin de Jongkind", "Ville": "Voreppe", "Code postal": "38340", "Phone": "04 76 42 38 34", "Email": "beton.voreppe@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.623704696970177, 45.29081178001097] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BOURGOIN-JALLIEU", "Adresse": "Rue du Premier Film", "Ville": "Bourgoin-Jallieu", "Code postal": "38300", "Phone": "04 74 09 82 12", "Email": "beton.bourgoin@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.250518310635885, 45.5977665134811] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VILLARD BONNOT", "Adresse": "Rue des Eaux Claires - Quai des Négociants", "Ville": "Villard Bonnot", "Code postal": "38190", "Phone": "04 74 09 82 12", "Email": "beton.villardbonnot@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.884391781628484, 45.24009960770652] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ROMAGNIEU", "Adresse": "Le Vorget", "Ville": "Romagnieu", "Code postal": "38480", "Phone": "04 76 37 09 55", "Email": "beton.romagnieu@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.647105325817201, 45.57598473757716] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VARCES", "Adresse": "22 impasse du Pré de l'Orme", "Ville": "Varces Allières et Risset", "Code postal": "38760", "Phone": "04 76 98 02 25", "Email": "beton.varces@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.684963641136855, 45.109261654253785] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MONISTROL", "Adresse": "Z.I. le Chavanon", "Ville": "Monistrol sur Loire", "Code postal": "43120", "Phone": "04 71 66 02 47", "Email": "beton.monistrol@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.184144539299922, 45.278947761729555] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ROQUES", "Adresse": "9 chemin de Bonnafous", "Ville": "Roques", "Code postal": "31120", "Phone": "05 34 46 57 57", "Email": "beton.roques@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.3438995734627237, 43.49380561160298] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ROANNE", "Adresse": "Impasse de la Marne", "Ville": "Roanne", "Code postal": "42300", "Phone": "04 77 68 40 22", "Email": "beton.roanne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.085835152828749, 46.060888473162755] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - FENOUILLET", "Adresse": "Route de Paris", "Ville": "Fenouillet", "Code postal": "31150", "Phone": "05 61 70 22 02", "Email": "beton.fenouillet@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.4046435545727955, 43.685889047534545] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - RIVES", "Adresse": "Z.I. le Levatel", "Ville": "Rives", "Code postal": "38140", "Phone": "04 76 91 04 56", "Email": "beton.rives@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.492731625808071, 45.36185645382537] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VILLARD DE LANS", "Adresse": "Z.I. des Geymonds", "Ville": "Villard de Lans", "Code postal": "38250", "Phone": "04 76 42 38 34", "Email": "beton.villarddelans@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.560425912301044, 45.087240043618245] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - Villiers", "Adresse": "373 Rte de Saint-Hilaire Lieu-dit", "Ville": "Villers", "Code postal": "42460", "Phone": "04 77 60 67 52", "Email": "beton.villers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.214865268170912, 46.12271438883505] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - YSSINGEAUX", "Adresse": "ZA de Lavée", "Ville": "Yssingeaux", "Code postal": "43202", "Phone": "04 71 65 53 09", "Email": "beton.yssingeaux@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.107974827643314, 45.151815430013556] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CHAUMONT", "Adresse": "Faubourg des 4 Moulins", "Ville": "Chaumont", "Code postal": "52000", "Phone": "03 25 03 20 53", "Email": "beton.chaumont@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.145920454764028, 48.13284453916601] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VERDUN", "Adresse": "Boulevard de la Citadelle", "Ville": "Verdun", "Code postal": "55100", "Phone": "03 29 84 75 02", "Email": "beton.verdun@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.376926754809797, 49.14469611884587] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LE MONTEIL", "Adresse": "Le Monteil", "Ville": "Brives Charensac", "Code postal": "43700", "Phone": "04 71 09 30 74", "Email": "beton.lemonteil@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.9043044457226506, 45.077934998086626] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - NOGENT EN BASSIGNY", "Adresse": "Z.I. Rue Lavoisier", "Ville": "Nogent en Bassigny", "Code postal": "52800", "Phone": "03 25 32 08 85", "Email": "beton.nogentenbassigny@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.351522067218357, 48.03746854660595] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - NEVERS", "Adresse": "Zone Industrielle de Varennes Vauzelles", "Ville": "Varennes Vauzelles", "Code postal": "58640", "Phone": "03 86 93 95 62", "Email": "beton.nevers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.1701864856904454, 46.985517129456355] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VILLEURBANNE", "Adresse": "23 rue Eugène Pottier", "Ville": "Villeurbanne", "Code postal": "69100", "Phone": "04 78 80 90 30", "Email": "beton.villeurbanne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.896799199999999, 45.7869313] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LONGEVILLE LES SAINTS AVOLD", "Adresse": "Z.I. Route Faulquemont", "Ville": "Longeville-lès-Saint-Avold", "Code postal": "57740", "Phone": "03 85 34 90 44", "Email": "beton.longeville@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.652884053366776, 49.10642949807357] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - THIERS", "Adresse": "Z.I. Felet", "Ville": "Thiers", "Code postal": "63300", "Phone": "04 73 80 12 10", "Email": "beton.thiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [3.499988353114896, 45.85501609131025] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MEYZIEU", "Adresse": "Rue de la République", "Ville": "Meyzieu", "Code postal": "69330", "Phone": "04 72 02 72 62", "Email": "beton.meyzieu@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.0121505151001005, 45.76523805095096] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - St NICOLAS DE PORT", "Adresse": "ZAC de la Croisette", "Ville": "Saint Nicolas de Port", "Code postal": "54210", "Phone": "03 83 46 70 66", "Email": "beton.stnicolasdeport@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.2828399918562265, 48.620996870898104] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MOUTIER", "Adresse": "69 Rue des Érables", "Ville": "Moûtiers", "Code postal": "73600", "Phone": "04 79 24 28 23", "Email": "beton.moutiers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.531556, 45.485149] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CHAMBERY", "Adresse": "170 Rue des Epinettes", "Ville": "La Motte Servolex", "Code postal": "73290", "Phone": "04 79 62 08 37", "Email": "beton.chambery@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.8845151, 45.6096785] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - HAUTE TARENTAISE", "Adresse": "Lieu dit des Glières", "Ville": "Villaroger", "Code postal": "73640", "Phone": "04 79 07 69 56", "Email": "beton.hautetarentaise@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.791576831947458, 45.6236240935254] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VILLE LA GRAND", "Adresse": "12 Rue du Bois de la Rose", "Ville": "Ville la Grand", "Code postal": "74100", "Phone": "04 50 87 05 00", "Email": "beton.annemasse@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.276416, 46.205611] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - FLUMET", "Adresse": "Le Jorat RN 112", "Ville": "Flumet", "Code postal": "73590", "Phone": "04 79 31 11 95", "Email": "beton.flumet@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.516386, 45.819302] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MONTMELIAN", "Adresse": "207 route de la carrière", "Ville": "La Chavanne", "Code postal": "73800", "Phone": "04 79 84 22 86", "Email": "beton.montmelian@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.069366, 45.498925] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VOURLES", "Adresse": "Z.A. du Pont à Lunettes", "Ville": "Vourles", "Code postal": "69390", "Phone": "04 72 31 10 76", "Email": "beton.vourles@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.7636803, 45.65307989999999] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - PUSEY", "Adresse": "ZAC de l'Oasis", "Ville": "Pusey", "Code postal": "70000", "Phone": "03 84 75 31 32", "Email": "beton.pusey@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1439981, 47.6459564] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ROYE", "Adresse": "D438", "Ville": "Roye", "Code postal": "70200", "Phone": "03 84 30 21 12", "Email": "beton.roye@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.528977, 47.668858] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VILLETTE", "Adresse": "Route du Four", "Ville": "Aime la Plagne", "Code postal": "73210", "Phone": "04 79 09 78 63", "Email": "beton.villette@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.6045, 45.540889] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - DIGOIN", "Adresse": "Rue de la plaine - Z.I. des Muriers", "Ville": "Digoin", "Code postal": "71160", "Phone": "03 85 53 05 75", "Email": "beton.digoin@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.0054723, 46.4813048] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - St JEAN DE MAURIENNE", "Adresse": "Rue Sainte Claire Deville", "Ville": "Saint Jean de Maurienne", "Code postal": "73300", "Phone": "04 79 64 18 73", "Email": "beton.stjeandemaurienne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.361306099999999, 45.275895] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ETREMBIERES", "Adresse": "423 Chemin de la Balme", "Ville": "Etrembières", "Code postal": "74100", "Phone": "04 50 94 31 91", "Email": "beton.etrembieres@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1883939802646655, 46.159116] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BONNEVILLE", "Adresse": "1090 Route de Cluses", "Ville": "Bonneville", "Code postal": "74130", "Phone": "04 50 62 06 20", "Email": "beton.bonneville@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.422949399999999, 46.0713433] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - VILLAZ", "Adresse": "433 route des Grands Bois", "Ville": "Villaz", "Code postal": "74370", "Phone": "04 50 01 52 59", "Email": "beton.villaz@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.16632, 45.951745] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LAGNY SUR MARNE", "Adresse": "Rue Freycinet", "Ville": "Lagny sur Marne", "Code postal": "77400", "Phone": "01 64 30 57 89", "Email": "beton.lagnysurmarne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.6789808, 48.87611279999999] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - BONNEUIL SUR MARNE", "Adresse": "43 Route de l'Ile Saint Julien", "Ville": "Bonneuil sur Marne", "Code postal": "94380", "Phone": "01 56 71 15 50", "Email": "beton.bonneuilsurmarne@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.4854589, 48.7801859] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - GENNEVILLIERS", "Adresse": "5 route de la seine, darse n°4", "Ville": "Gennevilliers", "Code postal": "92230", "Phone": "01 47 99 15 47", "Email": "beton.gennevilliers@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.2929442705001293, 48.94441354576006] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ELOISE", "Adresse": "RN 108", "Ville": "Chêne-en-Semine", "Code postal": "74270", "Phone": "04 50 66 29 56", "Email": "beton.eloise@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.869, 46.057525] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LA GARDE", "Adresse": "720 avenue Nicolas Fabri de Peiresc", "Ville": "La Garde", "Code postal": "83130", "Phone": "06 24 34 37 52", "Email": "beton.lagarde@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.0298907, 43.1408508] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - FRÉJUS", "Adresse": "Boulevard de l'Industrie", "Ville": "Puget sur Argens", "Code postal": "83480", "Phone": "06 20 77 36 32", "Email": "beton.frejus@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.700629399227864, 43.446831190812375] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - SAINT JULIEN EN GENEVOIS", "Adresse": "Z.A. le Juge Guérin", "Ville": "Beaumont", "Code postal": "74160", "Phone": "04 50 04 48 55", "Email": "beton.stjulienengenevois@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.103803999999999, 46.102661] } },
        { "type": "Feature", "properties": { "UP": "Annecy Béton Carrière", "Adresse": "11 Rue des Terrasses", "Ville": "Cran-Gevrier", "Code postal": "74960", "Phone": "04 50 57 25 26", "Email": "beton.crangevrier@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1065358, 45.913385] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LA SEYNE SUR MER", "Adresse": "Avenue Robert BRUN", "Ville": "La Seyne sur Mer", "Code postal": "83500", "Phone": "06 24 34 37 55", "Email": "beton.laseynesurmer@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.8727718, 43.1181297] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CHAMONIX", "Adresse": "Chemin des Sablières", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 48 02", "Email": "beton.chamonix@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.814565188407869, 45.89945793091371] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - RUMILLY", "Adresse": "37 Avenue de l'Arcalod Z.I. des Pérouses", "Ville": "Rumilly", "Code postal": "74150", "Phone": "04 50 88 27 90", "Email": "beton.rumilly@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.955185294151307, 45.83912625378036] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ANNECY", "Adresse": "Route de la Foire", "Ville": "Chavanod", "Code postal": "74650", "Phone": "04 50 69 12 34", "Email": "beton.annecy@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.044829, 45.877832] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - MOISSY-CRAMAYEL", "Adresse": "ZAC d'Arvigny - 386 Rue Denis Papin", "Ville": "Moissy Cramayel", "Code postal": "77550", "Phone": "01 64 13 37 10", "Email": "beton.moissycramayel@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.581058, 48.614441] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LIMOGES SUD", "Adresse": "Z.I. du Ponteix Secteur Laugerie", "Ville": "Limoges", "Code postal": "87000", "Phone": "05 55 30 32 88", "Email": "beton.limogessud@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [1.292353, 45.806333] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LES PAVILLONS SOUS BOIS", "Adresse": "Allée Dublin - Z.I. de la Poudrette", "Ville": "Les Pavillons sous Bois", "Code postal": "93320", "Phone": "01 48 02 19 58", "Email": "beton.pavillonssousbois@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [2.502094722222222, 48.9170364] } },
        { "type": "Feature", "properties": { "UP": "Béton Vicat - OYONNAX", "Adresse": "29 rue André Crétin", "Ville": "Oyonnax", "Code postal": "01100", "Phone": "04 74 09 87 17", "Email": "beton.oyonnax@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.650583999999999, 46.2689342] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - LA MURE", "Adresse": "ZI des Marais", "Ville": "La Mure", "Code postal": "38350", "Phone": "04 76 42 38 34", "Email": "null", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.787172926705937, 44.93176023168832] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - Saint Priest", "Adresse": "24 RUE DU LYONNAIS", "Ville": "Saint-Priest", "Code postal": "69800", "Phone": "04 78 20 07 96", "Email": "null", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.9184968, 45.6986373] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - PEH", "Adresse": "Rue de Sète", "Ville": "Saint-Fons", "Code postal": "69190", "Phone": "04 78 80 90 30", "Email": "betonpeh@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [4.842052, 45.7106] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CHAMP SUR DRAC", "Adresse": "11 Rte de Saint-Georges de Commiers", "Ville": "Champ-sur-Drac", "Code postal": "38560", "Phone": "04 76 42 38 34", "Email": "beton.champsurdrac@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [5.729025195385644, 45.08663089548912] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - CECCON BETON VOVRAY", "Adresse": "2 Rue de la Bouverie", "Ville": "Annecy", "Code postal": "74000", "Phone": "04 50 69 01 20", "Email": "annecybetonvovray@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.1169644565549115, 45.88512868501105] } },
        { "type": "Feature", "properties": { "UP": "Béton VICAT - ST MARCEL", "Adresse": "ZA La Contamine", "Ville": "St Marcel", "Code postal": "73600", "Phone": "04 50 25 58 65", "Email": "beton.stmarcel@vicat.fr", "activity": "beton" }, "geometry": { "type": "Point", "coordinates": [6.553074999999997, 45.49276709509232] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Saint-Denis-lès-Bourg", "Adresse": "365 Chemin de la Gravière", "Ville": "Saint-Denis-lès-Bourg", "Code postal": "01000", "Phone": "04 74 24 35 14", "Email": "fr-carriere.stdenis@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.173634, 46.205793] } },
        { "type": "Feature", "properties": { "UP": "Granulats VICAT - Lurcy-Lévis", "Adresse": "Le pont de l'Etau", "Ville": "Lurcy-Lévis", "Code postal": "03320", "Phone": "06 15 47 84 35", "Email": "fr-carriere.lurcy-levis@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [2.949107, 46.743098] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Nice", "Adresse": "79 boulevard Jean Luciano", "Ville": "Nice", "Code postal": "06200", "Phone": "04 93 83 26 54", "Email": "fr-carriere.nicevar@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [7.194128, 43.686908] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Valbonne", "Adresse": "Route de La Valmasque RD 35", "Ville": "Valbonne", "Code postal": "06560", "Phone": "06 08 36 33 52", "Email": "fr-carriere.valbonne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [7.051639711639382, 43.60417554125909] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Saint-Bauzile", "Adresse": "La Treille", "Ville": "Saint-Bauzile", "Code postal": "07210", "Phone": "04 75 85 93 08", "Email": "fr-carriere.loriol@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.683653, 44.677919] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Courceroy", "Adresse": "Lieu Dit Les Dizaines", "Ville": "Courceroy", "Code postal": "10400", "Phone": "03 25 39 67 15", "Email": "carriere.courceroy@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.404569, 48.47719] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat La Courbaisse", "Adresse": "226 route de Tinée", "Ville": "Tournefort", "Code postal": "06420", "Phone": "04 93 02 94 39", "Email": "fr-carriere.courbaisse@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [7.185999976686503, 43.92249799477806] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Pierrelatte", "Adresse": "Quartier Jouvette et Péroutine", "Ville": "Pierrelatte", "Code postal": "26700", "Phone": "04 75 54 45 50", "Email": "fr-carriere.pierrelatte@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.6564483, 44.3575977] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat L'Armailler", "Adresse": "1300 Route d'Aiguille", "Ville": "Bourg-lès-Valence", "Code postal": "26500", "Phone": "04 75 83 03 28", "Email": "fr-carriere.armailler@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.88937946347653, 44.97841197826239] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Carbonne", "Adresse": "31 Route de Lançon", "Ville": "Carbonne", "Code postal": "31390", "Phone": "05 61 98 40 80", "Email": "fr-carriere.carbonne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [1.2184, 43.323682] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Brignoud", "Adresse": "Isle de Gromont", "Ville": "Brignoud", "Code postal": "38190", "Phone": "04 76 08 67 88", "Email": "fr-carriere.brignoud@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.894887, 45.261333] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Niévroz", "Adresse": "Route", "Ville": "Niévroz", "Code postal": "01120", "Phone": "04 78 06 04 24", "Email": "carriere.nievroz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.068621, 45.814088] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Loriol-sur-Drôme", "Adresse": "chemin de printegarde", "Ville": "Loriol-sur-Drôme", "Code postal": "26270", "Phone": "04 75 85 93 08", "Email": "fr-carriere.loriol@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.778626, 44.769578] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Fenouillet", "Adresse": "Route de Paris", "Ville": "Fenouillet", "Code postal": "31150", "Phone": "05 61 70 57 82", "Email": "fr-carriere.fenouillet@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [1.404086, 43.68554] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Faverges", "Adresse": "Plaine de Faverges", "Ville": "Creys-Mépieu", "Code postal": "38510", "Phone": "04 74 88 50 51", "Email": "fr-carriere.faverges@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.454341, 45.768019] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Barraux", "Adresse": "90 Route Nationale 90", "Ville": "Barraux", "Code postal": "38530", "Phone": "04 76 97 31 13", "Email": "fr-carriere.barraux@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.00329972, 45.4416538] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Chapareillan", "Adresse": "RN90", "Ville": "Chapareillan", "Code postal": "38530", "Phone": "04 37 06 24 90", "Email": "fr-carriere.chaparei@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.0009215337295245, 45.4549798814878] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Pontcharra", "Adresse": "193 rue Dragueline", "Ville": "Pontcharra", "Code postal": "38530", "Phone": "04 76 97 61 64", "Email": "fr-carriere.pontcharra@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.005888, 45.435979] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Bas-en-Basset", "Adresse": "Pont rouge - RD42", "Ville": "Bas-en-Basset", "Code postal": "43210", "Phone": "04 71 66 72 07", "Email": "fr-carriere.basset@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.102603, 45.328128] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Hériménil", "Adresse": "Grande Rue", "Ville": "Hériménil", "Code postal": "54300", "Phone": "03 83 74 07 24", "Email": "fr-carriere.herimenil@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.485800569450371, 48.571572043690686] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Moncel-lès-Lunéville", "Adresse": "RN 59 - L'Embanie", "Ville": "Moncel-lès-Lunéville", "Code postal": "54300", "Phone": "03 83 74 07 24", "Email": "fr-carriere.moncel@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.543964, 48.562376] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Bathelémont", "Adresse": "Carrière Bathelémont", "Ville": "Bathelémont", "Code postal": "54370", "Phone": "03 83 74 07 24", "Email": "fr-carriere.herimenil@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.5417372, 48.69667] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Proulieu", "Adresse": "Hameau Les Montgrillettes", "Ville": "Lagnieu", "Code postal": "01150", "Phone": "04 74 61 53 37", "Email": "carriere.proulieu@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.290947, 45.863029] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Maizières", "Adresse": "Rue du fort", "Ville": "Maizières", "Code postal": "54550", "Phone": "03 83 52 79 77", "Email": "fr-carriere.maiziere@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.05975, 48.594569] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Blénod-lès-Pont-à-Mousson", "Adresse": "Sur le Chemin d'avioux", "Ville": "Blénod-lès-Pont-à-Mousson", "Code postal": "54700", "Phone": "03 83 44 07 33", "Email": "fr-carriere.blenod@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.0629904, 48.885797] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Saint-Clément", "Adresse": "Rue de la Prairie", "Ville": "Saint-Clément", "Code postal": "54950", "Phone": "03 83 74 07 24", "Email": "fr-carriere.stclement@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.590949, 48.5279] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Richemont", "Adresse": "Route de la Centrale", "Ville": "Richemont", "Code postal": "57270", "Phone": "03 83 44 07 33", "Email": "carriere.richemont@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.176313, 49.274766] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Les Martres-d'Artière", "Adresse": "Route de Vichy", "Ville": "Les Martres-d'Artière", "Code postal": "63430", "Phone": "04 73 83 70 45", "Email": "fr-carriere.lesmartres@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.264608, 45.816033] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Villeurbanne", "Adresse": "27 rue Eugène Pottier", "Ville": "Villeurbanne", "Code postal": "69100", "Phone": "04 78 80 33 48", "Email": "fr-carriere.villeurbanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.8973787, 45.7875502] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Belleville-en-Beaujolais", "Adresse": "Rue de la Baryte", "Ville": "Belleville-en-Beaujolais", "Code postal": "69220", "Phone": "04 74 66 50 00", "Email": "fr-carriere.belleville@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.75554, 46.100291] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Saint-Germain-au-Mont-d'Or", "Adresse": "Avenue Louis Armand Les Aveynières", "Ville": "Saint-Germain-au-Mont-d'Or", "Code postal": "69650", "Phone": "04 78 91 23 46", "Email": "fr-carriere.st-germain@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.804926, 45.891851] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat La Reveriaz", "Adresse": "569 boulevard Henry Bordeaux", "Ville": "Chambéry", "Code postal": "73000", "Phone": "04 79 84 48 42", "Email": "fr-carriere.reveriaz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.903123, 45.567691] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Jassans-Riottier", "Adresse": "Rue du 3 Septembre 1944", "Ville": "Jassans-Riottier", "Code postal": "01480", "Phone": "04 74 09 87 03", "Email": "fr-carriere.jassans@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.752965, 45.984453] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Gilly-sur-Isère", "Adresse": "110 route des Peupliers", "Ville": "Gilly-sur-Isère", "Code postal": "73200", "Phone": "04 79 32 43 52", "Email": "fr-carriere.gilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.359545499999999, 45.6499102] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Villarcher", "Adresse": "55 rue des Epinettes", "Ville": "La Motte-Servolex", "Code postal": "73290", "Phone": "04 79 62 29 29", "Email": "fr-carriere.villarcher@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.885571, 45.609363] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat La Chavanne", "Adresse": "207 route de la carrière", "Ville": "La Chavanne", "Code postal": "73800", "Phone": "04 79 84 32 68", "Email": "fr-carriere.lachavanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.06935, 45.49892] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Les Houches alluvionaires", "Adresse": "Route blanche sortie 28", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 56 58", "Email": "fr-carriere.clairtemps@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.81342895920136, 45.89849026697671] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Pérouges La Valbonne", "Adresse": "Route de Saint-Maurice-de-Gourdans", "Ville": "Pérouges", "Code postal": "01800", "Phone": "04 74 46 08 30", "Email": "FRshared.carrierebrun@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.179248, 45.858629] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Pont-du-Château", "Adresse": "Lieu-dit La Croze", "Ville": "Pont-du-Château", "Code postal": "63430", "Phone": "04 73 83 70 45", "Email": "fr-carriere.lesmartres@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.262366, 45.810025] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Bellecombe-en-Bauges", "Adresse": "205 chemin de la carrière", "Ville": "Bellecombe-en-Bauges", "Code postal": "73340", "Phone": "04 79 62 98 38", "Email": "fr-carriere.bellecombe@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.1093143, 45.734207] } },
        { "type": "Feature", "properties": { "UP": "Annecy Béton Carrières Cran-Gevrier", "Adresse": "14 Chemin des Grèves", "Ville": "Cran-Gevrier", "Code postal": "74960", "Phone": "04 50 01 52 54", "Email": "fr-carriere.crangevrier@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.103650119049089, 45.91123723927206] } },
        { "type": "Feature", "properties": { "UP": "Annecy Béton Carrières Planaz", "Adresse": "voie communale n°1 de la D992 à Planaz", "Ville": "Desingy", "Code postal": "74270", "Phone": "04 50 57 25 60", "Email": "fr-carriere.planaz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.867644, 46.012098] } },
        { "type": "Feature", "properties": { "UP": "Annecy Béton Carrières Rumilly", "Adresse": "37 avenue de l'Arcalod", "Ville": "Rumilly", "Code postal": "74150", "Phone": "04 50 01 00 04", "Email": "fr-carriere.rumilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.9556509, 45.8393059] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Ceyzériat", "Adresse": "1832 Les Soudanières", "Ville": "Ceyzériat", "Code postal": "01250", "Phone": "04 74 30 00 91", "Email": "fr-carriere.ceyzeriat@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.3255456, 46.19231571] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Colomiers", "Adresse": "11 Chemin de la Chasse", "Ville": "Colomiers", "Code postal": "31770", "Phone": "07 64 28 54 57", "Email": "fr-carriere.colomiers@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [1.3110313, 43.6022061] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Pérouges L'Allagnier", "Adresse": "Route de L'Allagnier", "Ville": "Pérouges", "Code postal": "01800", "Phone": "04 74 46 08 30", "Email": "carriere.perouges@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.185188, 45.854962] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Port Edouard Herriot", "Adresse": "2 Rue de Sète", "Ville": "Saint-Fons", "Code postal": "69190", "Phone": "04 72 02 10 92", "Email": "carriere.peh@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.842052, 45.7106] } },
        { "type": "Feature", "properties": { "UP": "C 2 B Chalon-sur-Saône", "Adresse": "Zone portuaire sud", "Ville": "Epervans", "Code postal": "71380", "Phone": "03 85 42 49 49", "Email": "fr-carriere.epervans@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.875538641698847, 46.75908966595778] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Saint-Jean-le-Vieux", "Adresse": "Route Bourg Hauterive", "Ville": "Saint-Jean-le-Vieux", "Code postal": "01640", "Phone": "04 74 36 98 53", "Email": "fr-carriere.stjeanlevieux@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.353286, 46.024772] } },
        { "type": "Feature", "properties": { "UP": "C 2 B Pierre-de-Bresse", "Adresse": "Route de Lays", "Ville": "Pierre-de-Bresse", "Code postal": "71270", "Phone": "03 85 76 23 34", "Email": "c2b.pdb@orange.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.251036490737899, 46.9008810573724] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Ennery", "Adresse": "BP 21", "Ville": "Ennery", "Code postal": "57365", "Phone": "03 87 73 85 96", "Email": "fr-carriere.maredemancourt@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.193816190629566, 49.24034413939231] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Ay-sur-Moselle", "Adresse": "Angle D1/RD8 Bis", "Ville": "Ay-sur-Moselle", "Code postal": "57300", "Phone": "03 87 73 85 96", "Email": "fr-carriere.velersjacques@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.198672860916141, 49.25547680103846] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Besson", "Adresse": "Bois des Landes", "Ville": "Besson", "Code postal": "03210", "Phone": "04 70 43 60 75", "Email": "fr-carriere.souvigny@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.218094057861318, 46.45692183068944] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat La Seyne-sur-Mer", "Adresse": "1527 Avenue Robert Brun", "Ville": "La Seyne-Sur-Mer", "Code postal": "83500", "Phone": "07 61 60 25 38", "Email": "fr-carriere.laseynesurmer@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.859684279067983, 43.117141553319655] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Pérouges Les Communaux", "Adresse": "Rue des communaux", "Ville": "Pérouges", "Code postal": "01800", "Phone": "04 74 46 08 30", "Email": "carriere.perouges@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.180478, 45.852145] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Souvigny", "Adresse": "Lieu-dit La Fauchère", "Ville": "Souvigny", "Code postal": "03210", "Phone": "04 70 43 60 75", "Email": "fr-carriere.souvigny@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [3.202206, 46.517385] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Les Houches roches massives", "Adresse": "Route blanche sortie 28", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 56 58", "Email": "fr-carriere.clairtemps@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.81342895920136, 45.89849026697671] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Montailleur", "Adresse": "LES COMMUNAUX", "Ville": "Montailleur", "Code postal": "73460", "Phone": "04 79 32 43 52", "Email": "fr-carriere.gilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.28196902, 45.60796989] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Laissaud Pré Couardin (K3+)", "Adresse": "PRE COUARDIN", "Ville": "Laissaud", "Code postal": "73800", "Phone": "04 79 84 32 68", "Email": "fr-carriere.lachavanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.02095404, 45.46773046] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Laissaud Les Glières", "Adresse": "LES GLIERES", "Ville": "Laissaud", "Code postal": "73800", "Phone": "04 79 84 32 68", "Email": "fr-carriere.lachavanne@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.01306016, 45.45489245] } },
        { "type": "Feature", "properties": { "UP": "Sablière de Sainte Hélène", "Adresse": "ZONE INDUSTRIELLE - BP 7", "Ville": "Sainte-Hélène-sur-Isère", "Code postal": "73460", "Phone": "04 79 32 43 52", "Email": "fr-carriere.gilly@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.29633754, 45.6105748] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Bocher", "Adresse": "BOCHER NORD", "Ville": "Les Houches", "Code postal": "74310", "Phone": "04 50 54 56 58", "Email": "fr-carriere.clairtemps@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [6.77918392, 45.90734967] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat La Salle", "Adresse": "route du Château", "Ville": "La Salle", "Code postal": "71260", "Phone": "03 85 23 86 07", "Email": "fr-carriere.lasalle@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.857418, 46.41025] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Montagny-lès-Buxy", "Adresse": "RD 977 Les Chaumes", "Ville": "Montagny-lès-Buxy", "Code postal": "71390", "Phone": "03 85 43 62 89", "Email": "fr-carriere.lesbuxy@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.671514, 46.713158] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Tournus", "Adresse": "7 quai de Saône", "Ville": "Tournus", "Code postal": "71700", "Phone": "03 85 51 07 12", "Email": "fr-carriere.tournus@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.918228796295125, 46.55459105465899] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Mâcon", "Adresse": "Rue des frères lumière", "Ville": "Mâcon", "Code postal": "71000", "Phone": "03 85 34 84 00", "Email": "fr-carriere.macon@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [4.824893, 46.284421] } },
        { "type": "Feature", "properties": { "UP": "Granulats Vicat Montagnole", "Adresse": "CARRIERE DE MONTAGNOLE", "Ville": "Montagnole", "Code postal": "73000", "Phone": "04 79 84 48 42", "Email": "fr-carriere.reveriaz@vicat.fr", "activity": "granulats" }, "geometry": { "type": "Point", "coordinates": [5.920625, 45.543914] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie de Montalieu", "Adresse": "Route des Usines", "Ville": "Montalieu-Vercieu", "Code postal": "38390", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [5.4149292, 45.8041108] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie de la Pérelle", "Adresse": "2420 Rte de Fourvoirie", "Ville": "Saint-Laurent-du-Pont", "Code postal": "38380", "activity": "ciment-prompt" }, "geometry": { "type": "Point", "coordinates": [5.739827, 45.3793544] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie de Xeuilley", "Adresse": "16 Route de Pierreville", "Ville": "Xeuilley", "Code postal": "54990", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [6.102826118469238, 48.567970275878906] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie de Créchy", "Adresse": "Rue des Andrivaux", "Ville": "Créchy", "Code postal": "03150", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [3.427324, 46.2544481] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie de Peille", "Adresse": "2693 quart Grave de, 06440 Blausasc", "Ville": "Blausasc", "Code postal": "06440", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [7.374574415562, 43.790325370506] } },
        { "type": "Feature", "properties": { "UP": "Cimenterie de Saint Egreve", "Adresse": "1 Rue du Lac", "Ville": "Saint-Egrève", "Code postal": "38120", "activity": "ciment" }, "geometry": { "type": "Point", "coordinates": [5.669908982548, 45.234425005147] } }
    ]
    }

    // Ajouter des IDs uniques aux features
    establishmentsData.features.forEach((feature, index) => {
        feature.properties.id = feature.properties.UP + '_' + index;
    });

    // Fonctions utilitaires
    function debounce(func, wait) {
        return function executedFunction(...args) {
            const later = () => { clearTimeout(debounceTimer); func(...args); };
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(later, wait);
        };
    }
    function decodeHTMLEntities(text) {
        if (typeof text !== 'string') return text;
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    function localUPGeocoder(query) {
        const matchingFeatures = [];
        const queryLower = query.toLowerCase();
        establishmentsData.features.forEach((feature) => {
            if (feature.properties.UP && feature.properties.UP.toLowerCase().includes(queryLower)) {
                const decodedUP = decodeHTMLEntities(feature.properties.UP);
                const decodedAdresse = decodeHTMLEntities(feature.properties.Adresse || '');
                const decodedVille = decodeHTMLEntities(feature.properties.Ville || '');
                const placeName = `${decodedUP}, ${decodedAdresse}, ${decodedVille}`;

                matchingFeatures.push({
                    id: `up_${feature.properties.id}`, type: 'Feature', place_type: ['place'], relevance: 0.99,
                    properties: feature.properties, text: decodedUP, place_name: placeName,
                    center: feature.geometry.coordinates, geometry: feature.geometry
                });
            }
        });
        return matchingFeatures.slice(0, 5);
    }

    // Définition des régions françaises avec leurs coordonnées approximatives
    const regions = {
        'Auvergne-Rhône-Alpes': { center: [5.7301, 45.3584], bounds: [[3.8, 44.0], [7.7, 46.8]] },
        'Bourgogne-Franche-Comté': { center: [5.0301, 47.0584], bounds: [[2.8, 46.0], [7.2, 48.5]] },
        'Nouvelle-Aquitaine': { center: [0.8301, 45.3584], bounds: [[-2.0, 42.0], [3.0, 47.0]] },
        'Occitanie': { center: [2.3301, 43.5584], bounds: [[-1.0, 42.0], [5.0, 45.0]] },
        'Grand Est': { center: [6.2301, 49.0584], bounds: [[4.0, 47.5], [8.5, 50.5]] },
        'Hauts-de-France': { center: [2.8301, 50.1584], bounds: [[1.0, 49.0], [4.5, 51.5]] },
        'Normandie': { center: [0.2301, 49.0584], bounds: [[-2.0, 48.0], [2.0, 50.0]] },
        'Île-de-France': { center: [2.3488, 48.8534], bounds: [[1.4, 48.1], [3.6, 49.2]] },
        'Centre-Val de Loire': { center: [1.8301, 47.2584], bounds: [[0.0, 46.0], [3.5, 48.5]] },
        'Pays de la Loire': { center: [-1.1699, 47.4584], bounds: [[-2.5, 46.0], [0.5, 48.5]] },
        'Bretagne': { center: [-3.1699, 48.2584], bounds: [[-5.5, 47.0], [-1.0, 49.0]] },
        'Provence-Alpes-Côte d\'Azur': { center: [6.2301, 43.9584], bounds: [[4.2, 43.0], [7.7, 45.0]] },
        'Corse': { center: [9.1301, 42.1584], bounds: [[8.5, 41.3], [9.8, 43.1]] },
        'Languedoc-Roussillon': { center: [3.8301, 43.6584], bounds: [[1.7, 42.3], [4.9, 44.9]] }
    };

    function getRegionForCoordinates(lng, lat) {
        for (const [regionName, regionData] of Object.entries(regions)) {
            const [[minLng, minLat], [maxLng, maxLat]] = regionData.bounds;
            if (lng >= minLng && lng <= maxLng && lat >= minLat && lat <= maxLat) {
                return regionName;
            }
        }
        return 'Autre région';
    }


    function calculateTravelTime(distance) {
        // Estimation basique : 50 km/h moyenne
        const hours = distance / 50;
        if (hours < 1) {
            return `${Math.round(hours * 60)} min`;
        }
        return `${Math.round(hours * 10) / 10}h`;
    }

    function addClusterLayers() {
        console.log('Ajout des couches de clustering...');
        
        // Cluster circles
        map.addLayer({
            id: 'clusters',
            type: 'circle',
            source: 'establishments',
            filter: ['has', 'point_count'],
            paint: {
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#555',     // cluster-small (gris moyen)
                    10, '#333', // cluster-medium (gris foncé)
                    50, '#222'  // cluster-large (gris très foncé)
                ],
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    17, // cluster-small (35px/2 = 17.5)
                    10, 22, // cluster-medium (45px/2 = 22.5)
                    50, 27  // cluster-large (55px/2 = 27.5)
                ],
                'circle-stroke-width': 3,
                'circle-stroke-color': '#fff'
            }
        });

        // Cluster count labels
        map.addLayer({
            id: 'cluster-count',
            type: 'symbol',
            source: 'establishments',
            filter: ['has', 'point_count'],
            layout: {
                'text-field': ['get', 'point_count_abbreviated'],
                'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                'text-size': 14
            },
            paint: {
                'text-color': '#fff'
            }
        });

        // Individual points (unclustered)
        map.addLayer({
            id: 'unclustered-point',
            type: 'symbol',
            source: 'establishments',
            filter: ['!', ['has', 'point_count']],
            layout: {
                'icon-image': [
                    'case',
                    ['==', ['get', 'activity'], 'beton'], 'beton-marker',
                    ['==', ['get', 'activity'], 'granulats'], 'granulats-marker',
                    ['==', ['get', 'activity'], 'ciment'], 'ciment-marker',
                    ['==', ['get', 'activity'], 'ciment-prompt'], 'ciment-prompt-marker',
                    'beton-marker'
                ],
                'icon-size': 1.0,   // Taille normale car images redimensionnées à 32x32
                'icon-allow-overlap': true
            }
        });
    }
    
    function loadMarkerImages(callback) {
        console.log('Chargement des vraies images des marqueurs...');
        
        const markers = {
            'beton-marker': '/sites/default/files/2024-09/point-interet-beton.png',
            'granulats-marker': '/sites/default/files/2024-09/point-interet-granulats.png',
            'ciment-marker': '/sites/default/files/2024-09/point-interet-ciment.png',
            'ciment-prompt-marker': '/sites/default/files/2024-12/ciment-prompt-naturel.png'
        };
        
        const markerIds = Object.keys(markers);
        let loadedCount = 0;
        
        const checkComplete = () => {
            loadedCount++;
            console.log(`Image ${loadedCount}/${markerIds.length} traitée`);
            if (loadedCount === markerIds.length && callback) {
                console.log('Toutes les images de marqueurs ont été chargées');
                callback();
            }
        };
        
        Object.entries(markers).forEach(([id, url]) => {
            console.log(`Chargement de ${id} depuis ${url}`);
            
            // Utiliser map.loadImage() directement (pas de problème CORS sur solutions-vicat.fr)
            map.loadImage(url, (error, image) => {
                if (error) {
                    console.error(`Erreur de chargement de l'image ${id}:`, error);
                    // Fallback avec icône SVG
                    createSVGMarkerIcon(id, getColorForMarker(id), getSymbolForMarker(id));
                } else {
                    console.log(`Image ${id} chargée avec succès (taille: ${image.data ? image.data.width + 'x' + image.data.height : 'inconnue'})`);
                    
                    // Redimensionner l'image si elle est trop grande
                    const resizedImage = resizeImageForMap(image, 32, 32);
                    
                    if (!map.hasImage(id)) {
                        map.addImage(id, resizedImage);
                        console.log(`Image ${id} redimensionnée et ajoutée à la carte`);
                    }
                }
                checkComplete();
            });
        });
    }
    
    function resizeImageForMap(image, targetWidth, targetHeight) {
        // Si l'image est déjà petite, la retourner telle quelle
        if (image.data && image.data.width <= targetWidth && image.data.height <= targetHeight) {
            return image;
        }
        
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            
            // Créer une image HTML temporaire pour le redimensionnement
            const tempImg = new Image();
            tempImg.width = image.data ? image.data.width : targetWidth;
            tempImg.height = image.data ? image.data.height : targetHeight;
            
            // Si c'est un ImageBitmap ou ImageData, nous devons convertir différemment
            if (image.data) {
                // Créer ImageData à partir des données
                const imageData = new ImageData(image.data.data, image.data.width, image.data.height);
                
                // Créer un canvas temporaire avec l'image originale
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = image.data.width;
                tempCanvas.height = image.data.height;
                tempCtx.putImageData(imageData, 0, 0);
                
                // Redimensionner sur le canvas final
                ctx.drawImage(tempCanvas, 0, 0, targetWidth, targetHeight);
            } else {
                // Pour les autres formats, essayer de dessiner directement
                ctx.drawImage(image, 0, 0, targetWidth, targetHeight);
            }
            
            // Retourner les données d'image redimensionnées
            const resizedImageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
            return resizedImageData;
            
        } catch (e) {
            console.error('Erreur lors du redimensionnement:', e);
            // Retourner l'image originale en cas d'erreur
            return image;
        }
    }
    
    function getColorForMarker(id) {
        const colors = {
            'beton-marker': '#4CAF50',
            'granulats-marker': '#FF9800',
            'ciment-marker': '#2196F3',
            'ciment-prompt-marker': '#9C27B0'
        };
        return colors[id] || '#666';
    }
    
    function getSymbolForMarker(id) {
        const symbols = {
            'beton-marker': 'B',
            'granulats-marker': 'G',
            'ciment-marker': 'C',
            'ciment-prompt-marker': 'P'
        };
        return symbols[id] || '?';
    }
    
    function createSVGMarkerIcon(id, color, symbol) {
        const size = 32;  // Même taille que les images redimensionnées
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Dessiner une icône simple et cohérente
        // Ombre légère
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath();
        ctx.ellipse(size/2 + 1, size - 2, 8, 3, 0, 0, 2 * Math.PI);
        ctx.fill();
        
        // Corps principal (cercle simple)
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(size/2, size/2, 10, 0, Math.PI * 2);
        ctx.fill();
        
        // Bordure blanche fine
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(size/2, size/2, 10, 0, Math.PI * 2);
        ctx.stroke();
        
        // Texte au centre
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(symbol, size/2, size/2);
        
        // Ajouter l'image à Mapbox
        const imageData = ctx.getImageData(0, 0, size, size);
        if (!map.hasImage(id)) {
            map.addImage(id, imageData);
            console.log(`Icône SVG fallback ${id} créée (${size}x${size})`);
        }
    }
    
    function createFallbackMarker(id) {
        // Créer un marqueur de base visible
        const size = 40;  // Taille augmentée
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Dessiner un cercle de couleur selon le type
        const colors = {
            'beton-marker': '#4CAF50',    // Vert pour béton
            'granulats-marker': '#FF9800', // Orange pour granulats
            'ciment-marker': '#2196F3',   // Bleu pour ciment
            'ciment-prompt-marker': '#9C27B0' // Violet pour ciment prompt
        };
        
        // Fond
        ctx.fillStyle = colors[id] || '#666';
        ctx.beginPath();
        ctx.arc(size/2, size/2, size/2 - 3, 0, 2 * Math.PI);
        ctx.fill();
        
        // Bordure blanche
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Ajouter une lettre pour identifier le type
        const letters = {
            'beton-marker': 'B',
            'granulats-marker': 'G',
            'ciment-marker': 'C',
            'ciment-prompt-marker': 'P'
        };
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(letters[id] || '?', size/2, size/2);
        
        const imageData = ctx.getImageData(0, 0, size, size);
        if (!map.hasImage(id)) {
            console.log(`Marqueur de base créé pour ${id}`);
            map.addImage(id, imageData);
        }
    }
    
    function createColoredMarkerForMapbox(id, color) {
        console.log(`Création d'un marqueur coloré pour ${id} avec la couleur ${color}`);
        const size = 30;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Dessiner un cercle avec la couleur spécifiée
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(size/2, size/2, size/2 - 3, 0, 2 * Math.PI);
        ctx.fill();
        
        // Bordure blanche
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        const imageData = ctx.getImageData(0, 0, size, size);
        if (!map.hasImage(id)) {
            map.addImage(id, imageData);
        }
    }
    
    function updateEstablishmentsSource(features) {
        if (map.getSource('establishments')) {
            const featureCollection = {
                type: 'FeatureCollection',
                features: features || establishmentsData.features
            };
            map.getSource('establishments').setData(featureCollection);
        }
    }
    
    function setupClusterInteractions() {
        // Click event for clusters - zoom into cluster
        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('establishments').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        });

        // Click event for individual points - show popup
        map.on('click', 'unclustered-point', (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const properties = e.features[0].properties;
            
            // Ensure that if the map is zoomed out such that multiple copies of the feature are visible, the popup appears over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            
            const popupContent = createPopupContent(properties, coordinates);
            popupContent.setLngLat(coordinates).addTo(map);
        });
        
        // Double-click event for individual points - focus on establishment
        map.on('dblclick', 'unclustered-point', (e) => {
            e.preventDefault();
            const feature = {
                geometry: e.features[0].geometry,
                properties: e.features[0].properties
            };
            focusOnEstablishment(feature);
        });

        // Change cursor to pointer when hovering over clusters or points
        map.on('mouseenter', 'clusters', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'clusters', () => {
            map.getCanvas().style.cursor = '';
        });
        
        map.on('mouseenter', 'unclustered-point', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
        });
    }


    function updateLegendCountsFromViewport() {
        console.log('updateLegendCountsFromViewport called');
        
        if (!map.isStyleLoaded() || !primaryFilteredFeatures) {
            console.log('Map not loaded or no features available');
            return;
        }

        let featuresToCount = [];
        
        // Déterminer quels établissements compter selon le mode d'affichage
        if (currentLayoutMode === 'sidebarFull') {
            // En mode sidebar complet, compter tous les établissements filtrés
            featuresToCount = [...primaryFilteredFeatures];
        } else if (currentLayoutMode === 'mapFull' || currentLayoutMode === 'dual') {
            // En mode carte, compter seulement les établissements visibles dans le viewport
            if (currentSearchCenter && primaryFilteredFeatures.length > 0) {
                // Si recherche active, compter tous les résultats filtrés
                featuresToCount = [...primaryFilteredFeatures];
            } else {
                // Sinon, compter seulement ceux visibles sur la carte
                const mapBounds = map.getBounds();
                featuresToCount = primaryFilteredFeatures.filter(feature => {
                    if (!feature.geometry || !feature.geometry.coordinates) return false;
                    return mapBounds.contains(feature.geometry.coordinates);
                });
            }
        }

        console.log('Features to count:', featuresToCount.length);

        // Compter par type d'activité
        const counts = { beton: 0, granulats: 0, ciment: 0, 'ciment-prompt': 0 };
        
        featuresToCount.forEach(feature => {
            const activity = feature.properties.activity;
            if (counts.hasOwnProperty(activity)) {
                counts[activity]++;
            }
        });

        console.log('Counts:', counts);

        // Mettre à jour les éléments de la légende
        const betonCountElement = document.getElementById('beton-count');
        const granulatsCountElement = document.getElementById('granulats-count');
        const cimentCountElement = document.getElementById('ciment-count');
        const cimentPromptCountElement = document.getElementById('ciment-prompt-count');
        
        if (betonCountElement) betonCountElement.textContent = counts.beton;
        if (granulatsCountElement) granulatsCountElement.textContent = counts.granulats;
        if (cimentCountElement) cimentCountElement.textContent = counts.ciment;
        if (cimentPromptCountElement) cimentPromptCountElement.textContent = counts['ciment-prompt'];
        
        // Afficher/masquer la légende ciment prompt si nécessaire
        const cimentPromptLegend = document.getElementById('ciment-prompt-legend');
        if (cimentPromptLegend) {
            if (counts['ciment-prompt'] > 0) {
                cimentPromptLegend.style.display = 'flex';
            } else {
                cimentPromptLegend.style.display = 'none';
            }
        }
        
        // Afficher la légende
        const mapLegend = document.getElementById('map-legend');
        if (mapLegend) {
            mapLegend.style.display = 'block';
            console.log('Legend updated with viewport counts');
        } else {
            console.error('map-legend element not found');
        }
    }

    
    function initializeMap() {
        // Préserver la légende avant de nettoyer le conteneur
        const mapContainer = document.getElementById('map');
        let legendElement = null;
        
        if (mapContainer) {
            // Sauvegarder la légende avant de nettoyer
            legendElement = mapContainer.querySelector('#map-legend');
            if (legendElement) {
                legendElement = legendElement.cloneNode(true);
            }
            
            mapContainer.innerHTML = '';
        }
        
        map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/streets-v11',
            center: [2.2137, 46.2276], zoom: 5, pitch: 0, bearing: 0
        });
        
        // Restaurer la légende après l'initialisation de Mapbox
        if (legendElement) {
            mapContainer.appendChild(legendElement);
        }
        
        map.on('load', onMapLoad);
    }

    function onMapLoad() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
      
        if (typeof MapboxLanguage !== 'undefined') {
            map.addControl(new MapboxLanguage({ defaultLanguage: 'fr' }));
        }
        map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512, 'maxzoom': 14 });
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
      
        // Add establishments source with clustering
        map.addSource('establishments', {
            type: 'geojson',
            data: establishmentsData,
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 80,
            clusterMinPoints: 3  // Minimum 3 points pour former un cluster
        });
        
        // Load marker images first, then add layers
        loadMarkerImages(() => {
            addClusterLayers();
            setupClusterInteractions();
        });
      
        initializeGeocoder();
        initializeDirections();
        updateFilterOptions();
        setupEventListeners();
        initializeLayout();
        applyFilters();
        
        // Ajouter les événements pour mise à jour temps réel de la légende
        setupMapViewportListeners();
        
        // S'assurer que la légende s'affiche (remplacement par la nouvelle fonction)
        setTimeout(() => {
            console.log('Calling updateLegendCountsFromViewport...');
            updateLegendCountsFromViewport();
        }, 500);
    }

    function setupMapViewportListeners() {
        console.log('Setting up map viewport listeners for real-time updates...');
        
        // Créer une fonction debounced pour mettre à jour la sidebar ET la légende
        const debouncedViewportUpdate = debounce(() => {
            console.log('Map viewport changed, updating sidebar and legend...');
            updateSidebarBasedOnMapViewport();
        }, 250); // Réduit légèrement le délai pour plus de réactivité
        
        // Écouter les mouvements de carte (pan)
        map.on('moveend', debouncedViewportUpdate);
        
        // Écouter les changements de zoom
        map.on('zoomend', debouncedViewportUpdate);
        
        // Écouter les changements de taille de fenêtre
        map.on('resize', debouncedViewportUpdate);
        
        console.log('Map viewport listeners setup complete (sidebar + legend)');
    }

    function initializeGeocoder() {
       geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl,
            placeholder: 'Rechercher ville ou U.P.',
            countries: 'fr', localGeocoder: localUPGeocoder, localGeocoderOnly: false, language: 'fr'
       });
       document.getElementById('geocoder-container').prepend(geocoder.onAdd(map));
       geocoder.on('result', (e) => {
            currentSearchCenter = e.result.center || e.result.geometry.coordinates;
            applyFilters();
            if (e.result.properties && e.result.properties.UP) {
                map.flyTo({ center: e.result.center, zoom: 14, pitch: 45, essential: true });
            }
       });
       geocoder.on('clear', () => {
            currentSearchCenter = null; removeSearchRadiusCircle(); applyFilters();
       });
    }

    function initializeDirections() {
        console.log('Initializing Directions service...');
        
        // Initialiser le service Mapbox Directions
        directions = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            unit: 'metric',
            profile: 'mapbox/driving',
            controls: {
                inputs: false,
                instructions: false,
                profileSwitcher: false
            },
            interactive: false,
            flyTo: false // Empêcher le zoom automatique
        });
        
        console.log('Directions service created:', directions);
        
        // Ajouter le contrôle à la carte
        map.addControl(directions, 'top-right');
        console.log('Directions control added to map');
        
        // Masquer seulement l'interface utilisateur, pas les routes
        setTimeout(() => {
            const directionsControl = document.querySelector('.mapbox-directions-component');
            if (directionsControl) {
                // Masquer seulement les inputs et contrôles, pas les routes
                const inputs = directionsControl.querySelector('.mapbox-directions-instructions');
                const inputContainer = directionsControl.querySelector('.mapbox-directions-inputs');
                
                if (inputs) inputs.style.display = 'none';
                if (inputContainer) inputContainer.style.display = 'none';
                
                console.log('Directions UI hidden');
            }
        }, 100);
    }

    function showRouteOnMap(originCoords, destinationCoords) {
        console.log('showRouteOnMap called with:', { originCoords, destinationCoords });
        
        if (!originCoords || !destinationCoords) {
            console.error('Missing coordinates:', { originCoords, destinationCoords });
            return;
        }
        
        // Nettoyer la route précédente
        clearCurrentRoute();
        
        // Approche alternative : utiliser directement l'API Directions
        showRouteWithDirectAPI(originCoords, destinationCoords);
    }
    
    async function showRouteWithDirectAPI(originCoords, destinationCoords) {
        console.log('Using direct API approach...');
        
        try {
            // Construire l'URL de l'API Directions avec les bons paramètres
            const coordinates = `${originCoords[0]},${originCoords[1]};${destinationCoords[0]},${destinationCoords[1]}`;
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordinates}?geometries=geojson&overview=full&steps=true&access_token=${mapboxgl.accessToken}`;
            
            console.log('Fetching route from:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            console.log('API Response:', data);
            
            if (data.routes && data.routes[0]) {
                const route = data.routes[0];
                
                // Ajouter la route à la carte comme source et layer
                addRouteToMap(route);
                
                // Centrer la carte sur la route
                if (route.geometry && route.geometry.coordinates) {
                    const bounds = new mapboxgl.LngLatBounds();
                    route.geometry.coordinates.forEach(coord => bounds.extend(coord));
                    map.fitBounds(bounds, { padding: 50 });
                }
                
                // Mettre à jour les temps de trajet avec les données réelles
                updateTravelTimesWithRealData(route);
                
                // Ajouter le bouton pour nettoyer le trajet
                addRouteClearButton();
                
                console.log('Route successfully added to map');
                
            } else {
                console.error('No route found in API response');
            }
            
        } catch (error) {
            console.error('Error fetching route:', error);
        }
    }
    
    function addRouteToMap(route) {
        // Supprimer la source existante si elle existe
        if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }
        
        // Ajouter la nouvelle route
        map.addSource('route', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': route.geometry
            }
        });
        
        map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#3887be',
                'line-width': 5,
                'line-opacity': 0.75
            }
        });
        
        currentRouteSource = 'route';
    }

    function clearCurrentRoute() {
        console.log('Clearing current route...');
        
        // Nettoyer la route du plugin Directions
        if (directions) {
            directions.removeRoutes();
        }
        
        // Nettoyer la route ajoutée manuellement
        if (currentRouteSource === 'route' && map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }
        
        // Supprimer le bouton de nettoyage
        const clearBtn = document.getElementById('clear-route-btn');
        if (clearBtn) {
            clearBtn.remove();
        }
        
        currentRouteSource = null;
        console.log('Route cleared');
    }

    function updateTravelTimesWithRealData(route) {
        // Vérifier que la route contient les données attendues
        if (!route || typeof route.duration === 'undefined' || typeof route.distance === 'undefined') {
            console.warn('Route data incomplete:', route);
            return;
        }
        
        // Extraire la durée réelle du trajet depuis l'API (en secondes)
        const realDurationSeconds = route.duration;
        const realDistanceMeters = route.distance;
        
        // Convertir en format lisible
        const realTravelTime = formatDuration(realDurationSeconds);
        const realDistance = (realDistanceMeters / 1000).toFixed(1); // convertir en km
        
        // Mettre à jour les badges existants avec les données réelles
        const distanceBadges = document.querySelectorAll('.distance-badge');
        if (distanceBadges) {
            distanceBadges.forEach(badge => {
                if (badge && badge.textContent && badge.textContent.includes(' km')) {
                    badge.textContent = `${realDistance} km`;
                }
            });
        }
        
        const timeBadges = document.querySelectorAll('.time-badge');
        if (timeBadges) {
            timeBadges.forEach(badge => {
                if (badge) {
                    badge.textContent = realTravelTime;
                }
            });
        }
    }

    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}min`;
        } else {
            return `${minutes} min`;
        }
    }

    function addRouteClearButton() {
        // Ajouter un bouton pour nettoyer le trajet si il n'existe pas déjà
        let clearBtn = document.getElementById('clear-route-btn');
        if (!clearBtn && currentRouteSource) {
            clearBtn = document.createElement('button');
            clearBtn.id = 'clear-route-btn';
            clearBtn.textContent = 'Nettoyer le trajet';
            clearBtn.style.cssText = 'position: fixed; top: 120px; right: 28px; z-index: 1005; padding: 8px 12px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);';
            clearBtn.addEventListener('click', () => {
                clearCurrentRoute();
                clearBtn.remove();
            });
            document.body.appendChild(clearBtn);
        }
    }
    
    function updateFilterOptions() {
        const activityOptions = new Set();
        establishmentsData.features.forEach(feature => {
            if (feature.properties.activity) activityOptions.add(feature.properties.activity);
        });
        const activitySelect = document.getElementById('activity-filter');
        activitySelect.innerHTML = '<option value="">Toutes activités</option>';
        Array.from(activityOptions).sort().forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option.charAt(0).toUpperCase() + option.slice(1);
            activitySelect.appendChild(optionElement);
        });
    }
    
    function setupEventListeners() {
        document.getElementById('activity-filter').addEventListener('change', applyFilters);
        
        const radiusSlider = document.getElementById('radius-slider');
        const radiusValue = document.getElementById('radius-value');
        radiusSlider.addEventListener('input', () => {
            radiusValue.textContent = `${radiusSlider.value} km`;
        });
        radiusSlider.addEventListener('change', debounce(() => {
            if (currentSearchCenter) { applyFilters(); }
        }, 300));

        document.getElementById('geolocate').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    currentSearchCenter = [position.coords.longitude, position.coords.latitude];
                    if (geocoder) geocoder.setInput('Ma position actuelle');
                    map.flyTo({ center: currentSearchCenter, zoom: 9 });
                    applyFilters();
                }, () => { alert("Impossible d'accéder à votre position."); });
            } else { alert("La géolocalisation n'est pas supportée par votre navigateur."); }
        });

        document.getElementById('reset-map').addEventListener('click', resetMap);
        
        const modal = document.getElementById('modal');
        const closeButton = document.querySelector('.close-button');
        if (closeButton) { closeButton.addEventListener('click', () => modal.style.display = 'none'); }
        window.addEventListener('click', (event) => { if (event.target === modal) modal.style.display = 'none'; });
        window.addEventListener('resize', debounce(checkAndSetLayout, 300));
    }
    
    function applyFilters() {
        const activityFilterValue = document.getElementById('activity-filter').value;
        currentSearchRadius = parseInt(document.getElementById('radius-slider').value, 10);

        if (currentSearchCenter) {
            drawSearchRadiusCircle(currentSearchCenter, currentSearchRadius);
        }

        let featuresToDisplay = [...establishmentsData.features];
        
        // Filtrer par recherche textuelle
        featuresToDisplay = filterBySearch(featuresToDisplay);
        
        // Filtrer par distance si un centre de recherche est défini
        if (currentSearchCenter && !isNaN(currentSearchRadius) && currentSearchRadius > 0) {
            featuresToDisplay = featuresToDisplay.filter(feature => {
                if (!feature.geometry || !feature.geometry.coordinates) return false;
                const distance = getDistanceFromLatLonInKm(currentSearchCenter[1], currentSearchCenter[0], feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
                return distance <= currentSearchRadius;
            });
        }
        
        // Filtrer par activité
        if (activityFilterValue) {
            featuresToDisplay = featuresToDisplay.filter(f => f.properties.activity === activityFilterValue);
        }
        
        primaryFilteredFeatures = featuresToDisplay;
        
        // Mettre à jour la source avec les données filtrées
        updateEstablishmentsSource(featuresToDisplay);
        adjustMapView(primaryFilteredFeatures);
        // Le compteur est maintenant mis à jour dans updateSidebarCards() pour refléter les établissements visibles
    }

    function adjustMapView(features) {
        if (features.length === 1 && currentSearchCenter) {
            map.flyTo({ center: features[0].geometry.coordinates, zoom: 10, essential: true });
        } else if (features.length === 0 && currentSearchCenter) {
            map.flyTo({ center: currentSearchCenter, zoom: 9, essential: true });
        } else if (features.length > 1) {
            const bounds = new mapboxgl.LngLatBounds();
            features.forEach(feature => {
                if (feature.geometry && feature.geometry.coordinates) { bounds.extend(feature.geometry.coordinates); }
            });
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds, { padding: 70, maxZoom: 15, duration: 500 });
            }
        } else if (features.length === 0 && !currentSearchCenter) {
            map.flyTo({ center: [2.2137, 46.2276], zoom: 5, pitch: 0, bearing: 0 });
        }
        setTimeout(updateSidebarBasedOnMapViewport, 100);
    }
    
    function resetMap() {
        const activityFilter = document.getElementById('activity-filter');
        if (activityFilter) activityFilter.value = "";
        
        const radiusSlider = document.getElementById('radius-slider');
        if (radiusSlider) radiusSlider.value = 30;
        
        const radiusValue = document.getElementById('radius-value');
        if (radiusValue) radiusValue.textContent = "30 km";
        
        currentSearchCenter = null;
        currentSearchRadius = 30;
        removeSearchRadiusCircle();
        
        if (geocoder && typeof geocoder.clear === 'function') { geocoder.clear(); }
        
        checkAndSetLayout();
        map.flyTo({ center: [2.2137, 46.2276], zoom: 5, pitch: 0, bearing: 0, essential: true });
        setTimeout(applyFilters, 100);
    }

    function createMarkerElement(activity) {
      let el;
      
      // Fonction pour créer un marqueur coloré de fallback
      function createColoredMarker(color) {
        const marker = document.createElement('div');
        marker.style.width = '24px';
        marker.style.height = '24px';
        marker.style.borderRadius = '50%';
        marker.style.border = '3px solid white';
        marker.style.boxShadow = '0 2px 4px rgba(0,0,0,0.4)';
        marker.style.cursor = 'pointer';
        marker.style.backgroundColor = color;
        
        // Ajouter un effet de hover
        marker.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.2)';
          this.style.transition = 'transform 0.2s';
        });
        
        marker.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1)';
        });
        
        return marker;
      }
      
      // Essayer d'utiliser les images d'abord
      if (activity === "beton") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-beton.png';
        el.onerror = function() {
          // Si l'image ne charge pas, utiliser un marqueur coloré
          const fallback = createColoredMarker('#FF6B6B');
          this.parentNode.replaceChild(fallback, this);
        };
      } else if (activity === "granulats") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-granulats.png';
        el.onerror = function() {
          const fallback = createColoredMarker('#4ECDC4');
          this.parentNode.replaceChild(fallback, this);
        };
      } else if (activity === "ciment-prompt") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-12/ciment-prompt-naturel.png';
        el.onerror = function() {
          const fallback = createColoredMarker('#45B7D1');
          this.parentNode.replaceChild(fallback, this);
        };
      } else if (activity === "ciment") {
        el = document.createElement('img');
        el.src = 'https://www.solutions-vicat.fr/sites/default/files/2024-09/point-interet-ciment.png';
        el.onerror = function() {
          const fallback = createColoredMarker('#002060');
          this.parentNode.replaceChild(fallback, this);
        };
      } else {
        // Pour les autres activités, utiliser directement un marqueur coloré
        el = createColoredMarker('#95A5A6');
      }
      
      // Si c'est une image, définir les styles appropriés
      if (el.tagName === 'IMG') {
        el.style.width = '30px';
        el.style.height = '30px';
        el.style.cursor = 'pointer';
      }
      
      return el;
    }

    function createPopupContent(props, coordinates = null) {
        const name = decodeHTMLEntities(props.UP||'N/A');
        const address = decodeHTMLEntities(props.Adresse||'N/A');
        const city = decodeHTMLEntities(props.Ville||'');
        const postalCode = props["Code postal"]||'';
        const phone = props.Phone&&props.Phone!=="null"?props.Phone:null;
        const email = props.Email&&props.Email!=="null"?props.Email:null;
        
        let distanceInfo = '';
        if (currentSearchCenter && coordinates) {
            const distance = getDistanceFromLatLonInKm(
                currentSearchCenter[1], currentSearchCenter[0],
                coordinates[1], coordinates[0]
            );
            const travelTime = calculateTravelTime(distance);
            distanceInfo = `<p><strong>Distance:</strong> <span class="distance-badge">${distance.toFixed(1)} km</span> <span class="time-badge">${travelTime}</span></p>`;
        }
        
        // Créer le popup avec DOM uniquement (évite tous problèmes de syntaxe)
        const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '300px' });
        
        // Créer le contenu avec DOM pour éviter les problèmes de balises
        const popupDiv = document.createElement('div');
        
        // Titre
        const title = document.createElement('h3');
        title.textContent = name;
        popupDiv.appendChild(title);
        
        // Adresse
        const addressP = document.createElement('p');
        const addressStrong = document.createElement('strong');
        addressStrong.textContent = 'Adresse: ';
        addressP.appendChild(addressStrong);
        addressP.appendChild(document.createTextNode(address));
        addressP.appendChild(document.createElement('br'));
        addressP.appendChild(document.createTextNode(city + ' ' + postalCode));
        popupDiv.appendChild(addressP);
        
        // Distance (si disponible)
        if (currentSearchCenter && coordinates) {
            const distance = getDistanceFromLatLonInKm(
                currentSearchCenter[1], currentSearchCenter[0],
                coordinates[1], coordinates[0]
            );
            const travelTime = calculateTravelTime(distance);
            
            const distanceP = document.createElement('p');
            const distanceStrong = document.createElement('strong');
            distanceStrong.textContent = 'Distance: ';
            distanceP.appendChild(distanceStrong);
            
            const distanceBadge = document.createElement('span');
            distanceBadge.className = 'distance-badge';
            distanceBadge.textContent = distance.toFixed(1) + ' km';
            distanceP.appendChild(distanceBadge);
            
            const timeBadge = document.createElement('span');
            timeBadge.className = 'time-badge';
            timeBadge.textContent = travelTime;
            distanceP.appendChild(timeBadge);
            
            popupDiv.appendChild(distanceP);
        }
        
        // Téléphone
        const phoneP = document.createElement('p');
        const phoneStrong = document.createElement('strong');
        phoneStrong.textContent = 'Téléphone: ';
        phoneP.appendChild(phoneStrong);
        if (phone) {
            const phoneLink = document.createElement('a');
            phoneLink.href = 'tel:' + phone;
            phoneLink.textContent = phone;
            phoneP.appendChild(phoneLink);
        } else {
            phoneP.appendChild(document.createTextNode('Non disponible'));
        }
        popupDiv.appendChild(phoneP);
        
        // Email
        const emailP = document.createElement('p');
        const emailStrong = document.createElement('strong');
        emailStrong.textContent = 'Email: ';
        emailP.appendChild(emailStrong);
        if (email) {
            const emailLink = document.createElement('a');
            emailLink.href = 'mailto:' + email;
            emailLink.textContent = email;
            emailP.appendChild(emailLink);
        } else {
            emailP.appendChild(document.createTextNode('Non disponible'));
        }
        popupDiv.appendChild(emailP);
        
        // Bouton trajet (si applicable)
        const showRouteButton = currentSearchCenter && coordinates && 
            (currentSearchCenter[0] !== coordinates[0] || currentSearchCenter[1] !== coordinates[1]);
            
        if (showRouteButton) {
            const routeBtn = document.createElement('button');
            routeBtn.textContent = 'Voir le trajet';
            routeBtn.style.cssText = 'background-color: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; margin-top: 10px;';
            routeBtn.addEventListener('click', () => {
                showRouteOnMap(currentSearchCenter, coordinates);
            });
            popupDiv.appendChild(routeBtn);
        }
        
        // Bouton nettoyer le trajet (si un trajet est visible)
        if (currentRouteSource) {
            const clearRouteBtn = document.createElement('button');
            clearRouteBtn.textContent = 'Nettoyer le trajet';
            clearRouteBtn.style.cssText = 'background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; margin-top: 10px;';
            clearRouteBtn.addEventListener('click', () => {
                clearCurrentRoute();
            });
            popupDiv.appendChild(clearRouteBtn);
        }
        
        popup.setDOMContent(popupDiv);
        
        return popup;
    }
    
    function focusOnEstablishment(feature) {
        const coordinates = feature.geometry.coordinates;
        const previousSearchCenter = currentSearchCenter;
        
        currentSearchCenter = coordinates;
        const radiusSlider = document.getElementById('radius-slider');
        if (radiusSlider) radiusSlider.value = 30;
        
        const radiusValue = document.getElementById('radius-value');
        if (radiusValue) radiusValue.textContent = "30 km";
        drawSearchRadiusCircle(currentSearchCenter, 30);
        applyFilters();
        map.flyTo({ center: coordinates, zoom: 17, pitch: 60, bearing: 30, speed: 1.2, essential: true });
        activePopups.forEach(p => p.remove());
        activePopups.length = 0;
        const popup = createPopupContent(feature.properties, coordinates).setLngLat(coordinates).addTo(map);
        activePopups.push(popup);
        
        // Si il y avait un centre de recherche précédent, afficher le trajet automatiquement
        if (previousSearchCenter && previousSearchCenter !== coordinates) {
            setTimeout(() => {
                showRouteOnMap(previousSearchCenter, coordinates);
            }, 1000); // Délai pour laisser la carte se centrer d'abord
        }
    }
    
    function updateSidebarBasedOnMapViewport() {
        console.log('updateSidebarBasedOnMapViewport called, layout mode:', currentLayoutMode);
        
        if (!map.isStyleLoaded()||!primaryFilteredFeatures) { 
            updateSidebarCards([]); 
            return; 
        }
        
        let featuresToDisplay=[];
        
        if (currentLayoutMode==='sidebarFull') {
            // En mode sidebar complet, afficher tous les établissements filtrés
            featuresToDisplay=[...primaryFilteredFeatures];
            console.log('Sidebar full mode: showing all filtered features');
        } else if (currentLayoutMode==='mapFull') {
            // En mode carte complet, ne rien afficher dans la sidebar
            featuresToDisplay=[];
            console.log('Map full mode: hiding sidebar');
        } else {
            // En mode dual, afficher SEULEMENT les établissements visibles sur la carte
            if (primaryFilteredFeatures.length > 0) {
                const mapBounds = map.getBounds();
                featuresToDisplay = primaryFilteredFeatures.filter(feature => {
                    if (!feature.geometry||!feature.geometry.coordinates) return false;
                    return mapBounds.contains(feature.geometry.coordinates);
                });
                
                console.log(`Dual mode: showing ${featuresToDisplay.length} visible features out of ${primaryFilteredFeatures.length} filtered features`);
            }
        }
        
        updateSidebarCards(featuresToDisplay);
        
        // Synchroniser les compteurs de la légende avec le viewport
        updateLegendCountsFromViewport();
    }

    function updateSidebarCards(features) {
        const sidebar = document.getElementById('establishments-view');
        
        // Effet de transition subtil
        sidebar.style.opacity = '0.7';
        setTimeout(() => {
            sidebar.innerHTML = '';
            
            if (features.length === 0) {
                sidebar.innerHTML = '<p>Aucun établissement trouvé pour les critères sélectionnés ou dans la vue actuelle.</p>';
                updateResultsCount(0);
                sidebar.style.opacity = '1';
                return;
            }

        // Trier par distance si on a un centre de recherche
        let sortedFeatures = [...features];
        if (currentSearchCenter && sortByDistance) {
            sortedFeatures.sort((a, b) => {
                const distanceA = getDistanceFromLatLonInKm(
                    currentSearchCenter[1], currentSearchCenter[0],
                    a.geometry.coordinates[1], a.geometry.coordinates[0]
                );
                const distanceB = getDistanceFromLatLonInKm(
                    currentSearchCenter[1], currentSearchCenter[0],
                    b.geometry.coordinates[1], b.geometry.coordinates[0]
                );
                return distanceA - distanceB;
            });
        }

        sortedFeatures.forEach(feature => {
            const card = document.createElement('div');
            card.className = 'establishment-card';
            card.setAttribute('tabindex', '0');
            card.setAttribute('role', 'button');
            card.setAttribute('aria-label', `Établissement ${feature.properties.UP}`);
            
            const props = feature.properties;
            const name = decodeHTMLEntities(props.UP || 'N/A');
            const address = decodeHTMLEntities(props.Adresse || 'N/A');
            const city = decodeHTMLEntities(props.Ville || '');
            const postalCode = props["Code postal"] || '';
            const phone = props.Phone && props.Phone !== "null" ? props.Phone : null;
            const email = props.Email && props.Email !== "null" ? props.Email : null;

            // Calculer la distance et le temps de trajet
            let distanceHTML = '';
            if (currentSearchCenter) {
                const distance = getDistanceFromLatLonInKm(
                    currentSearchCenter[1], currentSearchCenter[0],
                    feature.geometry.coordinates[1], feature.geometry.coordinates[0]
                );
                const travelTime = calculateTravelTime(distance);
                distanceHTML = `<span class="distance-badge">${distance.toFixed(1)} km</span> <span class="time-badge">${travelTime}</span>`;
            }

            // Créer les éléments DOM de manière sécurisée
            
            // Titre
            const title = document.createElement('h3');
            title.textContent = name;
            if (distanceHTML) {
                // Créer les badges de distance de manière sécurisée
                title.textContent = name + ' ';
                if (currentSearchCenter) {
                    const distance = getDistanceFromLatLonInKm(
                        currentSearchCenter[1], currentSearchCenter[0],
                        feature.geometry.coordinates[1], feature.geometry.coordinates[0]
                    );
                    const travelTime = calculateTravelTime(distance);
                    
                    const distanceBadge = document.createElement('span');
                    distanceBadge.className = 'distance-badge';
                    distanceBadge.textContent = distance.toFixed(1) + ' km';
                    title.appendChild(distanceBadge);
                    
                    const timeBadge = document.createElement('span');
                    timeBadge.className = 'time-badge';
                    timeBadge.textContent = travelTime;
                    title.appendChild(timeBadge);
                }
            }
            card.appendChild(title);
            
            // Adresse
            const addressEl = document.createElement('p');
            addressEl.textContent = address + ', ' + city + ' ' + postalCode;
            card.appendChild(addressEl);
            
            // Lien "Plus d'informations"
            const moreInfoLink = document.createElement('a');
            moreInfoLink.className = 'more-info';
            moreInfoLink.href = '#';
            moreInfoLink.textContent = 'Plus d\'informations';
            moreInfoLink.setAttribute('tabindex', '0');
            // Stocker les données de manière sécurisée
            moreInfoLink.setAttribute('data-feature', encodeURIComponent(JSON.stringify(props)));
            card.appendChild(moreInfoLink);
            
            // Boutons d'action (créés avec DOM)
            const hasRouteButton = currentSearchCenter && feature.geometry && feature.geometry.coordinates;
            if (phone || email || hasRouteButton) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'card-actions';
                
                if (phone) {
                    const callBtn = document.createElement('a');
                    callBtn.href = `tel:${phone}`;
                    callBtn.className = 'action-btn call';
                    callBtn.textContent = 'Appeler';
                    callBtn.setAttribute('tabindex', '0');
                    actionsDiv.appendChild(callBtn);
                }
                
                if (email) {
                    const emailBtn = document.createElement('a');
                    emailBtn.href = `mailto:${email}`;
                    emailBtn.className = 'action-btn mail';
                    emailBtn.textContent = 'Email';
                    emailBtn.setAttribute('tabindex', '0');
                    actionsDiv.appendChild(emailBtn);
                }
                
                if (hasRouteButton) {
                    const routeBtn = document.createElement('button');
                    routeBtn.className = 'action-btn route';
                    routeBtn.textContent = 'Voir le trajet';
                    routeBtn.setAttribute('tabindex', '0');
                    routeBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        showRouteOnMap(currentSearchCenter, feature.geometry.coordinates);
                    });
                    actionsDiv.appendChild(routeBtn);
                }
                
                // Bouton nettoyer le trajet (si un trajet est visible)
                if (currentRouteSource) {
                    const clearRouteBtn = document.createElement('button');
                    clearRouteBtn.className = 'action-btn clear-route';
                    clearRouteBtn.textContent = 'Nettoyer le trajet';
                    clearRouteBtn.setAttribute('tabindex', '0');
                    clearRouteBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        clearCurrentRoute();
                    });
                    actionsDiv.appendChild(clearRouteBtn);
                }
                
                card.appendChild(actionsDiv);
            }
            
            card.addEventListener('click', () => {
                focusOnEstablishment(feature);
            });

            card.querySelectorAll('.action-btn, .more-info').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                });
            });

            sidebar.appendChild(card);
        });

        attachModalListeners();
        
        // Mettre à jour le compteur d'établissements visibles
        updateResultsCount(features.length);
        
        // Restaurer l'opacité après le rendu
        sidebar.style.opacity = '1';
        }, 50); // Délai court pour l'effet de transition
    }
    
    function updateResultsCount(visibleCount) {
        const resultsCountElement = document.getElementById('results-count');
        if (resultsCountElement) {
            let message = '';
            
            if (currentLayoutMode === 'sidebarFull') {
                // En mode sidebar complet, on affiche tous les établissements filtrés
                message = `${visibleCount} établissement(s) trouvé(s).`;
            } else if (currentLayoutMode === 'mapFull') {
                // En mode carte complet, pas de message dans la sidebar
                message = '';
            } else {
                // En mode dual, préciser "visibles" et donner le contexte
                const totalFiltered = primaryFilteredFeatures ? primaryFilteredFeatures.length : 0;
                if (visibleCount === 0) {
                    message = `Aucun établissement visible dans cette zone.`;
                    if (totalFiltered > 0) {
                        message += ` (${totalFiltered} au total - zoomez ou déplacez la carte)`;
                    }
                } else if (visibleCount === totalFiltered) {
                    message = `${visibleCount} établissement(s) trouvé(s).`;
                } else {
                    message = `${visibleCount} établissement(s) visible(s) sur ${totalFiltered} au total.`;
                }
            }
            
            resultsCountElement.textContent = message;
            console.log('Results count updated:', message);
        }
    }
    
    function attachModalListeners() {
        document.querySelectorAll('#establishments-view .more-info').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                // La propagation est déjà stoppée par un autre listener, mais on le laisse par sécurité
                event.stopPropagation();
                const modal = document.getElementById('modal');
                const modalInfo = document.getElementById('modal-info');
                try {
                    const props = JSON.parse(decodeURIComponent(this.dataset.feature));
                    const name=decodeHTMLEntities(props.UP||'N/A');
                    const address=decodeHTMLEntities(props.Adresse||'N/A');
                    const city=decodeHTMLEntities(props.Ville||'');
                    const postalCode=props["Code postal"]||'';
                    const phone=props.Phone&&props.Phone!=="null"?props.Phone:null;
                    const email=props.Email&&props.Email!=="null"?props.Email:null;
                    const activity=props.activity?props.activity.charAt(0).toUpperCase()+props.activity.slice(1):'N/A';
                    
                    // Créer le contenu de la modal avec DOM pour éviter les problèmes d'iframe
                    modalInfo.innerHTML = '';
                    
                    // Titre
                    const modalTitle = document.createElement('h3');
                    modalTitle.textContent = name;
                    modalInfo.appendChild(modalTitle);
                    
                    // Adresse
                    const addressP = document.createElement('p');
                    const addressStrong = document.createElement('strong');
                    addressStrong.textContent = 'Adresse: ';
                    addressP.appendChild(addressStrong);
                    addressP.appendChild(document.createTextNode(address));
                    addressP.appendChild(document.createElement('br'));
                    addressP.appendChild(document.createTextNode(city + ' ' + postalCode));
                    modalInfo.appendChild(addressP);
                    
                    // Téléphone
                    const phoneP = document.createElement('p');
                    const phoneStrong = document.createElement('strong');
                    phoneStrong.textContent = 'Téléphone: ';
                    phoneP.appendChild(phoneStrong);
                    if (phone) {
                        const phoneLink = document.createElement('a');
                        phoneLink.href = `tel:${phone}`;
                        phoneLink.textContent = phone;
                        phoneP.appendChild(phoneLink);
                    } else {
                        phoneP.appendChild(document.createTextNode('Non disponible'));
                    }
                    modalInfo.appendChild(phoneP);
                    
                    // Email
                    const emailP = document.createElement('p');
                    const emailStrong = document.createElement('strong');
                    emailStrong.textContent = 'Email: ';
                    emailP.appendChild(emailStrong);
                    if (email) {
                        const emailLink = document.createElement('a');
                        emailLink.href = `mailto:${email}`;
                        emailLink.textContent = email;
                        emailP.appendChild(emailLink);
                    } else {
                        emailP.appendChild(document.createTextNode('Non disponible'));
                    }
                    modalInfo.appendChild(emailP);
                    
                    // Activité
                    const activityP = document.createElement('p');
                    const activityStrong = document.createElement('strong');
                    activityStrong.textContent = 'Activité: ';
                    activityP.appendChild(activityStrong);
                    activityP.appendChild(document.createTextNode(activity));
                    modalInfo.appendChild(activityP);
                } catch (e) {
                    console.error("Erreur lors de l'analyse des données de la carte : ", e);
                    modalInfo.innerHTML = '';
                    const errorP = document.createElement('p');
                    errorP.textContent = "Impossible d'afficher les informations.";
                    modalInfo.appendChild(errorP);
                }
                modal.style.display = 'block';
            });
        });
    }

    function drawSearchRadiusCircle(center, radiusKm) {
        removeSearchRadiusCircle();
        if (!turf) return;
        try {
            const circleGeoJSON = turf.circle(center, radiusKm, { steps: 64, units: 'kilometers' });
            if (map.getSource('radius-circle-source')) {
                map.getSource('radius-circle-source').setData(circleGeoJSON);
            } else {
                map.addSource('radius-circle-source', { type: 'geojson', data: circleGeoJSON });
                map.addLayer({ id: 'radius-circle-layer', type: 'line', source: 'radius-circle-source', layout: {}, paint: { 'line-color': '#007cbf', 'line-width': 2, 'line-dasharray': [2, 2] } });
            }
        } catch (e) { console.error("Erreur lors de la création du cercle:", e); }
    }
    
    function removeSearchRadiusCircle() {
        if (map.getLayer('radius-circle-layer')) map.removeLayer('radius-circle-layer');
        if (map.getSource('radius-circle-source')) map.removeSource('radius-circle-source');
    }
    
    // Fonction simplifiée pour nettoyer les anciens marqueurs/popups si nécessaire
    function cleanupOldMarkers() {
        currentMapboxMarkers.forEach(marker => marker.remove());
        currentMapboxMarkers.length = 0;
        activePopups.forEach(popup => popup.remove());
        activePopups.length = 0;
        // Mettre à jour la légende
        setTimeout(() => updateLegendCountsFromViewport(), 100);
    }

    function initializeLayout(){
        const viewSwitcherButton=document.getElementById('view-switcher');
        viewSwitcherButton.addEventListener('click',()=>{
            if(currentLayoutMode==='sidebarFull'){ switchToMapFullScreen(); }
            else if(currentLayoutMode==='mapFull'){ switchToSidebarFullScreen(); }
        });
        checkAndSetLayout();
    }
    
    function checkAndSetLayout(){
        const isBelowThreshold=window.innerHeight<VIEW_MODE_THRESHOLD;
        const viewSwitcherButton=document.getElementById('view-switcher');
        if(isBelowThreshold){
            if(currentLayoutMode==='dual'){ switchToSidebarFullScreen(); }
            viewSwitcherButton.style.display='block';
        }else{
            if(currentLayoutMode!=='dual'){ switchToDualView(); }
            viewSwitcherButton.style.display='none';
        }
        setTimeout(()=>{if(map)map.resize();},550);
    }
    
    function switchToSidebarFullScreen(){
        const mapContainer=document.getElementById('map-container');
        const viewSwitcherButton=document.getElementById('view-switcher');
        mapContainer.className='layout-sidebar-full';
        viewSwitcherButton.textContent='Afficher Carte';
        currentLayoutMode='sidebarFull';
        setTimeout(()=>{if(map){map.resize();updateSidebarBasedOnMapViewport();}},550);
    }
    
    function switchToMapFullScreen(){
        const mapContainer=document.getElementById('map-container');
        const viewSwitcherButton=document.getElementById('view-switcher');
        mapContainer.className='layout-map-full';
        viewSwitcherButton.textContent='Afficher Liste';
        currentLayoutMode='mapFull';
        setTimeout(()=>{if(map){map.resize();updateSidebarBasedOnMapViewport();}},550);
    }
    
    function switchToDualView(){
        const mapContainer=document.getElementById('map-container');
        mapContainer.className='layout-dual';
        currentLayoutMode='dual';
        setTimeout(()=>{if(map){map.resize();updateSidebarBasedOnMapViewport();}},550);
    }

    // Démarrage de l'application
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
        initializeSearchAndFilters();
        initializeMobileToggle();
        initializeKeyboardNavigation();
    });

    function initializeSearchAndFilters() {
        const searchInput = document.getElementById('search-input');
        const searchClear = document.getElementById('search-clear');
        
        // Recherche en temps réel
        searchInput.addEventListener('input', debounce(() => {
            searchQuery = searchInput.value.trim().toLowerCase();
            searchClear.style.display = searchQuery ? 'block' : 'none';
            applyFilters();
        }, 300));
        
        // Bouton effacer recherche
        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            searchQuery = '';
            searchClear.style.display = 'none';
            applyFilters();
        });
        
        // Sauvegarder les préférences de filtre
        const activityFilter = document.getElementById('activity-filter');
        const savedActivity = localStorage.getItem('selectedActivity');
        if (savedActivity) {
            activityFilter.value = savedActivity;
        }
        
        activityFilter.addEventListener('change', () => {
            localStorage.setItem('selectedActivity', activityFilter.value);
        });
    }

    function initializeMobileToggle() {
        const mobileToggle = document.getElementById('mobile-toggle');
        const mapContainer = document.getElementById('map-container');
        
        function checkMobile() {
            if (window.innerWidth <= 768) {
                mobileToggle.style.display = 'flex';
            } else {
                mobileToggle.style.display = 'none';
            }
        }
        
        checkMobile();
        window.addEventListener('resize', checkMobile);
        
        mobileToggle.addEventListener('click', () => {
            if (currentLayoutMode === 'dual') {
                switchToMapFullScreen();
                document.getElementById('mobile-toggle-icon').setAttribute('d', 'M4 6H20M4 12H20M4 18H11');
            } else if (currentLayoutMode === 'mapFull') {
                switchToSidebarFullScreen();
                document.getElementById('mobile-toggle-icon').setAttribute('d', 'M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z');
            } else {
                switchToDualView();
                document.getElementById('mobile-toggle-icon').setAttribute('d', 'M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z');
            }
        });
    }

    function initializeKeyboardNavigation() {
        // Navigation au clavier dans la liste d'établissements
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // Fermer les popups
                activePopups.forEach(p => p.remove());
                activePopups.length = 0;
            }
        });
    }

    // Fonction pour filtrer par recherche textuelle
    function filterBySearch(features) {
        if (!searchQuery) return features;
        
        return features.filter(feature => {
            const name = feature.properties.UP?.toLowerCase() || '';
            const address = feature.properties.Adresse?.toLowerCase() || '';
            const city = feature.properties.Ville?.toLowerCase() || '';
            
            return name.includes(searchQuery) || 
                   address.includes(searchQuery) || 
                   city.includes(searchQuery);
        });
    }

</script>
</body>
</html>